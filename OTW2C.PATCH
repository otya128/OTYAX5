diff -u OTW.TXT OTW2C
--- OTW.TXT
+++ OTW2C
@@ -8,6 +8,7 @@
 VAR OTW_ENABLE_SHADOW
 VAR OTW_INIT,OTW_MOUSESP,OTW_SHADOWSP,OTW_MOVWINSP,OTW_MOVWINCOL
 VAR OTW_MOVWINNUWID
+VAR OTW_CLIPMODE
 '1:MOV
 '2:RESIZE
 VAR OTW_MOVWINFLG
@@ -129,6 +130,9 @@
 VAR OTW_DBLCLKY
 
 VAR OTW_SMOOTH_MOVE_WINDOW
+VAR WIN_SHELL$
+VAR WIN_IM$
+
 DEF OTW_WIN_INITARRAY
  PrintConsoleln "Init window..."
  VAR FM=FREEMEM
@@ -267,7 +271,7 @@
 VAR MENU_NOTIFID
 DEF OTW_MENU_INITARRAY
  PrintConsoleln "Init menu..."
- MENU_ITEMMAX=256
+ MENU_ITEMMAX=1024
  MENU_INAME$=NewArray$(MENU_ITEMMAX)
  MENU_INEXT=NewArray(MENU_ITEMMAX)
  MENU_IPREV=NewArray(MENU_ITEMMAX)
@@ -282,7 +286,7 @@
  MENU_IVAR=NewArray(MENU_ITEMMAX)
  OTW_INITLIST MENU_INEXT
  MENU_ITEMFREE=1
- MENU_MAX=64
+ MENU_MAX=256
  MENU_WIDTH=NewArray(MENU_MAX)
  MENU_HEIGHT=NewArray(MENU_MAX)
  MENU_NUWID=NewArray(MENU_MAX)
@@ -354,9 +358,6 @@
  F$=GetAbsolutePath$(F$)
  GetFileType F$ OUT TYPE$,E
  IF E THEN RETURN E
- IF TYPE$=="/"THEN
-  
- ENDIF
  VAR EXT$=GetFileExtension$(F$)
  VAR PRG$=GetAssociatedProgram$(TYPE$,EXT$)
  VAR PRC
@@ -599,6 +600,7 @@
  IM_IDCNT=1
  OTW_INITLIST IM_NEXT
  IM_FREE=1
+ SetKeyboardMode TRUE
 END
 VAR IM_NOALLOC
 VAR IM_INVALIDID
@@ -680,6 +682,10 @@
  NEXT
  RETURN 0
 END
+VAR IM_KBDMODE
+COMMON DEF SetKeyboardMode FLG
+ IM_KBDMODE=FLG
+END
 VAR WIN_NOALLOC
 VAR WIN_INVALIDID
 VAR WIN_EVENTERR
@@ -1535,7 +1541,7 @@
    SPSCALE SP2,WIN_WIDTH[NUWID]+1,WIN_HEIGHT[NUWID]+1
    SPCOLOR SP2,RGB(128,063,063,063)
    SPOFS SP2,3,3,1
-   SPSHOW SP2
+   SPHIDE SP2
    SPVAR SP2,0,WND
   ENDIF
   WIN_SP[NUWID]=SP OR 512
@@ -3029,12 +3035,43 @@
  GFILL AX,AY,AX+W,AY+H,0
  RETURN 0
 END
+DEF GEndWindowSU(WND)
+ VAR NUWID=WND AND NUWIDMASK
+ WIN_BEGIN[NUWID]=FALSE
+ VAR MAP_SY=240
+ VAR MAP_SX
+ VAR AX=WIN_RX[NUWID]
+ VAR AY=WIN_RY[NUWID]
+ VAR W=WIN_AW[NUWID]
+ VAR H=WIN_AH[NUWID]
+ IF WIN_BEGIN[NUWID]!=2THEN
+  AX=WIN_RFX[NUWID]
+  AY=WIN_RFY[NUWID]
+  W=WIN_AFW[NUWID]
+  H=WIN_AFH[NUWID]
+ ENDIF
+ DIM BUFGRP[(W+1)*(H+1)]
+ DIM BUFMAP[(W+1)*(H+1)]
+ GSAVE AX,AY,W+1,H+1,BUFGRP,1
+ GPAGE OTW_SP,OTW_DP
+ GSAVE MAP_SX+AX,MAP_SY+AY,W+1,H+1,BUFMAP,1
+ ARYOP #AOPSUB,BUFMAP,BUFMAP,NUWID-1
+ ARYOP #AOPCLP,BUFMAP,BUFMAP,0,2'2=>ぐうすう=>とうめい
+ ARYOP #AOPMUL,BUFGRP,BUFGRP,BUFMAP
+ GLOAD AX,AY,W+1,H+1,BUFGRP,1,0
+ IF WIN_SP[NUWID]AND 512THEN OTW_SPCHR NUWID
+ IF MAINCNT-OTW_LASTUPD>5THEN UpdateMouse
+ RETURN 0
+END
 COMMON DEF GEndWindow(WND)
  GB_WND=0
  IF!CheckWindow(WND)THEN RETURN WIN_INVALIDID
  VAR NUWID=WND AND NUWIDMASK
  IF WIN_HIDE[NUWID]THEN RETURN WIN_NODRAW
  IF!WIN_BEGIN[NUWID]THEN RETURN WIN_EVENTERR
+ IF OTW_CLIPMODE THEN
+  RETURN GEndWindowSU(WND)
+ ENDIF
  'ごうせい
  WIN_PARENT[0]=0
  WIN_NEXT[0]=0
@@ -3095,6 +3132,9 @@
   VAR SP2=SPVAR(SP,1)
   IF SP2!=-1THEN
    SPSCALE SP2,WIN_WIDTH[NUWID],WIN_HEIGHT[NUWID]
+   IF!WIN_HIDE[NUWID]THEN
+    SPSHOW SP2
+   ENDIF
   ENDIF
  ENDIF
  SPSCALE SP,1,1
@@ -4785,12 +4825,14 @@
 COMMON DEF I_OTW
  IF!OTW_INIT THEN
 ' KEY 1,"KEY OFF"
-  OTW_EXITFLG=0
-  OTW_ENABLE_SHADOW=1
+  OTW_EXITFLG=FALSE
+  OTW_ENABLE_SHADOW=TRUE
   WIN_BKGND=RGB(208,208,208)
   WIN_BTNBACK=RGB(192,192,192)
   WIN_SELCOL=RGB(0,0,255)
   WIN_SELTXTCOL=RGB(255,255,255)
+  'sound unit
+  OTW_CLIPMODE=0
   VAR FM=FREEMEM
   PrintConsole "=================="+LF$()
   PrintConsole "OTYA WINDOW SYSTEM"+LF$()
@@ -4947,9 +4989,15 @@
   SPCOLOR OTW_MOVWINSP,OTW_MOVWINCOL
   CLS
   LOCATE 0,29
-' NewProcess"LAUNCHER","" OUT E,E
-  NewProcess"RIM","" OUT E,E
-  NewProcess"ODE","" OUT E,E
+  WIN_IM$="RIM"
+  WIN_SHELL$="ODE"
+  IF!LEN(WIN_IM$)THEN
+   WIN_IM$="DEFIM"
+  ENDIF
+  NewProcess WIN_IM$,"" OUT E,E
+  IF LEN(WIN_SHELL$)THEN
+   NewProcess WIN_SHELL$,"" OUT E,E
+  ENDIF
   BREPEAT 0,15,4
   BREPEAT 1,15,4
   BREPEAT 2,15,4
@@ -5540,6 +5588,9 @@
 END
 DEF UpdateButton()
  VAR B=BUTTON()
+ IF!IM_KBDMODE THEN
+  B=B AND NOT(#L OR #R)
+ ENDIF
  VAR RET=0
  IF B AND OTW_MOUSELBTN THEN
   IF!OTW_OLDLMOUSE THEN RET=OTW_LMOUSEDWN
@@ -7097,6 +7148,22 @@
 VAR OTYDOC_BEG$
 VAR OTYDOC_END$
 VAR OTYDOC_MENU
+VAR OTYDOC_FILE_LINESTYLE
+VAR OTYDOC_FILE_CONTENT
+VAR OTYDOC_FILE_LINEDATA
+VAR OTYDOC_FILE_INDENT
+VAR OTYDOC_FILE_TABLE
+VAR OTYDOC_FILE_NEWROW
+VAR OTYDOC_FILE_NEWCOL
+VAR OTYDOC_FILE_TABLEEND
+'line size
+DIM OTYDOC_WIDTH[0]
+DIM OTYDOC_HEIGHT[0]
+'scroll
+DIM OTYDOC_YOFFSET[0]
+
+DIM OTYDOC_WND[0]
+
 COMMON DEF INIT_OTYDOC
  VAR E
  IF!OTYDOCCTL THEN
@@ -7124,6 +7191,8 @@
   OTYDOC_INDENT=NewArray(OTYDOC_LINESIZ)
   OTYDOC_TABLEDATA=NewArray(OTYDOC_LINESIZ)
   OTYDOC_TABLEPARENT=NewArray(OTYDOC_LINESIZ)
+  OTYDOC_WIDTH=NewArray(OTYDOC_LINESIZ)
+  OTYDOC_HEIGHT=NewArray(OTYDOC_LINESIZ)
   OTYDOC_TABLEARY_COL=0
   OTYDOC_TABLEARY_ROW=1
   OTYDOC_TABLEARY_LINE=2
@@ -7184,10 +7253,20 @@
   OTYDOC_SEL2COL=NewArray(OTYDOC_WSIZ)
   OTYDOC_ISSEL=NewArray(OTYDOC_WSIZ)
   OTYDOC_SELREVERSE=NewArray(OTYDOC_WSIZ)
+  OTYDOC_YOFFSET=NewArray(OTYDOC_WSIZ)
+  OTYDOC_WND=NewArray(OTYDOC_WSIZ)
   OTYDOC_WFREE=1
   FOR I=1TO OTYDOC_WSIZ-2
    OTYDOC_WNEXT[I]=I+1
   NEXT
+  OTYDOC_FILE_LINESTYLE=1
+  OTYDOC_FILE_CONTENT=2
+  OTYDOC_FILE_LINEDATA=3
+  OTYDOC_FILE_INDENT=4
+  OTYDOC_FILE_TABLE=5
+  OTYDOC_FILE_NEWROW=6
+  OTYDOC_FILE_NEWCOL=7
+  OTYDOC_FILE_TABLEEND=8
   NewMenu OUT OTYDOC_MENU,E
   AddMenuItem OTYDOC_MENU,"Copy",1
   AddMenuItem OTYDOC_MENU,"Cut",2
@@ -7229,8 +7308,28 @@
  OTYDOC_SIZE[R]=8
  RETURN R
 END
+DEF OTYDOC_DeleteTable(L)
+ IF!OTYDOC_TABLEDATA[L]THEN RETURN
+ IF 0THEN DIM A[0]
+ A=GetSBArray(OTYDOC_TABLEDATA[L])
+ VAR ROW=A[OTYDOC_TABLEARY_ROW]
+ VAR COL=A[OTYDOC_TABLEARY_COL]
+ VAR R,C,_
+ VAR H=OTYDOC_TABLEARY_HEAD+ROW+COL
+ FOR C=0TO COL-1
+  FOR R=0TO ROW-1
+   VAR LINE=A[H+R*COL*OTYDOC_TBLELM+C*OTYDOC_TBLELM]
+   VAR ERR=OTYDOC_DeleteLine(LINE)
+  NEXT
+ NEXT
+ FreeSBArray OTYDOC_TABLEDATA[L]
+ OTYDOC_TABLEDATA[L]=0
+END
 DEF OTYDOC_DeleteLine(L)
  IF!L THEN RETURN 0
+ IF OTYDOC_TABLEDATA[L]THEN
+  'TODO:delete table
+ ENDIF
  VAR N=OTYDOC_NEXT[L]
  VAR P=OTYDOC_PREV[L]
  IF N THEN
@@ -7249,6 +7348,7 @@
  VAR R=OTYDOC_WFREE
  OTYDOC_WFREE=OTYDOC_WNEXT[OTYDOC_WFREE]
  OTYDOC_SetData WND,R
+ OTYDOC_WND[R]=WND
 END
 DEF OTYDOC_DeleteCTL WND
  VAR L=OTYDOC_GetData(WND)
@@ -7346,6 +7446,23 @@
  OTYDOC_ShowLine[D]=S
  OTYDOC_CurLine[D]=S
 END
+DEF OTYDOC_CalcDocumentSize WND
+ VAR D=OTYDOC_GetData(WND)
+ VAR LINE=OTYDOC_ShowLine[D]
+ VAR W=OTYDOC_GetWidth(WND)
+
+ VAR HEIGHT
+ WHILE LINE
+  VAR N=OTYDOC_NEXT[LINE]
+  VAR MINW,MAXW,LINEH
+  OTYDOC_CalcSize LINE,W,N OUT MINW,MAXW,LINEH
+  OTYDOC_HEIGHT[LINE]=LINEH
+  HEIGHT=HEIGHT+LINEH
+  LINE=N
+ WEND
+ VAR SCRBAR=OTYDOC_SCRBAR[D]
+ SetScrollBarSize SCRBAR,HEIGHT
+END
 COMMON DEF OTYDocResize WND,C,T,A1,WH
  VAR W,H
  SplitInt WH OUT W,H
@@ -7356,6 +7473,7 @@
  VAR D=OTYDOC_GetData(WND)
  VAR LINE=OTYDOC_ShowLine[D]
  W=OTYDOC_GetWidth(WND)
+ VAR HEIGHT
  IF 0THEN DIM A[0]
  WHILE LINE
   IF OTYDOC_TABLEDATA[LINE]THEN
@@ -7363,8 +7481,16 @@
    OTYDOC_UpdateTable2 A,W
    OTYDOC_UpdateChildrenTable A
   ENDIF
-  LINE=OTYDOC_NEXT[LINE]
+  VAR MINW,MAXW,LINEH
+  VAR N=OTYDOC_NEXT[LINE]
+  OTYDOC_CalcSize LINE,W,N OUT MINW,MAXW,LINEH
+  OTYDOC_HEIGHT[LINE]=LINEH
+  HEIGHT=HEIGHT+LINEH
+  LINE=N
  WEND
+ VAR SCRBAR=OTYDOC_SCRBAR[D]
+ SetScrollBarSize SCRBAR,HEIGHT
+ RETURN
  LINE=OTYDOC_PREV[LINE]
  WHILE LINE
   IF OTYDOC_TABLEDATA[LINE]THEN
@@ -7381,7 +7507,7 @@
 DEF OTYDOCRepaint WND
  OTYDOCRepaintSEL WND',FALSE,0,0
 END
-DEF OTYDOC_CalcSize I,MAX OUT MINW,MAXW,H
+DEF OTYDOC_CalcSize I,MAX,EI OUT MINW,MAXW,H
  MINW=0
  MAXW=0
  H=0
@@ -7391,7 +7517,7 @@
  VAR A
  VAR OL
  VAR SL=I
- WHILE I
+ WHILE I!=EI
   VAR J
   VAR V$=OTYDOC_VAL$[I]
   VAR YSZ=OTYDOC_SIZE[I],L=LEN(V$)-1
@@ -7491,7 +7617,7 @@
   FOR R=0TO ROW-1
    VAR LINE=A[H+R*COL*OTYDOC_TBLELM+C*OTYDOC_TBLELM]
    VAR H2
-   OTYDOC_CalcSize LINE,&H7FFFFFFF OUT MINW,MW,H2
+   OTYDOC_CalcSize LINE,&H7FFFFFFF,0 OUT MINW,MW,H2
    MAXW=MAX(MAXW,MW+4)
    A[OTYDOC_TABLEARY_HEAD+R]=MAX(A[OTYDOC_TABLEARY_HEAD+R],H2+2)
   NEXT
@@ -7512,7 +7638,7 @@
   FOR R=0TO ROW-1
    VAR LINE=A[H+R*COL*OTYDOC_TBLELM+C*OTYDOC_TBLELM]
    VAR H2
-   OTYDOC_CalcSize LINE,MAX OUT MINW,MW,H2
+   OTYDOC_CalcSize LINE,MAX,0 OUT MINW,MW,H2
    MAXW=MAX(MAXW,MINW+4)
    MAXW2=MAX(MAXW2,MW+4)
    H3[R]=MAX(H3[R],H2+4)
@@ -7540,7 +7666,7 @@
   FOR R=0TO ROW-1
    VAR LINE=A[H+R*COL*OTYDOC_TBLELM+C*OTYDOC_TBLELM]
    VAR H2
-   OTYDOC_CalcSize LINE,&H7FFFFFFF OUT MINW,MW,H2
+   OTYDOC_CalcSize LINE,&H7FFFFFFF,0 OUT MINW,MW,H2
    MAXWS[C]=MAX(MAXWS[C],MW+6)
    MINWS[C]=MAX(MINWS[C],MINW+6)
    A[OTYDOC_TABLEARY_HEAD+R]=MAX(A[OTYDOC_TABLEARY_HEAD+R],H2+4)
@@ -7572,7 +7698,7 @@
   A[OTYDOC_TABLEARY_HEAD+ROW+C]=MINWS[C]
   FOR R=0TO ROW-1
    LINE=A[H+R*COL*OTYDOC_TBLELM+C*OTYDOC_TBLELM]
-   OTYDOC_CalcSize LINE,MINWS[C]-2 OUT MINW,MW,H2
+   OTYDOC_CalcSize LINE,MINWS[C]-2,0 OUT MINW,MW,H2
    A[OTYDOC_TABLEARY_HEAD+R]=MAX(A[OTYDOC_TABLEARY_HEAD+R],H2+4)
   NEXT
  NEXT
@@ -7652,7 +7778,7 @@
  R=-1
  C=-1
 END
-DEF OTYDOC_RenderTable D,I,X,Y,WIDTH,HEIGHT OUT Y2
+DEF OTYDOCRenderTable D,I,X,Y,WIDTH,HEIGHT,SELFLG OUT Y2
  VAR TD=OTYDOC_TABLEDATA[I]
  Y2=Y
  IF!TD THEN RETURN
@@ -7671,15 +7797,30 @@
   IF OTYDOC_SEL1TABLE[D]==TD THEN
    SELR=OTYDOC_SEL1ROW[D]
    SELC=OTYDOC_SEL1COL[D]
+  ELSEIF SELFLG THEN
+   SELR=0
+   SELC=0
   ENDIF
   IF OTYDOC_SEL2TABLE[D]==TD THEN
    SELR2=OTYDOC_SEL2ROW[D]
    SELC2=OTYDOC_SEL2COL[D]
   ENDIF
-  IF SELC2<SELC||SELR2<SELR THEN
-   SWAP SELR2,SELR
+'  IF SELC2<SELC||SELR2<SELR THEN
+'   SWAP SELR2,SELR
+'   SWAP SELC2,SELC
+'  ENDIF
+  IF SELC2<SELC THEN
    SWAP SELC2,SELC
   ENDIF
+  IF SELR2<SELR THEN
+   SWAP SELR2,SELR
+  ENDIF
+  IF SELR2==SELR&&SELC2==SELC THEN
+   SELR=&H7FFFFFFF
+   SELR2=&H7FFFFFFF
+   SELC=&H7FFFFFFF
+   SELC2=&H7FFFFFFF
+  ENDIF
   VAR SC=GetSelectionColor()
  ENDIF
  FOR C=0TO COL-1
@@ -7707,7 +7848,10 @@
  VAR D=OTYDOC_GetData(WND)
  RETURN GetWindowWidth(WND)-GetWindowWidth(OTYDOC_SCRBAR[D])-1
 END
-'CONTAINS STARTSELECTION
+DEF OTYDOC_GetHeight(WND)
+ VAR D=OTYDOC_GetData(WND)
+ RETURN GetWindowHeight(WND)-2'border
+END'CONTAINS STARTSELECTION
 'CONTAINS ENDSELECTION
 DEF OTYDOCRepaintSEL WND',SEL_FLG',SX,SY
  IF GBeginDirect(WND)THEN RETURN
@@ -7720,7 +7864,8 @@
  VAR SL=OTYDOC_ShowLine[D]
  GCLS RGB(255,255,255)
  VAR _
- OTYDOCRender 2,2,D,SL,W,H OUT OTYDOC_LastShowLine[D],_,_
+ 
+ OTYDOCRender 2,2-OTYDOC_YOFFSET[D],D,SL,W,4+H+OTYDOC_YOFFSET[D] OUT OTYDOC_LastShowLine[D],_,_
  GBOX 0,0,W,H,RGB(0,0,0)
  VAR E=GCopyDirect(WND,0,0,W,H,0,0,1)
  E=GEndWindow(WND)
@@ -7738,8 +7883,10 @@
  VAR COL=RGB(0,0,0)
  VAR OJ
  VAR ACX=-100,ACY=-100
- VAR CURSORX,CURSORY
- VAR ISSEL=OTYDOC_ISSEL[D]
+ VAR CURSORX=&H7FFFFFFF,CURSORY
+ VAR ISTBL=!OTYDOC_SEL1TABLE[D]||(OTYDOC_SEL1COL[D]==OTYDOC_SEL2COL[D]&&OTYDOC_SEL1ROW[D]==OTYDOC_SEL2ROW[D])
+ VAR CURSHOW=!OTYDOC_ISSEL[D]||ISTBL
+ VAR ISSEL=OTYDOC_ISSEL[D]&&ISTBL
  IF ISSEL THEN
   VAR HASSEL1=OTYDOC_HASSTARTSEL[D]
   VAR HASSEL2=OTYDOC_HASENDSEL[D]
@@ -7761,6 +7908,8 @@
  VAR SELFRGND=GetSelectionTextColor()
  VAR OL=0
  VAR SX=X
+ VAR OH=GetScrollBarSize(OTYDOC_SCRBAR[D])
+ VAR ISROOT=!OTYDOC_TABLEPARENT[SL]
  WHILE I
   VAR YSZ=OTYDOC_SIZE[I]
 '?"YSZ",YSZ
@@ -7772,7 +7921,21 @@
   SZ=8
   X=SX+OTYDOC_INDENT[I]
   
+  VAR HEIGHT_OY=Y
   VAR LINED=OTYDOC_LINEDATA[I]
+  IF ISSEL THEN
+   IF I==SEL1 THEN
+    VAR SELSX=SEL1X
+    IF SEL1==SEL2 THEN
+     VAR SELEX=SEL2X
+    ELSE
+     SELEX=&H7FFDDDDF
+    ENDIF
+   ELSEIF I==SEL2 THEN
+    SELSX=0
+    SELEX=SEL2X
+   ENDIF
+  ENDIF
   IF LINED==OTYDOC_UORDLIST THEN
    VAR Y8=(YSZ DIV 8)
    GFILL X+Y8,Y+2*Y8,X+3*Y8,Y+4*Y8,#BLACK
@@ -7809,30 +7972,19 @@
    GFILL X-2*Y8,Y+YSZ-2*Y8,X-Y8-1,Y+YSZ-Y8-1,#BLACK
   ELSEIF LINED==OTYDOC_TABLE THEN
    OL=0
-   OTYDOC_RenderTable D,I,X,Y,W,H OUT Y
+   OTYDOCRenderTable D,I,X,Y,W,H,ISSEL&&SELSX<=0&&SELEX>0 OUT Y
+   IF!ISSEL&&OTYDOC_SEL1TABLE[D]==OTYDOC_TABLEDATA[I]THEN ISSEL=TRUE
+   IF ISSEL&&OTYDOC_SEL2TABLE[D]==OTYDOC_TABLEDATA[I]THEN ISSEL=FALSE
    GOTO @C
   ELSE
    OL=0
   ENDIF
-  IF ISSEL THEN
-   IF I==SEL1 THEN
-    VAR SELSX=SEL1X
-    IF SEL1==SEL2 THEN
-     VAR SELEX=SEL2X
-    ELSE
-     SELEX=&H7FFDDDDF
-    ENDIF
-   ELSEIF I==SEL2 THEN
-    SELSX=0
-    SELEX=SEL2X
-   ENDIF
-  ENDIF
   FOR J=0TO L
    C=ASC(V$[J])
    IF C==&Hb10cTHEN CONTINUE
    IF C==&Hb10bTHEN
    IF I==CL THEN
-    IF CX==J THEN
+    IF CURSHOW&&CX==J THEN
      GFILL X,Y+YSZ-SZ,X+1,Y+YSZ-1,RGB(0,0,0)
      OTYDOC_STYLE[D]=ST
      OTYDOC_COL[D]=RGBToShort(COL)
@@ -7884,7 +8036,7 @@
     RICHTEXT X,Y+YSZ-SZ,C,ST,SZ,COL
    ENDIF
    IF I==CL THEN
-    IF CX==J THEN
+    IF CURSHOW&&CX==J THEN
      GFILL X,Y+YSZ-SZ,X+1,Y+YSZ-1,RGB(0,0,0)
      CURSORX=X
      CURSORY=Y+YSZ-SZ
@@ -7896,20 +8048,11 @@
 '   ?HEX$(COL)
    INC X,TW
   NEXT
-  W2=MAX(W2,X-SX)
-  IF ISSEL THEN
-   IF I==SEL1 THEN
-    SELSX=0
-    IF SEL1==SEL2 THEN
-     ISSEL=FALSE
-    ELSE
-     SELEX=&H7FFDDDDF
-    ENDIF
-   ELSEIF I==SEL2 THEN
-    ISSEL=FALSE
-   ENDIF
+  IF ISSEL&&SX==X&&SELEX>0 THEN
+   GFILL X,Y,X,Y+YSZ-1,SELBKGND
   ENDIF
-  IF I==CL&&CX>L THEN
+  W2=MAX(W2,X-SX)
+  IF I==CL&&CX>L&&CURSHOW THEN
    GFILL X,Y+YSZ-SZ,X+1,Y+YSZ-1,RGB(0,0,0)
    CURSORX=X
    CURSORY=Y+YSZ-SZ
@@ -7920,44 +8063,65 @@
   ENDIF
   IF LINESTYLE==OTYDOC_CENTER THEN
    'CENTER
-   VAR CENT=(W-2-X)DIV 2
+   VAR CENT=SX+(W-2-X-SX)DIV 2
    IF CURSORY>=Y&&CURSORY<=Y+YSZ THEN
     CURSORX=CURSORX+CENT-1
    ENDIF
-   GCOPY 1,Y,X+1,Y+YSZ,CENT,Y,0
+   GCOPY SX,Y,X+1,Y+YSZ,CENT,Y,0
    IF CENT>1 THEN
-    GFILL 1,Y,CENT-1,Y+YSZ,-1
+    GFILL SX,Y,CENT-1,Y+YSZ,-1
    ENDIF
   ENDIF
   IF LINESTYLE==OTYDOC_RIGHT THEN
    'RIGHT
-   VAR MOVE=(W-2-X)
+   VAR MOVE=SX+(W-2-X-SX)
    IF CURSORY>=Y&&CURSORY<=Y+YSZ THEN
     CURSORX=CURSORX+MOVE-1
    ENDIF
-   GCOPY 1,Y,X+1,Y+YSZ,MOVE,Y,0
+   GCOPY SX,Y,X+1,Y+YSZ,MOVE,Y,0
    IF MOVE>1 THEN
-    GFILL 1,Y,MOVE-1,Y+YSZ,-1
+    GFILL SX,Y,MOVE-1,Y+YSZ,-1
    ENDIF
   ENDIF
   INC Y,YSZ
   @C
+  OH=OH-OTYDOC_HEIGHT[I]
+  OTYDOC_HEIGHT[I]=Y-HEIGHT_OY+1
+  OH=OH+OTYDOC_HEIGHT[I]
+  IF ISSEL THEN
+   IF I==SEL1 THEN
+    SELSX=0
+    IF SEL1==SEL2 THEN
+     ISSEL=FALSE
+    ELSE
+     SELEX=&H7FFDDDDF
+    ENDIF
+   ELSEIF I==SEL2 THEN
+    ISSEL=FALSE
+   ENDIF
+  ENDIF
   IF Y+YSZ>=H THEN BREAK
   I=OTYDOC_NEXT[I]
  WEND
+ IF GetScrollBarSize(OTYDOC_SCRBAR[D])!=OH THEN
+  SetScrollBarSize OTYDOC_SCRBAR[D],OH
+ ENDIF
  H2=Y-SY
  LAST=I
-' VOID SetWindowCursor(WND,CURSORX,CURSORY)
+ IF CURSORX!=&H7FFFFFFF THEN
+  VOID SetWindowCursor(OTYDOC_WND[D],CURSORX,CURSORY)
+ ENDIF
 END
 COMMON DEF OTYDocChFocus WND,CTL,TYPE,A1,A2
 END
 DEF OTYDOC_CLK WND,MX,MY OUT LINE,POS
  VAR W=GetWindowWidth(WND)-8
- VAR H=GetWindowHeight(WND)
  VAR D=OTYDOC_GetData(WND)
  IF!D THEN
   RETURN
  ENDIF
+ VAR H=GetWindowHeight(WND)+OTYDOC_YOFFSET[D]
+ MY=MY+OTYDOC_YOFFSET[D]
  VAR I=OTYDOC_ShowLine[D]
  OTYDOC_CLKWH I,W-2,H-2,MX-2,MY-2 OUT LINE,POS
 END
@@ -8004,9 +8168,9 @@
     ENDIF
     RETURN
    ENDIF
-   Y=Y+H2+2
+   Y=Y+H2
   NEXT
-  X=X+CELLW+2
+  X=X+CELLW
  NEXT
 END
 DEF OTYDOC_CLKWH I,W,H,MX,MY OUT LINE,POS
@@ -8206,13 +8370,19 @@
  VAR LINE,POS
  VAR PAINTF
  IF Y>GetWindowHeight(WND)THEN
-  OTYDOC_Scroll D,1
-  OTYDOC_ScrollContent D,1
+  OTYDOC_UpdateScrollBarAndScrollContentDot D,OTYDOC_HEIGHT[OTYDOC_NEXT[OTYDOC_CurLine[D]]]
+' OTYDOC_Scroll D,1
+' OTYDOC_ScrollContent D,1
   PAINTF=TRUE
   VOID RepaintWindow(WND)
  ELSEIF Y<0THEN
-  OTYDOC_Scroll D,-1
-  OTYDOC_ScrollContent D,-1
+    IF OTYDOC_YOFFSET[D]THEN
+     OTYDOC_UpdateScrollBarAndScrollContentDot D,-OTYDOC_YOFFSET[D]
+    ELSE
+     OTYDOC_UpdateScrollBarAndScrollContentDot D,-OTYDOC_HEIGHT[OTYDOC_PREV[OTYDOC_CurLine[D]]]
+    ENDIF
+'  OTYDOC_Scroll D,-1
+'  OTYDOC_ScrollContent D,-1
   PAINTF=TRUE
   VOID RepaintWindow(WND)
  ENDIF
@@ -8297,6 +8467,69 @@
  ENDIF
  IF!PAINTF THEN VOID RepaintWindow(WND)
 END
+'なんかアレ
+DEF OTYDOC_UpdateScrollBarAndScrollContentDo2 D,DIFF
+END
+DEF OTYDOC_UpdateScrollBarAndScrollContentDot D,DIFF
+ VAR SCRBAR=OTYDOC_SCRBAR[D]
+ OTYDOC_SCRBARPOS[D]=GetScrollBarPosition(SCRBAR)+DIFF
+ IF OTYDOC_SCRBARPOS[D]<0||GetScrollBarSize(SCRBAR)<OTYDOC_SCRBARPOS[D] THEN
+  OTYDOC_SCRBARPOS[D]=GetScrollBarPosition(SCRBAR)
+  RETURN
+ ENDIF
+ SetScrollBarPosition SCRBAR,OTYDOC_SCRBARPOS[D]
+ OTYDOC_ScrollContentDot D,DIFF
+END
+DEF OTYDOC_ScrollContentDot D,DIFF
+ VAR S=OTYDOC_ShowLine[D]
+ VAR H=OTYDOC_HEIGHT[S]
+ VAR OFF=OTYDOC_YOFFSET[D]
+ VAR OFF2=OFF+DIFF
+ IF OFF2<0THEN
+  DIFF=DIFF+OTYDOC_YOFFSET[D]
+  H=0
+  WHILE 1
+   DIFF=H+DIFF
+   OTYDOC_YOFFSET[D]=DIFF
+   IF DIFF>=0 THEN BREAK
+   S=OTYDOC_ShowLine[D]
+   VAR P=OTYDOC_PREV[S]
+   IF!P THEN BREAK
+   IF OTYDOC_ISSEL[D]THEN
+    IF OTYDOC_SEL1[D]==P THEN
+     OTYDOC_HASSTARTSEL[D]=TRUE
+    ENDIF
+    IF OTYDOC_SEL2[D]==P THEN
+     OTYDOC_HASENDSEL[D]=TRUE
+    ENDIF
+   ENDIF
+   H=OTYDOC_HEIGHT[P]
+   OTYDOC_ShowLine[D]=P
+  WEND
+ ELSEIF OFF2<H THEN
+  OTYDOC_YOFFSET[D]=OFF2
+ ELSEIF OFF2>=H THEN
+  DIFF=DIFF+OTYDOC_YOFFSET[D]
+  H=0
+  WHILE 1
+   S=OTYDOC_ShowLine[D]
+   DIFF=DIFF-H
+   OTYDOC_YOFFSET[D]=DIFF
+   IF OTYDOC_YOFFSET[D]<OTYDOC_HEIGHT[S]THEN BREAK
+   IF!OTYDOC_NEXT[S]THEN BREAK
+   IF OTYDOC_ISSEL[D]THEN
+    IF OTYDOC_SEL1[D]==S THEN
+     OTYDOC_HASSTARTSEL[D]=FALSE
+    ENDIF
+    IF OTYDOC_SEL2[D]==S THEN
+     OTYDOC_HASENDSEL[D]=FALSE
+    ENDIF
+   ENDIF
+   H=OTYDOC_HEIGHT[S]
+   OTYDOC_ShowLine[D]=OTYDOC_NEXT[S]
+  WEND
+ ENDIF
+END
 DEF OTYDOC_ScrollContent D,DIFF
  VAR I
  'DOWN
@@ -8356,7 +8589,7 @@
   VAR OLD=OTYDOC_SCRBARPOS[D]
   VAR DIFF=A2-OLD
   OTYDOC_SCRBARPOS[D]=A2
-  OTYDOC_ScrollContent D,DIFF
+  OTYDOC_ScrollContentDot D,DIFF
   VOID RepaintWindow(WND)
  ENDIF
 END
@@ -8367,9 +8600,19 @@
   IF P THEN
    OTYDOC_ISSEL[D]=0
    IF C==OTYDOC_ShowLine[D]THEN
-    OTYDOC_ShowLine[D]=OTYDOC_PREV[C]
-    OTYDOC_Scroll D,-1
+    IF OTYDOC_YOFFSET[D]THEN
+     OTYDOC_UpdateScrollBarAndScrollContentDot D,-OTYDOC_YOFFSET[D]
+    ELSE
+     OTYDOC_UpdateScrollBarAndScrollContentDot D,-OTYDOC_HEIGHT[OTYDOC_PREV[OTYDOC_CurLine[D]]]
+    ENDIF
+'    OTYDOC_ShowLine[D]=OTYDOC_PREV[C]
+'    OTYDOC_Scroll D,-1
    ENDIF
+   IF OTYDOC_PREV[C]==OTYDOC_ShowLine[D]THEN
+    IF OTYDOC_YOFFSET[D]THEN
+     OTYDOC_UpdateScrollBarAndScrollContentDot D,-OTYDOC_YOFFSET[D]
+    ENDIF
+   ENDIF
    VAR CV$=OTYDOC_VAL$[OTYDOC_CurLine[D]]
    OTYDOC_CurLine[D]=P
    OTYDOC_CX[D]=OTYDOC_TOPOS(OTYDOC_VAL$[OTYDOC_CurLine[D]],OTYDOC_GETPOS(CV$,OTYDOC_CX[D]))
@@ -8449,8 +8692,9 @@
   IF OTYDOC_NEXT[C]THEN
    OTYDOC_ISSEL[D]=0
    IF OTYDOC_CurLine[D]==OTYDOC_LastShowLine[D]THEN
-    OTYDOC_ShowLine[D]=OTYDOC_NEXT[OTYDOC_ShowLine[D]]
-    OTYDOC_Scroll D,1
+    OTYDOC_UpdateScrollBarAndScrollContentDot D,OTYDOC_HEIGHT[OTYDOC_NEXT[OTYDOC_CurLine[D]]]
+    'OTYDOC_ShowLine[D]=OTYDOC_NEXT[OTYDOC_ShowLine[D]]
+    'OTYDOC_Scroll D,1
    ENDIF
    VAR CV$=OTYDOC_VAL$[OTYDOC_CurLine[D]]
    OTYDOC_CurLine[D]=OTYDOC_NEXT[C]
@@ -8633,6 +8877,7 @@
   U=1
  ENDIF
  CX=LEN(OTYDOC_VAL$[OTYDOC_CurLine[D]])-1
+ IF 0THEN 
  VAR I,LLL
  FOR I=0TO CX
   IF I==OTYDOC_CX[D]THEN LLL=CSRX
@@ -8658,6 +8903,7 @@
  ?
  COLOR 15
  ?" "*(LLL);""
+ ENDIF
  IF U THEN
   IF R==0 THEN
    SetWindowVar WND,5,20
@@ -8980,8 +9226,8 @@
   OTYDOC_UpdateParentTable C,OTYDOC_GetWidth(WND)
  ENDIF
  OTYDOCRepaint WND
- ?OTYDOC_VAL$[C]
- ?" "*MAX(OTYDOC_CX[D],0);""
+ '?OTYDOC_VAL$[C]
+ '?" "*MAX(OTYDOC_CX[D],0);""
 END
 DEF OTYDOC_NewLineInitStyle$(D)
  RETURN CHR$(&HB10B)+CHR$(2)+CHR$(OTYDOC_STYLE[D])+CHR$(&HB10C)+CHR$(&HB10B)+CHR$(1)+CHR$(OTYDOC_COL[D])+CHR$(&HB10C)+CHR$(&HB10B)+CHR$(0)+CHR$(OTYDOC_WSIZE[D])+CHR$(&HB10C)
@@ -9139,23 +9385,13 @@
 COMMON DEF RTESave WND,FILE$ OUT ERR
  VAR D=OTYDOC_GetData(WND)
  VAR FILE
- FileOpen FILE$,FileWriteFlag() OUT FILE,ERR
+ FileOpen FILE$,FileWriteFlag()OR FileCreateFlag() OUT FILE,ERR
  IF ERR THEN RETURN
  FileWrite FILE,"OTYDOC"+LF$() OUT ERR
  VAR F=OTYDOC_GetFirstLine(OTYDOC_ShowLine[D])
- VAR OTYDOC_FILE_LINESTYLE=1,OTYDOC_FILE_CONTENT=2,OTYDOC_FILE_LINEDATA=3,OTYDOC_FILE_INDENT=4
- WHILE F
-  VAR LS$=CHR$(OTYDOC_FILE_LINESTYLE)+CHR$(1)+CHR$(OTYDOC_LINESTYLE[F])
-  VAR LD$=CHR$(OTYDOC_FILE_LINEDATA)+CHR$(1)+CHR$(OTYDOC_LINEDATA[F])
-  VAR LI$=CHR$(OTYDOC_FILE_INDENT)+CHR$(1)+CHR$(OTYDOC_INDENT[F])
-  VAR LC$=CHR$(OTYDOC_FILE_CONTENT)+CHR$(LEN(OTYDOC_VAL$[F]))+OTYDOC_VAL$[F]
-
-  FileWrite FILE,LC$ OUT ERR
-  FileWrite FILE,LS$ OUT ERR
-  FileWrite FILE,LD$ OUT ERR
-  FileWrite FILE,LI$ OUT ERR
-  F=OTYDOC_NEXT[F]
- WEND
+ VAR BUF$=""
+ OTYDOC_SerializeBlock F,BUF$
+ FileWrite FILE,BUF$ OUT ERR
  FileClose FILE OUT ERR
 END
 COMMON DEF RTENew WND
@@ -9172,47 +9408,69 @@
  VOID RepaintWindow(WND)
  OTYDOC_SetLine D,0
 END
-COMMON DEF RTEOpen WND,FILE$ OUT ERR
- VAR D=OTYDOC_GetData(WND)
- OTYDOC_ISSEL[D]=FALSE
- VAR F$
- LoadFile FILE$ OUT F$,ERR
- IF MID$(F$,0,LEN("OTYDOC")+1)!="OTYDOC"+LF$()THEN
-  ERR=TRUE
-  RETURN
- ENDIF
- VAR I=LEN("OTYDOC")+1
- RTENew WND
- VAR LINE=OTYDOC_ShowLine[D]
- VAR OTYDOC_FILE_LINESTYLE=1,OTYDOC_FILE_CONTENT=2,OTYDOC_FILE_LINEDATA=3,OTYDOC_FILE_INDENT=4
- VAR L=LEN(F$)-1
- VAR LC
- FOR I=I TO L
-  VAR C=ASC(F$[I])
+DEF OTYDOC_DeserializeBlock D$,IN_I OUT I,LC,OUTLINE
+ VAR L=LEN(D$)-1
+ VAR LINE=0
+ OUTLINE=0
+ LC=0
+ FOR I=IN_I TO L
+  VAR C=ASC(D$[I])
   IF I+1>L THEN BREAK
-  VAR CL=ASC(F$[I+1])
+  VAR CL=ASC(D$[I+1])
   IF I+1+CL>L THEN BREAK
+  IF C==OTYDOC_FILE_NEWCOL THEN
+   BREAK
+  ENDIF
+  IF C==OTYDOC_FILE_TABLE THEN
+   LINE=OTYDOC_NewLine("",LINE)
+   OTYDOC_DeserializeTable D$,I,LINE OUT I,OTYDOC_TABLEDATA[LINE]
+   IF!OUTLINE THEN OUTLINE=LINE
+   INC LC
+   I=I-1
+   CONTINUE
+  ENDIF
   IF C==OTYDOC_FILE_LINESTYLE THEN
-   VAR V=ASC(F$[I+2])
+   VAR V=ASC(D$[I+2])
    OTYDOC_LINESTYLE[LINE]=V
   ELSEIF C==OTYDOC_FILE_LINEDATA THEN
-   V=ASC(F$[I+2])
+   V=ASC(D$[I+2])
    OTYDOC_LINEDATA[LINE]=V
   ELSEIF C==OTYDOC_FILE_INDENT THEN
-   V=ASC(F$[I+2])
+   V=ASC(D$[I+2])
    OTYDOC_INDENT[LINE]=V
   ELSEIF C==OTYDOC_FILE_CONTENT THEN
-   LINE=OTYDOC_NewLine(MID$(F$,I+2,CL),LINE)
+   LINE=OTYDOC_NewLine(MID$(D$,I+2,CL),LINE)
+   IF!OUTLINE THEN OUTLINE=LINE
    INC LC
    OTYDOC_AdjustLine LINE
   ENDIF
   I=I+CL+1
  NEXT
- IF LINE!=OTYDOC_ShowLine[D]THEN
-  OTYDOC_ShowLine[D]=OTYDOC_DeleteLine(OTYDOC_ShowLine[D])
+ 
+END
+COMMON DEF RTEOpen WND,FILE$ OUT ERR
+ VAR D=OTYDOC_GetData(WND)
+ OTYDOC_ISSEL[D]=FALSE
+ VAR F$
+ LoadFile FILE$ OUT F$,ERR
+ IF MID$(F$,0,LEN("OTYDOC")+1)!="OTYDOC"+LF$()THEN
+  ERR=TRUE
+  RETURN
+ ENDIF
+ VAR I=LEN("OTYDOC")+1
+ RTENew WND
+ VAR LINE=OTYDOC_ShowLine[D]
+ VAR L=LEN(F$)-1
+ VAR LC
+ VAR OUTLINE
+ OTYDOC_DeserializeBlock F$,I OUT I,LC,LINE
+ IF LINE THEN
+  VOID OTYDOC_DeleteLine(OTYDOC_ShowLine[D])
+  OTYDOC_ShowLine[D]=LINE
   OTYDOC_CurLine[D]=OTYDOC_ShowLine[D]
   OTYDOC_SetLine D,LC-1
  ENDIF
+ OTYDOC_CalcDocumentSize WND
 END
 DEF OTYDOC_PlainText F,S,E,O$
  VAR L$=MID$(OTYDOC_VAL$[F],S,E-S)
@@ -9221,10 +9479,59 @@
  NEXT
  PUSH O$,L$+LF$()
 END
+'if ER=-1, ER=Row size
+'if EC=-1, EC=Col size
+DEF OTYDOC_SerializeTable TBL,O$,SR,SC,ER,EC
+ IF 0THEN DIM A[0]
+ A=GetSBArray(TBL)
+ VAR ROW=A[OTYDOC_TABLEARY_ROW]
+ VAR COL=A[OTYDOC_TABLEARY_COL]
+ IF ER==-1THEN ER=ROW-1
+ IF EC==-1THEN EC=COL-1
+ IF SR>ER THEN SWAP SR,ER
+ IF SC>EC THEN SWAP SC,EC
+ PUSH O$,CHR$(OTYDOC_FILE_TABLE)+CHR$(2)
+ PUSH O$,CHR$(ER-SR+1)
+ PUSH O$,CHR$(EC-SC+1)
+ VAR H=OTYDOC_TABLEARY_HEAD+ROW+COL
+ 
+ VAR I,J,Y,X,R,C
+ FOR R=SR TO ER
+  FOR C=SC TO EC
+   VAR L=A[H+R*COL*OTYDOC_TBLELM+C*OTYDOC_TBLELM]
+   OTYDOC_SerializeBlock L,O$
+   PUSH O$,CHR$(OTYDOC_FILE_NEWCOL)+CHR$(0)
+  NEXT
+  PUSH O$,CHR$(OTYDOC_FILE_NEWROW)+CHR$(0)
+ NEXT
+  PUSH O$,CHR$(OTYDOC_FILE_TABLEEND)+CHR$(0)
+ 
+END
+DEF OTYDOC_SerializeBlock F,O$
+ WHILE F
+  IF OTYDOC_TABLEDATA[F]THEN
+   OTYDOC_SerializeTable OTYDOC_TABLEDATA[F],O$,0,0,-1,-1
+  ELSE
+   VAR LS$=CHR$(OTYDOC_FILE_LINESTYLE)+CHR$(1)+CHR$(OTYDOC_LINESTYLE[F])
+   VAR LD$=CHR$(OTYDOC_FILE_LINEDATA)+CHR$(1)+CHR$(OTYDOC_LINEDATA[F])
+   VAR LI$=CHR$(OTYDOC_FILE_INDENT)+CHR$(1)+CHR$(OTYDOC_INDENT[F])
+   VAR LC$=CHR$(OTYDOC_FILE_CONTENT)+CHR$(LEN(OTYDOC_VAL$[F]))+OTYDOC_VAL$[F]
+
+   PUSH O$,LC$
+   PUSH O$,LS$
+   PUSH O$,LD$
+   PUSH O$,LI$
+  ENDIF
+  F=OTYDOC_NEXT[F]
+ WEND
+END
 DEF OTYDOC_Serialize F,S,E,O$
- VAR OTYDOC_FILE_LINESTYLE=1,OTYDOC_FILE_CONTENT=2,OTYDOC_FILE_LINEDATA=3,OTYDOC_FILE_INDENT=4
  VAR L$=""
  
+ IF OTYDOC_TABLEDATA[F]THEN
+  OTYDOC_SerializeTable OTYDOC_TABLEDATA[F],O$,0,0,-1,-1
+  RETURN
+ ENDIF
  VAR S$,TYPE
  FOR TYPE=0TO 2
   OTYDOC_GetStyle OTYDOC_VAL$[F],0,S,TYPE OUT S$
@@ -9239,6 +9546,7 @@
  PUSH O$,LS$
  PUSH O$,LD$
  PUSH O$,LI$
+ 
 END
 DEF OTYDOC_PastePlainText WND,TXT$
  VAR D=OTYDOC_GetData(WND)
@@ -9275,6 +9583,51 @@
  ENDIF
  VOID RepaintWindow(WND)
 END
+DEF OTYDOC_DeserializeTable D$,IN_I,TBLLINE OUT I,TBL
+ VAR L=LEN(D$)-1
+ VAR ROW,COL
+ VAR _
+ VAR COLC,ROWC
+ FOR I=IN_I TO L
+  VAR C=ASC(D$[I])
+  IF I+1>L THEN BREAK
+  VAR CL=ASC(D$[I+1])
+  IF I+1+CL>L THEN BREAK
+  IF C==OTYDOC_FILE_TABLE THEN
+   ROW=ASC(D$[I+2])
+   COL=ASC(D$[I+3])
+   TBL=AllocSBArray()
+   VAR H=OTYDOC_TABLEARY_HEAD+ROW+COL
+   DIM A[ROW*COL*OTYDOC_TBLELM+H]
+   A[OTYDOC_TABLEARY_ROW]=ROW
+   A[OTYDOC_TABLEARY_COL]=COL
+   SetSBArray TBL,A
+   A[OTYDOC_TABLEARY_LINE]=TBLLINE
+   OTYDOC_LINEDATA[TBLLINE]=OTYDOC_TABLE
+  ELSEIF C==OTYDOC_FILE_NEWROW THEN
+   COL=0
+   INC ROWC
+  ELSEIF C==OTYDOC_FILE_NEWCOL THEN
+   INC COLC
+  ELSEIF C==OTYDOC_FILE_TABLEEND THEN
+   I=I+CL+2
+   BREAK
+  ELSE
+   VAR LINE
+   OTYDOC_DeserializeBlock D$,I OUT I,_,LINE
+   
+   A[H+ROWC*COL*OTYDOC_TBLELM+COLC*OTYDOC_TBLELM]=LINE
+   WHILE LINE
+    OTYDOC_TABLEPARENT[LINE]=TBL
+    LINE=OTYDOC_NEXT[LINE]
+   WEND
+   I=I-1
+   CONTINUE
+  ENDIF
+  
+  I=I+CL+1
+ NEXT
+END
 COMMON DEF RTEPaste WND
  VAR D=OTYDOC_GetData(WND)
  IF OTYDOC_ISSEL[D]THEN
@@ -9300,7 +9653,6 @@
  LST$=ST$+LST$
  OTYDOC_VAL$[C]=F$
 
- VAR OTYDOC_FILE_LINESTYLE=1,OTYDOC_FILE_CONTENT=2,OTYDOC_FILE_LINEDATA=3,OTYDOC_FILE_INDENT=4
  VAR L=LEN(D$)-1
  VAR LC
  VAR LINE=C
@@ -9308,9 +9660,19 @@
  VAR FIRSTLINE=TRUE
  FOR I=I TO L
       C=ASC(D$[I])
+  IF C==OTYDOC_FILE_NEWCOL THEN
+   BREAK
+  ENDIF
   IF I+1>L THEN BREAK
   VAR CL=ASC(D$[I+1])
   IF I+1+CL>L THEN BREAK
+  IF C==OTYDOC_FILE_TABLE THEN
+   LINE=OTYDOC_NewLine("",LINE)
+   OTYDOC_DeserializeTable D$,I,LINE OUT I,OTYDOC_TABLEDATA[LINE]
+   INC LC
+   I=I-1
+   CONTINUE
+  ENDIF
   IF LINE!=FL THEN
    IF C==OTYDOC_FILE_LINESTYLE THEN
     VAR V=ASC(D$[I+2])
@@ -9377,6 +9739,13 @@
  VAR E=OTYDOC_SEL2[D]
  VAR SX=OTYDOC_SEL1X[D]
  VAR EX=OTYDOC_SEL2X[D]
+ VAR STBL=OTYDOC_SEL1TABLE[D]
+ VAR SROW=OTYDOC_SEL1ROW[D]
+ VAR SCOL=OTYDOC_SEL1COL[D]
+ VAR ETBL=OTYDOC_SEL2TABLE[D]
+ VAR EROW=OTYDOC_SEL2ROW[D]
+ VAR ECOL=OTYDOC_SEL2COL[D]
+ 
  VAR O$=""
  VAR P$=""
  ClearClipboard
@@ -9388,6 +9757,9 @@
   RETURN
  ENDIF
  VAR _
+ IF STBL&&STBL==ETBL THEN
+  OTYDOC_SERIALIZETABLE STBL,O$,SROW,SCOL,EROW,ECOL
+ ELSE
  OTYDOC_SERIALIZE S,SX,LEN(OTYDOC_VAL$[S]),O$
  OTYDOC_PlainText S,SX,LEN(OTYDOC_VAL$[S]),P$
  S=OTYDOC_NEXT[S]
@@ -9403,6 +9775,7 @@
   OTYDOC_PlainText S,0,LEN(OTYDOC_VAL$[S]),P$
   S=NXT
  WEND
+ ENDIF
  ClipboardSetData$ "RichText",O$
  ClipboardSetText P$
 END
@@ -9618,7 +9991,6 @@
  ENDIF
  IF N$=="OTYDOCCOLOR"THEN
   RTESetTextColor GetWindowVar(WND,0),F
-  VOID DeleteWindow(CW)
  ENDIF
  IF N$==""THEN
   VAR BTNL,BTNC,BTNR
@@ -9712,11 +10084,6 @@
 COMMON DEF OTYDOC_ColorChFocus WND,CTL,TYP,FLG,FW
  IF!FLG THEN
   IF GetParentWindow(FW)==WND THEN RETURN
-  VAR OWN=GetWindowGroupOwner(WND)
-  IF GetWindowVar(WND,0)!=-1THEN
-   VOID SendNotifWindow(OWN,WND,GetConsolePalette(GetWindowVar(WND,0)))
-   RETURN
-  ENDIF
   VOID DeleteWindow(WND)
  ENDIF
 END
@@ -9728,6 +10095,11 @@
  IF COL>15THEN RETURN
  SetWindowVar WND,0,COL
  OTYDOC_COLORPAINT WND,CTL,TYP,0,0
+ VAR OWN=GetWindowGroupOwner(WND)
+ IF GetWindowVar(WND,0)!=-1THEN
+  VOID SendNotifWindow(OWN,WND,GetConsolePalette(GetWindowVar(WND,0)))
+  RETURN
+ ENDIF
 END
 COMMON DEF OTYDOC_ShowMenu CTL,WND,X,Y,X2,Y2
  VAR E,MENUWND
@@ -9901,13 +10273,19 @@
  DIM ICONS[512]
  LOAD"DAT:OTYFILRC",ICONS,0
  OTYFILICODIR=NewArray(16*16)
- LOAD"DAT:OTYFILRC3",OTYFILICODIR,0
+' LOAD"DAT:OTYFILRC3",OTYFILICODIR,0
  OTYFILICOTXT=NewArray(16*16)
  OTYFILICODAT=NewArray(16*16)
  OTYFILICON=NewArray(16*16)
  COPY OTYFILICOTXT,ICONS,0,16*16
  COPY OTYFILICODAT,ICONS,16*16,16*16
- COPY OTYFILICON,ICONS,16*16*2,16*16
+' COPY OTYFILICON,ICONS,16*16*2,16*16
+ DIM A[16,16]
+ LOAD"DAT:FOLDER.IMG",A,0
+ COPY OTYFILICODIR,A,0,16*16
+ LOAD"DAT:FILEMAN.IMG",A,0
+ COPY OTYFILICON,A,0,16*16
+ 
 END
 VAR OTYFILCTL
 VAR OTYFILICONCTL
@@ -10059,7 +10437,7 @@
    ERR=NewDir(FOLNAME$)
   ENDIF
   IF ERR THEN
-   VOID MessageBox(WND,"Files","error:0x"+HEX$(ERR,8),MessageBoxOK())
+   VOID MessageBox(WND,"Files","error:"+GetErrorName$(ERR),MessageBoxOK())
    RETURN
   ENDIF
   VOID(DeleteWindow(WND))
@@ -10217,7 +10595,7 @@
   IF K>=KL THEN
    IF ISSEL THEN
     ISSEL=0
-    KL=GetWindowVar(WND,4)
+    KL=MIN(LEN(ARY$),GetWindowVar(WND,4))
     K=0
    ELSE
     BREAK
@@ -11640,6 +12018,7 @@
  VAR CY=GetWindowVar(WND,2)
  VAR CNT=GetWindowVar(WND,3)
  IF CX<=X||CY<=Y THEN RETURN
+ IF FIELD[X,Y]AND OTYMINE_FLAG THEN RETURN
  IF (FIELD[X,Y]AND&B1111)==OTYMINE_MINE THEN
   SetWindowVar WND,4,TRUE'GAMEOVER
   FIELD[X,Y]=FIELD[X,Y] OR OTYMINE_MISS
@@ -11862,11 +12241,11 @@
  IF UpdateWindow(GetProcessVar())THEN ExitProcess 1
 END
 
-DEF TESTIM_KEY IM,KEY
+DEF DEFIM_KEY IM,KEY
  IF!OTW_ENABLEKEY THEN RETURN
  VOID SendIMText(IM,CHR$(KEY))
 END
-COMMON DEF I_TESTIM
+COMMON DEF I_DEFIM
  IF!CHKCALL("IsWinRunning")||!IsWinRunning()THEN
   PrintConsole "Require window system"+LF$()
   ExitProcess 1
@@ -11878,11 +12257,11 @@
   ExitProcess ERR
   RETURN
  ENDIF
- ERR=SetIMKeyHandler(IM,"TESTIM_KEY")
+ ERR=SetIMKeyHandler(IM,"DEFIM_KEY")
  SetProcessVar IM
  KEY 1,"KEY OFF"
 END
-COMMON DEF L_TESTIM
+COMMON DEF L_DEFIM
  VAR X,Y,MMM
  TOUCH OUT MMM,X,Y
  IF MMM&&!OTW_ENKEY_STATE&&X>=5&&X<=63&&Y>=5&&Y<=16THEN
@@ -12435,21 +12814,26 @@
  
  SetProcessVar IM
  KEY 1,"KEY OFF"
- EXEC 2
+ 
+ EXEC 3
 END
 COMMON DEF L_RIM
  VAR X,Y,MMM
  TOUCH OUT MMM,X,Y
  IF MMM&&!OTW_ENKEY_STATE&&X>=5&&X<=63&&Y>=5&&Y<=16THEN
   OTW_ENKEY_STATE=1
-  RIM_MODE=(RIM_MODE+1)MOD 4
+  RIM_MODE=(RIM_MODE+1)MOD 3
   IF RIM_MODE==1 THEN
+   SetKeyboardMode!TRUE
    KEY 1,"KEY ON"
   ELSEIF RIM_MODE==2THEN
+   SetKeyboardMode!TRUE
    KEY 1,"かな ON"
   ELSEIF RIM_MODE==3THEN
+   SetKeyboardMode!TRUE
    KEY 1,"カナ ON"
   ELSE
+   SetKeyboardMode TRUE
    KEY 1,"KEY OFF"
   ENDIF
   BEEP 9
@@ -12564,6 +12948,17 @@
    OTWTERM_SCROLL_Y CONSOLE,X,Y,W,H,STYLE OUT X,Y
    CONTINUE
   ENDIF
+  IF D==9THEN
+   IF X MOD TABSTEP THEN
+    X=X+X MOD TABSTEP
+   ELSE
+    X=X+TABSTEP
+   ENDIF
+   IF X>=W THEN
+    OTWTERM_SCROLL_Y CONSOLE,X,Y,W,H,STYLE OUT X,Y
+   ENDIF
+   CONTINUE
+  ENDIF
   CONSOLE[Y*W+X]=(STYLE<<16) OR D
   INC X
   IF X>=W THEN
@@ -12989,14 +13384,22 @@
  IF GBeginWindow(WND)THEN RETURN
  GCLSWindow WND,GetWindowBackColor(WND)
  SetWindowDrawPos WND,(GetWindowWidth(WND)-WW)DIV 2,(GetWindowHeight(WND)-WW)DIV 2
- GCIRCLEWindow WND,WW DIV 2,WH DIV 2,WW DIV 2,#BLACK
- VAR H#=RAD(H*(360/24))
- VAR M#=RAD(M*(360/60))
+ VAR S2=H*60*60+M*60+S
+ ?S2,H,M,S
+ VAR H#=RAD(S2/3600*(360/24)+90)'H*(360/24))
+ VAR M#=RAD(S2/60*(360/60)+270)'M*(360/60))
  VAR S#=RAD(S*(360/60))
  H=S
- GLINEWindow WND,WW DIV 2,WH DIV 2,WW/2+COS(S#)*(WW/2),WW/2+SIN(S#)*(WW/2),#BLACK
- GLINEWindow WND,WW DIV 2,WH DIV 2,WW/2+COS(H#)*(WW/2)*0.5,WW/2+SIN(H#)*(WW/2)*0.5,#BLACK
- GLINEWindow WND,WW DIV 2,WH DIV 2,WW/2+COS(M#)*(WW/2),WW/2+SIN(M#)*(WW/2)*0.9,#BLACK
+ VAR C=WW DIV 2
+ GLINEWindow WND,C,C,C+COS(S#)*(C),C+SIN(S#)*(C),#BLACK
+ GCIRCLEWindow WND,C,C,C,#BLACK
+' GLINEWindow WND,C,C,C+COS(H#)*(C)*0.5,C+SIN(H#)*(C)*0.5,#BLACK
+ VAR R#=RAD(3)
+ GTRIWindow WND,C,C,C+COS(H#-R#)*(WW/8),C+SIN(H#-R#)*(WW/8),C+COS(H#)*C,C+SIN(H#)*C,#BLACK
+ GTRIWindow WND,C,C,C+COS(H#+R#)*(WW/8),C+SIN(H#+R#)*(WW/8),C+COS(H#)*(C),C+SIN(H#)*(C),#BLACK
+'GLINEWindow WND,C,C,C+COS(M#)*(C),C+SIN(M#)*(C)*0.9,#BLACK
+ GTRIWindow WND,C,C,C+COS(M#-R#)*(WW/8),C+SIN(M#-R#)*(WW/8),C+COS(M#)*C,C+SIN(M#)*C,#BLACK
+ GTRIWindow WND,C,C,C+COS(M#+R#)*(WW/8),C+SIN(M#+R#)*(WW/8),C+COS(M#)*(C),C+SIN(M#)*(C),#BLACK
  IF GEndWindow(WND)THEN RETURN
 END
 COMMON DEF I_OTWCLOCK
