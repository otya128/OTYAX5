diff -u OTW.TXT OTW2A
--- OTW.TXT
+++ OTW2A
@@ -924,9 +924,19 @@
 VAR CLPBRD$
 VAR CLPBRD#
 VAR CLPBRDPTR
+DIM CLPBRDTYPE$[0]
+DIM CLPBRDDATA$[0]
+DEF CLIPBOARD_INIT
+ CLPBRDTYPE$=NewArray$(0)
+ CLPBRDDATA$=NewArray$(0)
+END
 COMMON DEF ClearClipboard
  CLPBRDCTXT=FALSE
  CLPBRDCFIL=FALSE
+ IF LEN(CLPBRDTYPE$)THEN
+  CLPBRDTYPE$=NewArray$(0)
+  CLPBRDDATA$=NewArray$(0)
+ ENDIF
 END
 COMMON DEF ClipboardContainsText()
  RETURN CLPBRDCTXT
@@ -939,6 +949,30 @@
  CLPBRDCTXT=1
  CLPBRD$=V$
 END
+'TYPE$:RichText
+COMMON DEF ClipboardSetData$ TYPE$,V$
+ VAR I'LINEAR
+ FOR I=0TO LEN(CLPBRDTYPE$)-1
+  IF CLPBRDTYPE$[I]==TYPE$THEN
+   CLPBRDDATA$[I]=V$
+   RETURN
+  ENDIF
+ NEXT
+ PUSH CLPBRDDATA$,V$
+ PUSH CLPBRDTYPE$,TYPE$
+END
+COMMON DEF ClipboardGetData$ TYPE$ OUT DATA$,CONTAINS
+ VAR I'LINEAR
+ FOR I=0TO LEN(CLPBRDTYPE$)-1
+  IF CLPBRDTYPE$[I]==TYPE$THEN
+   DATA$=CLPBRDDATA$[I]
+   CONTAINS=TRUE
+   RETURN
+  ENDIF
+ NEXT
+ CONTAINS=FALSE
+ DATA$=""
+END
 COMMON DEF ClipboardContainsFile()
  RETURN CLPBRDCFIL
 END
@@ -961,10 +995,17 @@
  VAR I=IMG AND 4095
  LoadData FIL$,GetSBArray(IMAGE_PTR[I])
 END
-COMMON DEF NewArrayImage ARRAY OUT IMG,E
- 
+COMMON DEF LoadImage FIL$,W,H OUT IMG,E
+ VAR FILE$
+ NewImage NewArray2(W,H),W,H OUT IMG,E
+ IF E THEN
+  IMG=0
+  RETURN
+ ENDIF
+ VAR I=IMG AND 4095
+ LoadData FIL$,GetSBArray(IMAGE_PTR[I]) OUT E
 END
-COMMON DEF NewImage WIDTH,HEIGHT OUT IMG,E
+COMMON DEF NewImage ARRAY,WIDTH,HEIGHT OUT IMG,E
  IF !IMAGE_FREE THEN IMG=0:E=IMAGE_NOALLOC:RETURN
  VAR PTR=AllocSBArray()
  IF PTR==-1 THEN IMG=0:E=IMAGE_NOALLOC:RETURN
@@ -975,7 +1016,7 @@
  IMAGE_PTR[IMAGE_FREE]=PTR
  IMG=IMAGE_FREE OR IMAGE_IDCNT<<12
  IMAGE_FREE=IMAGE_NEXT[IMAGE_FREE]
- SetSBArray PTR,NewArray(WIDTH,HEIGHT)
+ SetSBArray PTR,ARRAY
  E=0
  RETURN
 END
@@ -985,11 +1026,16 @@
 COMMON DEF DeleteImage(IMG)
  IF!CheckImage(IMG)THEN RETURN IMAGE_NOALLOC
  VAR I=IMG AND 4095
- free IMAGE_PTR[I]
+ FreeSBArray IMAGE_PTR[I]
  IMAGE_NEXT[I]=IMAGE_FREE
  IMAGE_FREE=I
  RETURN 0
 END
+COMMON DEF GLOADImage X,Y,IMG,TF
+ IF!CheckImage(IMG)THEN RETURN
+ VAR I=IMG AND 4095
+ GLOAD X,Y,IMAGE_WIDTH[I],IMAGE_HEIGHT[I],GetSBArray(IMAGE_PTR[I]),1,TF
+END
 VAR MENU_NOALLOC
 COMMON DEF NewMenu OUT MENU,E
  IF !MENU_FREE THEN MENU=0:E=MENU_NOALLOC:RETURN
@@ -3145,6 +3191,10 @@
  VAR AY=WING_SY'WIN_FY[WND AND NUWIDMASK]
  GLOAD X+AX,Y+AY,W,H,IMG,FLG,MODE
 END
+COMMON DEF GLOADImageWindow WND,X,Y,IMG,F
+ GLOADImage X+WING_SX,Y+WING_SY,IMG,F
+END
+
 COMMON DEF GSAVEImage IMG,WND,X,Y,W,H,IX,IY
  IF (WND AND NUWIDMASK)==GB_WND THEN RETURN
  IF!CheckImage(IMG)THEN RETURN
@@ -4354,6 +4404,7 @@
  VAR L=GetWindowVar(WND,0)
  IF L&&L==A1 THEN
   VOID HideWindow(L)
+  VOID SendNotifWindow(GetOwnerWindow(WND),A1,A2)
  ENDIF
 END
 COMMON DEF DropDownListBoxChFocus WND,CT,T,F,A2
@@ -4757,6 +4808,7 @@
   OTW_INIT_ERR
   OTW_ASSOC_INIT
   OTW_IM_INITARRAY
+  CLIPBOARD_INIT
   PrintConsoleln "Init setting..."
   OTW_USEBTN=&B11001111
   OTW_FPS=1
@@ -5892,9 +5944,7 @@
  ?"UNK
  RETURN
  @CUT
- TextBoxExCopy WND
- VAR _
- TEXTBOXEX_REMOVESELECTEDTEXT WND OUT _,_
+ TextBoxExCut WND
  RETURN
  @COPY
 '?TEXTBOXEXGETSELECTEDTEXT(WND)
@@ -6404,6 +6454,11 @@
  VAR TXT$=ClipboardGetText$()
  TextBoxExSetSelectedText WND,TXT$
 END
+COMMON DEF TextBoxExCut WND
+ TextBoxExCopy WND
+ VAR _
+ TEXTBOXEX_REMOVESELECTEDTEXT WND OUT _,_
+END
 COMMON DEF TextBoxExSelectAll WND
  VAR BOX=GetWindowVar(WND,7)
  VAR C=TXTBOXEX_CFIRST[BOX]
@@ -6922,34 +6977,27 @@
 END
 COMMON DEF RICHTEXT X,Y,C,STYLE,SIZE,COL
  VAR S2=SIZE DIV 8
- VAR I,X2,BF=0
+ VAR I,X2
 ' INC Y,SIZE MOD 8
- IF SIZE==8THEN'&&(STYLE AND 3)!=3THEN
-  X2=X
   @LOOP1
   IF STYLE AND 2THEN
    VAR IX=512-SIZE,IY=512-SIZE
    GFILL IX,IY,511,511,0
    GPUTCHR IX,IY,C,S2,S2,COL
-   GCOPY IX,IY,511,512-S2*4,X+1,Y,0
-   GCOPY IX,IY+S2*4,511,511,X,Y+S2*4,0
+   IF STYLE AND 1 THEN
+    GPUTCHR X+S2,Y,C,S2,S2,COL
+    GCOPY IX,IY,511,512-S2*4-1,X+1,Y,0
+    GCOPY IX,IY+S2*4,511,511,X,Y+S2*4,0
+   ELSE
+    GCOPY IX,IY,511,512-S2*4-1,X+1,Y,0
+    GCOPY IX,IY+S2*4,511,511,X,Y+S2*4,0
+   ENDIF
   ELSE
    GPUTCHR X,Y,C,S2,S2,COL
+   IF STYLE AND 1 THEN
+    GPUTCHR X+S2,Y,C,S2,S2,COL
+   ENDIF
   ENDIF
-  IF STYLE AND 1 THEN
-   INC X
-   STYLE=STYLE AND NOT 1
-   BF=TRUE
-   GOTO @LOOP1
-   'GPUTCHRWindow WND,X+1,Y,C,COL
-  ENDIF
-  X=X2
- ELSE
-  GPUTCHR X,Y,C,S2,S2,COL
-  IF STYLE AND 1 THEN
-   GPUTCHR X+1,Y,C,S2,S2,COL
-  ENDIF
- ENDIF
  IF STYLE AND 4THEN
   GLINE X,Y+SIZE/2-1,X+SIZE,Y+SIZE/2-1,COL
  ENDIF
@@ -6967,9 +7015,13 @@
 VAR OTYDOC_LEFT
 VAR OTYDOC_CENTER
 VAR OTYDOC_RIGHT
+'left/right/center
 DIM OTYDOC_LINESTYLE[0]
+'heading/list
+DIM OTYDOC_LINEDATA[0]
 'LINE SIZE
 DIM OTYDOC_SIZE[0]
+DIM OTYDOC_INDENT[0]
 VAR OTYDOC_LINESIZ
 
 VAR OTYDOC_WFREE
@@ -6998,8 +7050,17 @@
 DIM OTYDOC_SELSX[0]
 DIM OTYDOC_ISSEL[0]
 DIM OTYDOC_SELREVERSE[0]
+VAR OTYDOC_HEAD1
+VAR OTYDOC_HEAD2
+VAR OTYDOC_HEAD3
+VAR OTYDOC_HEAD4
+VAR OTYDOC_HEAD5
+VAR OTYDOC_HEAD6
+VAR OTYDOC_ORDLIST
+VAR OTYDOC_UORDLIST
 VAR OTYDOC_BEG$
 VAR OTYDOC_END$
+VAR OTYDOC_MENU
 COMMON DEF INIT_OTYDOC
  VAR E
  IF!OTYDOCCTL THEN
@@ -7015,6 +7076,7 @@
   E=SetControlLMouseDownHandler(OTYDOCCTL,"OTYDocLMouseUp")
   E=SetControlMouseMoveHandler(OTYDOCCTL,"OTYDocMouseMove")
   E=SetControlNotifHandler(OTYDOCCTL,"OTYDocNotif")
+  E=SetControlRMouseDownHandler(OTYDOCCTL,"OTYDocRMouseDW")
   OTYDOC_LINESIZ=1024
   OTYDOC_VAL$=NewArray$(OTYDOC_LINESIZ)
   OTYDOC_LINE=NewArray(OTYDOC_LINESIZ)
@@ -7022,9 +7084,19 @@
   OTYDOC_PREV=NewArray(OTYDOC_LINESIZ)
   OTYDOC_SIZE=NewArray(OTYDOC_LINESIZ)
   OTYDOC_LINESTYLE=NewArray(OTYDOC_LINESIZ)
+  OTYDOC_LINEDATA=NewArray(OTYDOC_LINESIZ)
+  OTYDOC_INDENT=NewArray(OTYDOC_LINESIZ)
   OTYDOC_LEFT=0
   OTYDOC_CENTER=1
   OTYDOC_RIGHT=2
+  OTYDOC_HEAD1=1
+  OTYDOC_HEAD2=2
+  OTYDOC_HEAD3=3
+  OTYDOC_HEAD4=4
+  OTYDOC_HEAD5=5
+  OTYDOC_HEAD6=6
+  OTYDOC_ORDLIST=7
+  OTYDOC_UORDLIST=8
   OTYDOC_FREE=1
   VAR I
   FOR I=1TO OTYDOC_LINESIZ-2
@@ -7059,6 +7131,12 @@
   FOR I=1TO OTYDOC_WSIZ-2
    OTYDOC_WNEXT[I]=I+1
   NEXT
+  NewMenu OUT OTYDOC_MENU,E
+  AddMenuItem OTYDOC_MENU,"Copy",1
+  AddMenuItem OTYDOC_MENU,"Cut",2
+  AddMenuItem OTYDOC_MENU,"Paste",3
+  AddMenuItemSeparator OTYDOC_MENU
+  AddMenuItem OTYDOC_MENU,"Select all",4
  ENDIF
 END
 DEF OTYDOC_NewLINE(V$,P)
@@ -7068,7 +7146,9 @@
   OTYDOC_LINE[R]=OTYDOC_LINE[P]+1
  ELSE
   OTYDOC_LINE[R]=1
+  OTYDOC_INDENT[R]=0
  ENDIF
+ OTYDOC_LINEDATA[R]=0
  VAR N
  IF P THEN
   N=OTYDOC_NEXT[P]
@@ -7077,6 +7157,13 @@
  OTYDOC_VAL$[R]=V$
  OTYDOC_NEXT[R]=N
  OTYDOC_PREV[R]=P
+ IF P THEN
+  VAR LD=OTYDOC_LINEDATA[P]
+  IF LD==OTYDOC_UORDLIST||LD==OTYDOC_ORDLIST THEN
+   OTYDOC_LINEDATA[R]=LD
+  ENDIF
+  OTYDOC_INDENT[R]=OTYDOC_INDENT[P]
+ ENDIF
  IF N THEN
   OTYDOC_PREV[N]=R
  ENDIF
@@ -7219,6 +7306,7 @@
  IF!D THEN
   RETURN
  ENDIF
+ VAR SL=OTYDOC_ShowLine[D]
  VAR I=OTYDOC_ShowLine[D]
  VAR CL=OTYDOC_CurLine[D]
  VAR CX=OTYDOC_CX[D]
@@ -7249,6 +7337,7 @@
  ENDIF
  VAR SELBKGND=GetSelectionColor()
  VAR SELFRGND=GetSelectionTextColor()
+ VAR OL=0
  WHILE I
   VAR YSZ=OTYDOC_SIZE[I]
 '?"YSZ",YSZ
@@ -7258,8 +7347,46 @@
   VAR A
   VAR L=LEN(V$)-1,J,C
   SZ=8
-  X=1
+  X=1+OTYDOC_INDENT[I]
   
+  VAR LINED=OTYDOC_LINEDATA[I]
+  IF LINED==OTYDOC_UORDLIST THEN
+   VAR Y8=(YSZ DIV 8)
+   GFILL X+Y8,Y+2*Y8,X+3*Y8,Y+4*Y8,#BLACK
+   X=X+5*Y8
+   OL=0
+  ELSEIF LINED==OTYDOC_ORDLIST THEN
+   Y8=(YSZ DIV 8)
+   IF OL THEN
+    OL=OL+1
+   ELSEIF I==SL THEN
+    VAR OLS=OTYDOC_PREV[I]
+    OL=1
+    WHILE OLS
+     IF OTYDOC_LINEDATA[OLS]==OTYDOC_ORDLIST THEN
+      OL=OL+1
+      OLS=OTYDOC_PREV[OLS]
+     ELSE
+      BREAK
+     ENDIF
+    WEND
+   ELSE
+    OL=1
+   ENDIF
+   VAR OOL=OL
+   VAR DG=LOG(OL,10)
+   X=X+DG*5*Y8
+   VAR K
+   FOR K=0 TO DG
+    GPUTCHR X,Y,OOL MOD 10+48,Y8,Y8
+    OOL=OOL DIV 10
+    X=X-5*Y8
+   NEXT
+   X=X+DG*5*Y8+14*Y8
+   GFILL X-2*Y8,Y+YSZ-2*Y8,X-Y8-1,Y+YSZ-Y8-1,#BLACK
+  ELSE
+   OL=0
+  ENDIF
   IF ISSEL THEN
    IF I==SEL1 THEN
     VAR SELSX=SEL1X
@@ -7406,6 +7533,7 @@
   RETURN
  ENDIF
  VAR I=OTYDOC_ShowLine[D]
+ VAR SL=OTYDOC_ShowLine[D]
  VAR CL=OTYDOC_CurLine[D]
  VAR CX=OTYDOC_CX[D]
  VAR Y=2,X=2
@@ -7418,6 +7546,7 @@
  VAR ACX=-100,ACY=-100
  VAR CURSORX,CURSORY
  VAR MOVECHRPOS
+ VAR OL=0
  WHILE I
   LINE=-1
   POS=-1
@@ -7428,10 +7557,36 @@
   VAR L=LEN(V$)-1,J,C
   VAR ISNCR=LINESTYLE!=OTYDOC_CENTER&&LINESTYLE!=OTYDOC_RIGHT
   SZ=8
-  X=1
+  X=1+OTYDOC_INDENT[I]
   MOVECHRPOS=0
   VAR SY=Y
   J=0
+  VAR LINED=OTYDOC_LINEDATA[I]
+  IF LINED==OTYDOC_UORDLIST THEN
+   VAR Y8=(YSZ DIV 8)
+   X=X+5*Y8
+  ELSEIF LINED==OTYDOC_ORDLIST THEN
+   Y8=(YSZ DIV 8)
+   IF OL THEN
+    OL=OL+1
+   ELSEIF I==SL THEN
+    VAR OLS=OTYDOC_PREV[I]
+    OL=1
+    WHILE OLS
+     IF OTYDOC_LINEDATA[OLS]==OTYDOC_ORDLIST THEN
+      OL=OL+1
+      OLS=OTYDOC_PREV[OLS]
+     ELSE
+      BREAK
+     ENDIF
+    WEND
+   ELSE
+    OL=1
+   ENDIF
+   X=X+(LOG(OL,10)+1)*5*Y8+2*Y8
+  ELSE
+   OL=0
+  ENDIF
   @RETRY
   VAR SX=X
   FOR J=J TO L
@@ -7571,6 +7726,9 @@
  VOID RepaintWindow(WND)
  VOID SetCapture(WND)
 END
+COMMON DEF OTYDocRMouseDW WND,CTL,TYPE,X,Y
+ ShowContextMenu OTYDOC_MENU,WND
+END
 DEF OTYDOC_IsForward(S,LINE)
  VAR S2=S
  WHILE S&&S2
@@ -7587,12 +7745,17 @@
  ENDIF
  VAR D=OTYDOC_GetData(WND)
  VAR LINE,POS
+ VAR PAINTF
  IF Y>GetWindowHeight(WND)THEN
   OTYDOC_Scroll D,1
   OTYDOC_ScrollContent D,1
+  PAINTF=TRUE
+  VOID RepaintWindow(WND)
  ELSEIF Y<0THEN
   OTYDOC_Scroll D,-1
   OTYDOC_ScrollContent D,-1
+  PAINTF=TRUE
+  VOID RepaintWindow(WND)
  ENDIF
  OTYDOC_CLK WND,X,Y OUT LINE,POS
  IF LINE==-1THEN RETURN
@@ -7644,7 +7807,7 @@
   OTYDOC_HASSTARTSEL[D]=TRUE
   OTYDOC_HASENDSEL[D]=TRUE
  ENDIF
- VOID RepaintWindow(WND)
+ IF!PAINTF THEN VOID RepaintWindow(WND)
 END
 DEF OTYDOC_ScrollContent D,DIFF
  VAR I
@@ -7684,6 +7847,23 @@
 COMMON DEF OTYDocNotif WND,CTL,TYPE,A1,A2
  VAR D=OTYDOC_GetData(WND)
  IF!D THEN RETURN
+ IF A1==MenuNotifID()THEN
+  ON A2 GOTO @I,@COP,@CUT,@PAS,@SEL
+  @I
+  RETURN
+  @COP
+  RTECopy WND
+  RETURN
+  @CUT
+  RTECut WND
+  RETURN
+  @PAS
+  RTEPaste WND
+  RETURN
+  @SEL
+  RTESelectAll WND
+  RETURN
+ ENDIF
  IF A1==OTYDOC_SCRBAR[D]THEN
   VAR OLD=OTYDOC_SCRBARPOS[D]
   VAR DIFF=A2-OLD
@@ -8061,7 +8241,6 @@
  S$=""
  WHILE 1
   I=INSTR(I,V$,CHR$(&HB10B))
-  ?I,E
   IF I==-1THEN RETURN
   IF I>=E THEN RETURN
   IF ASC(V$[I+1])==TYPE THEN
@@ -8093,6 +8272,20 @@
   ENDIF
  WEND
 END
+DEF OTYDOC_RemoveAllStyle V$,I,E
+ VAR S$
+ VAR L=LEN(V$)-1
+ WHILE 1
+  I=INSTR(I,V$,CHR$(&HB10B))
+  IF I==-1THEN BREAK
+  IF I>=E THEN BREAK
+  REPEAT
+   VAR VI=ASC(V$[I])
+   V$[I]=""
+   DEC E
+  UNTIL VI==&HB10C
+ WEND
+END
 'D:DATA
 'S:LINE
 'S$:STYLE(B10B...B10C)
@@ -8357,6 +8550,62 @@
  OTYDOC_LINESTYLE[OTYDOC_CURLINE[D]]=OTYDOC_RIGHT
  VOID RepaintWindow(WND)
 END
+COMMON DEF RTESetHeading WND,LEVEL
+ IF LEVEL<1||LEVEL>6THEN RETURN
+ VAR D=OTYDOC_GetData(WND)
+ VAR CD=OTYDOC_CURLINE[D]
+ OTYDOC_LINEDATA[CD]=OTYDOC_HEAD1+LEVEL-1
+ VAR CX=OTYDOC_GETPOS(OTYDOC_VAL$[CD],OTYDOC_CX[D])
+ OTYDOC_RemoveStyle OTYDOC_VAL$[CD],0,LEN(OTYDOC_VAL$[CD]),2'STYLE
+ OTYDOC_RemoveStyle OTYDOC_VAL$[CD],0,LEN(OTYDOC_VAL$[CD]),1'COLOR
+ OTYDOC_RemoveStyle OTYDOC_VAL$[CD],0,LEN(OTYDOC_VAL$[CD]),0'SIZE
+ VAR FS=8
+ OTYDOC_LINESTYLE[CD]=0
+ IF LEVEL==1THEN
+  OTYDOC_LINESTYLE[CD]=OTYDOC_CENTER
+ ENDIF
+ IF LEVEL<=2THEN FS=16
+ 
+ OTYDOC_WSIZE[D]=FS
+ OTYDOC_WSIZE2[D]=FS
+ VAR FSIZ$=CHR$(&HB10B)+CHR$(0)+CHR$(FS)+CHR$(&HB10C)
+ OTYDOC_COL[D]=RGBToShort(#BLACK)
+ OTYDOC_COL2[D]=RGBToShort(#BLACK)
+ VAR COL$=CHR$(&HB10B)+CHR$(1)+CHR$(RGBToShort(#BLACK))+CHR$(&HB10C)
+ OTYDOC_STYLE[D]=1
+ OTYDOC_STYLE2[D]=1
+ VAR STY$=CHR$(&HB10B)+CHR$(2)+CHR$(1)+CHR$(&HB10C)'BOLD
+ OTYDOC_VAL$[CD]=COL$+FSIZ$+STY$+OTYDOC_VAL$[CD]
+ OTYDOC_CX[D]=OTYDOC_TOPOS(OTYDOC_VAL$[CD],CX)
+ OTYDOC_AdjustLine CD
+ VOID RepaintWindow(WND)
+END
+COMMON DEF RTESetUnorderedList WND
+ VAR D=OTYDOC_GetData(WND)
+ VAR CD=OTYDOC_CURLINE[D]
+ OTYDOC_LINEDATA[CD]=OTYDOC_UORDLIST
+ VOID RepaintWindow(WND)
+END
+COMMON DEF RTESetOrderedList WND
+ VAR D=OTYDOC_GetData(WND)
+ VAR CD=OTYDOC_CURLINE[D]
+ OTYDOC_LINEDATA[CD]=OTYDOC_ORDLIST
+ VOID RepaintWindow(WND)
+END
+COMMON DEF RTEIndent WND,SZ
+ VAR D=OTYDOC_GetData(WND)
+ VAR CD=OTYDOC_CURLINE[D]
+ INC OTYDOC_INDENT[CD],SZ
+ VOID RepaintWindow(WND)
+END
+COMMON DEF RTEClear WND
+ VAR D=OTYDOC_GetData(WND)
+ VAR CD=OTYDOC_CURLINE[D]
+ OTYDOC_INDENT[CD]=0
+ OTYDOC_LINEDATA[CD]=0
+ OTYDOC_LINESTYLE[CD]=0
+ VOID RepaintWindow(WND)
+END
 COMMON DEF RTESetFontSize WND,SIZE
  VAR D=OTYDOC_GetData(WND)
  OTYDOC_WSIZE2[D]=SIZE
@@ -8378,17 +8627,21 @@
 COMMON DEF RTESave WND,FILE$ OUT ERR
  VAR D=OTYDOC_GetData(WND)
  VAR FILE
- FileOpen FILE$ OUT FILE,ERR
+ FileOpen FILE$,FileWriteFlag() OUT FILE,ERR
  IF ERR THEN RETURN
  FileWrite FILE,"OTYDOC"+LF$() OUT ERR
  VAR F=OTYDOC_GetFirstLine(OTYDOC_ShowLine[D])
- VAR OTYDOC_FILE_LINESTYLE=1,OTYDOC_FILE_CONTENT=2
+ VAR OTYDOC_FILE_LINESTYLE=1,OTYDOC_FILE_CONTENT=2,OTYDOC_FILE_LINEDATA=3,OTYDOC_FILE_INDENT=4
  WHILE F
   VAR LS$=CHR$(OTYDOC_FILE_LINESTYLE)+CHR$(1)+CHR$(OTYDOC_LINESTYLE[F])
+  VAR LD$=CHR$(OTYDOC_FILE_LINEDATA)+CHR$(1)+CHR$(OTYDOC_LINEDATA[F])
+  VAR LI$=CHR$(OTYDOC_FILE_INDENT)+CHR$(1)+CHR$(OTYDOC_INDENT[F])
   VAR LC$=CHR$(OTYDOC_FILE_CONTENT)+CHR$(LEN(OTYDOC_VAL$[F]))+OTYDOC_VAL$[F]
 
   FileWrite FILE,LC$ OUT ERR
   FileWrite FILE,LS$ OUT ERR
+  FileWrite FILE,LD$ OUT ERR
+  FileWrite FILE,LI$ OUT ERR
   F=OTYDOC_NEXT[F]
  WEND
  FileClose FILE OUT ERR
@@ -8418,7 +8671,7 @@
  VAR I=LEN("OTYDOC")+1
  RTENew WND
  VAR LINE=OTYDOC_ShowLine[D]
- VAR OTYDOC_FILE_LINESTYLE=1,OTYDOC_FILE_CONTENT=2
+ VAR OTYDOC_FILE_LINESTYLE=1,OTYDOC_FILE_CONTENT=2,OTYDOC_FILE_LINEDATA=3,OTYDOC_FILE_INDENT=4
  VAR L=LEN(F$)-1
  VAR LC
  FOR I=I TO L
@@ -8429,6 +8682,12 @@
   IF C==OTYDOC_FILE_LINESTYLE THEN
    VAR V=ASC(F$[I+2])
    OTYDOC_LINESTYLE[LINE]=V
+  ELSEIF C==OTYDOC_FILE_LINEDATA THEN
+   V=ASC(F$[I+2])
+   OTYDOC_LINEDATA[LINE]=V
+  ELSEIF C==OTYDOC_FILE_INDENT THEN
+   V=ASC(F$[I+2])
+   OTYDOC_INDENT[LINE]=V
   ELSEIF C==OTYDOC_FILE_CONTENT THEN
    LINE=OTYDOC_NewLine(MID$(F$,I+2,CL),LINE)
    INC LC
@@ -8442,6 +8701,193 @@
   OTYDOC_SetLine D,LC-1
  ENDIF
 END
+DEF OTYDOC_PlainText F,S,E,O$
+ VAR L$=MID$(OTYDOC_VAL$[F],S,E-S)
+ VAR TYPE:FOR TYPE=0TO 2
+  OTYDOC_RemoveAllStyle L$,0,LEN(L$)
+ NEXT
+ PUSH O$,L$+LF$()
+END
+DEF OTYDOC_Serialize F,S,E,O$
+ VAR OTYDOC_FILE_LINESTYLE=1,OTYDOC_FILE_CONTENT=2,OTYDOC_FILE_LINEDATA=3,OTYDOC_FILE_INDENT=4
+ VAR L$=""
+ 
+ VAR S$,TYPE
+ FOR TYPE=0TO 2
+  OTYDOC_GetStyle OTYDOC_VAL$[F],0,S,TYPE OUT S$
+  PUSH L$,S$
+ NEXT
+ PUSH L$,MID$(OTYDOC_VAL$[F],S,E-S)
+ VAR LS$=CHR$(OTYDOC_FILE_LINESTYLE)+CHR$(1)+CHR$(OTYDOC_LINESTYLE[F])
+ VAR LD$=CHR$(OTYDOC_FILE_LINEDATA)+CHR$(1)+CHR$(OTYDOC_LINEDATA[F])
+ VAR LI$=CHR$(OTYDOC_FILE_INDENT)+CHR$(1)+CHR$(OTYDOC_INDENT[F])
+ VAR LC$=CHR$(OTYDOC_FILE_CONTENT)+CHR$(LEN(L$))+L$
+ PUSH O$,LC$
+ PUSH O$,LS$
+ PUSH O$,LD$
+ PUSH O$,LI$
+END
+DEF OTYDOC_PastePlainText WND,TXT$
+ VAR D=OTYDOC_GetData(WND)
+ VAR C=OTYDOC_CurLine[D]
+ VAR I,J,LF$=LF$()
+ VAR LST$=MID$(OTYDOC_VAL$[C],OTYDOC_CX[D],LEN(OTYDOC_VAL$[C]))
+ VAR F$=LEFT$(OTYDOC_VAL$[C],OTYDOC_CX[D])
+ VAR S$,TYPE,ST$
+ FOR TYPE=0TO 2
+  OTYDOC_GetStyle F$,0,LEN(F$),TYPE OUT S$
+  PUSH ST$,S$
+ NEXT
+ PUSH LST$,ST$
+ TXT$=TXT$+LST$
+ OTYDOC_VAL$[C]=F$
+ WHILE 1
+  I=INSTR(I,TXT$,LF$)
+  IF I==-1THEN
+   VAR T$=MID$(TXT$,J,LEN(TXT$))
+  ELSE
+   T$=MID$(TXT$,J,I-J)
+  ENDIF
+  IF J==0THEN
+   PUSH OTYDOC_VAL$[C],T$
+  ELSE
+   C=OTYDOC_NewLine(ST$+T$,C)
+  ENDIF
+  IF I==-1THEN BREAK
+  I=I+1
+  J=I
+ WEND
+ VOID RepaintWindow(WND)
+END
+COMMON DEF RTEPaste WND
+ VAR D=OTYDOC_GetData(WND)
+ IF OTYDOC_ISSEL[D]THEN
+  OTYDOC_RemoveSelected D OUT OTYDOC_CX[D],OTYDOC_CurLine[D]
+  OTYDOC_ISSEL[D]=0
+ ENDIF
+ VAR D$,CNTNS
+ ClipboardGetData$ "RichText" OUT D$,CNTNS
+ IF!CNTNS THEN
+  IF!ClipboardContainsText()THEN RETURN
+  OTYDOC_PastePlainText WND,ClipboardGetText$()
+  RETURN
+ ENDIF
+ VAR C=OTYDOC_CurLine[D]
+ VAR I,J
+ VAR LST$=MID$(OTYDOC_VAL$[C],OTYDOC_CX[D],LEN(OTYDOC_VAL$[C]))
+ VAR F$=LEFT$(OTYDOC_VAL$[C],OTYDOC_CX[D])
+ VAR S$,TYPE,ST$
+ FOR TYPE=0TO 2
+  OTYDOC_GetStyle F$,0,LEN(F$),TYPE OUT S$
+  PUSH ST$,S$
+ NEXT
+ LST$=ST$+LST$
+ OTYDOC_VAL$[C]=F$
+
+ VAR OTYDOC_FILE_LINESTYLE=1,OTYDOC_FILE_CONTENT=2,OTYDOC_FILE_LINEDATA=3,OTYDOC_FILE_INDENT=4
+ VAR L=LEN(D$)-1
+ VAR LC
+ VAR LINE=C
+ VAR FL=C
+ VAR FIRSTLINE=TRUE
+ FOR I=I TO L
+      C=ASC(D$[I])
+  IF I+1>L THEN BREAK
+  VAR CL=ASC(D$[I+1])
+  IF I+1+CL>L THEN BREAK
+  IF LINE!=FL THEN
+   IF C==OTYDOC_FILE_LINESTYLE THEN
+    VAR V=ASC(D$[I+2])
+    OTYDOC_LINESTYLE[LINE]=V
+   ELSEIF C==OTYDOC_FILE_LINEDATA THEN
+    V=ASC(D$[I+2])
+    OTYDOC_LINEDATA[LINE]=V
+   ELSEIF C==OTYDOC_FILE_INDENT THEN
+    V=ASC(D$[I+2])
+    OTYDOC_INDENT[LINE]=V
+   ENDIF
+  ENDIF
+  IF!FIRSTLINE&&C==OTYDOC_FILE_CONTENT THEN
+    LINE=OTYDOC_NewLine(MID$(D$,I+2,CL),LINE)
+    INC LC
+    OTYDOC_AdjustLine LINE
+  ELSEIF C==OTYDOC_FILE_CONTENT THEN
+   PUSH OTYDOC_VAL$[LINE],MID$(D$,I+2,CL)
+   OTYDOC_AdjustLine LINE
+   FIRSTLINE=FALSE
+  ENDIF
+  I=I+CL+1
+ NEXT
+ PUSH OTYDOC_VAL$[LINE],LST$
+ OTYDOC_AddLine D,LC
+ VOID RepaintWindow(WND)
+END
+COMMON DEF RTESelectAll WND
+ VAR D=OTYDOC_GetData(WND)
+ OTYDOC_ISSEL[D]=TRUE
+ OTYDOC_SEL1X[D]=0
+ OTYDOC_SEL1[D]=OTYDOC_GetFirstLine(OTYDOC_ShowLine[D])
+ VAR L=OTYDOC_ShowLine[D]
+ WHILE L
+  VAR OL=L
+  L=OTYDOC_NEXT[L]
+ WEND
+ OTYDOC_SEL2X[D]=LEN(OTYDOC_VAL$[OL])
+ OTYDOC_SEL2[D]=OL
+ OTYDOC_HASSTARTSEL[D]=FALSE
+ OTYDOC_HASENDSEL[D]=TRUE
+ VOID RepaintWindow(WND)
+END
+COMMON DEF RTECut WND
+ VAR D=OTYDOC_GetData(WND)
+ IF OTYDOC_ISSEL[D]THEN
+  RTECopy WND
+  OTYDOC_RemoveSelected D OUT OTYDOC_CX[D],OTYDOC_CurLine[D]
+  OTYDOC_ISSEL[D]=0
+ ENDIF
+END
+COMMON DEF RTECopy WND
+ VAR D=OTYDOC_GetData(WND)
+ IF!OTYDOC_ISSEL[D] THEN
+  RETURN
+ ENDIF
+ VAR CX=OTYDOC_CX[D]
+ VAR CL=OTYDOC_CurLine[D]
+ VAR SL=OTYDOC_ShowLine[D]
+ VAR S=OTYDOC_SEL1[D]
+ VAR E=OTYDOC_SEL2[D]
+ VAR SX=OTYDOC_SEL1X[D]
+ VAR EX=OTYDOC_SEL2X[D]
+ VAR O$=""
+ VAR P$=""
+ ClearClipboard
+ IF S==E THEN
+  OTYDOC_PlainText S,SX,EX,P$
+  OTYDOC_SERIALIZE S,SX,EX,O$
+  ClipboardSetData$ "RichText",O$
+  ClipboardSetText P$
+  RETURN
+ ENDIF
+ VAR _
+ OTYDOC_SERIALIZE S,SX,LEN(OTYDOC_VAL$[S]),O$
+ OTYDOC_PlainText S,SX,LEN(OTYDOC_VAL$[S]),P$
+ S=OTYDOC_NEXT[S]
+ WHILE 1
+  VAR NXT=OTYDOC_NEXT[S]
+  IF S==E THEN
+   VAR S2=OTYDOC_SEL1[D]
+   OTYDOC_SERIALIZE S,0,EX,O$
+   OTYDOC_PlainText S,0,EX,P$
+   BREAK
+  ENDIF
+  OTYDOC_SERIALIZE S,0,LEN(OTYDOC_VAL$[S]),O$
+  OTYDOC_PlainText S,0,LEN(OTYDOC_VAL$[S]),P$
+  S=NXT
+ WEND
+ ClipboardSetData$ "RichText",O$
+ ClipboardSetText P$
+END
+
 '==================
 VAR OTYDOCCOLOR_CTL
 VAR OTYDOC_MENU_NEW=1
@@ -8488,6 +8934,14 @@
   VAR X=GetWindowX(WND)+GetWindowX(CW),Y=GetWindowY(WND)+GetWindowY(CW)
   OTYDOC_ShowMenu OTYDOCCOLOR_CTL,WND,X,Y,X+GetWindowWidth(CW),Y+GetWindowHeight(CW)
  ENDIF
+ IF N$==""THEN
+  RTEIndent GetWindowVar(WND,0),8
+  RETURN
+ ENDIF
+ IF N$==""THEN
+  RTEIndent GetWindowVar(WND,0),-8
+  RETURN
+ ENDIF
  IF N$=="OTYDOCCOLOR"THEN
   RTESetTextColor GetWindowVar(WND,0),F
   VOID DeleteWindow(CW)
@@ -8517,14 +8971,30 @@
   ENDIF
 '  UnCheckButtonsGroup CW
  ENDIF
- IF GetControl(CW)==GetNumUpDownControl()THEN
+ IF IsControlExtend(GetControl(CW),GetNumUpDownControl())THEN
   RTESetFontSize GetWindowVar(WND,0),GetNumUpDownValue(CW)*8
  ENDIF
+ IF IsControlExtend(GetControl(CW),GetListBoxControl())THEN
+  VAR C$=GetListBoxSelectedText$(CW)
+  IF LEN(C$)>1&&C$[0]=="H"THEN
+   VAR LEVEL=ASC(C$[1])-ASC("0")
+   RTESetHeading GetWindowVar(WND,0),LEVEL
+  ENDIF
+  IF C$=="  xxx"THEN
+   RTESetUnorderedList GetWindowVar(WND,0)
+  ENDIF
+  IF C$=="1. xxx"THEN
+   RTESetOrderedList GetWindowVar(WND,0)
+  ENDIF
+  IF C$=="clear"THEN
+   RTEClear GetWindowVar(WND,0)
+  ENDIF
+ ENDIF
 END
 COMMON DEF OTYDOC_WNDRESIZE WND,CTL,TYPE,A1,A2
  VAR W=GetWindowWidth(WND)
  VAR H=GetWindowHeight(WND)
- VOID ResizeWindow(GetWindowVar(WND,0),W,H-12)
+ VOID ResizeWindow(GetWindowVar(WND,0),W,H-12-12)
 END
 '2PX
 '
@@ -8649,7 +9119,7 @@
   E=SetControlPainter(OTYDOCLCRBTN_CTL,"OTYDOC_LCRPAINT")
   E=SetControlLMouseDownHandler(OTYDOCLCRBTN_CTL,"OTYDOC_LCRMouseDown")
  ENDIF
- NewTopLevelStyleWindow OTYDOC_WNDCTL,"Document",256,128,WindowMenuStyle() OR WindowResizableStyle()OR WindowMinMaxStyle() OUT WND,E
+ NewTopLevelStyleWindow OTYDOC_WNDCTL,"Document",256+8,128,WindowMenuStyle() OR WindowResizableStyle()OR WindowMinMaxStyle() OUT WND,E
  VAR MENU
  NewMenu OUT MENU,E
  OTYDOC_MENU_NEW=1
@@ -8662,7 +9132,7 @@
  AddMenuItem MENU,"Save as",4
  AddSubMenuItem GetWindowMenu(WND),"File",MENU SetProcessVar WND
  VAR DOC,COL
- NewWindow OTYDOCCTL,"OTYDOC",0,12,256,116,WND,0 OUT DOC,E
+ NewWindow OTYDOCCTL,"OTYDOC",0,12+12,256+8,116-12,WND,0 OUT DOC,E
  SetWindowVar WND,0,DOC
  NewWindow GetToggleButtonControl(),"B",0,0,11,11,WND,0 OUT E,E
  NewWindow GetToggleButtonControl(),"I",12*1,0,11,11,WND,0 OUT E,E
@@ -8690,10 +9160,12 @@
  AddListBoxItem LST,"H1"
  AddListBoxItem LST,"H2"
  AddListBoxItem LST,"H3"
- AddListBoxItem LST,"H4"
- AddListBoxItem LST," xxx"
+ AddListBoxItem LST,"  xxx"
  AddListBoxItem LST,"1. xxx"
- AddListBoxItem LST,"'quote'"
+ AddListBoxItem LST,"clear"
+ AddListBoxItem LST,"H4"
+ AddListBoxItem LST,"H5"
+ AddListBoxItem LST,"H6"
  INC X,56
  SetWindowVar WND,1,BTNL
  SetWindowVar WND,2,BTNC
@@ -8701,6 +9173,8 @@
  SetWindowVar BTNL,7,0
  SetWindowVar BTNC,7,1
  SetWindowVar BTNR,7,2
+ NewWindow GetButtonControl(),"",0,12,11,11,WND,0 OUT E,E
+ NewWindow GetButtonControl(),"",12,12,11,11,WND,0 OUT E,E
  'TODO:GROUPのかくちょう
 'E=JoinWindowGroup(BTNL,BTNC)
 'E=JoinWindowGroup(BTNL,BTNR)
@@ -11544,6 +12018,7 @@
 VAR ODE_CTL
 VAR ODE_WV_FILES
 VAR ODE_WV_CURRENT
+VAR ODE_WV_ICONS
 VAR ODE_IW
 VAR ODE_IH
 VAR ODE_IX
@@ -11563,6 +12038,7 @@
  IF 0 THEN DIM DIR$[0]
  VAR ARY=GetWindowVar(WND,ODE_WV_FILES)
  DIR$=GetSBArray(ARY)
+ IF I>=LEN(DIR$)THEN RETURN
  VAR F$=DIR$[I]
  F$=MID$(F$,1,LEN(F$))
  F$=CombinePath$(CombinePath$(GetHomeDir$(),"desktop"),F$)
@@ -11599,8 +12075,10 @@
  IF GBeginDirect(WND)THEN @END
  GCLS RGB(0,128,128)
  IF 0 THEN DIM DIR$[0]
+ IF 0 THEN DIM ICON[0]
  VAR ARY=GetWindowVar(WND,ODE_WV_FILES)
  DIR$=GetSBArray(ARY)
+ ICON=GetSBArray(GetWindowVar(WND,ODE_WV_ICONS))
  VAR I,L=LEN(DIR$)-1
  VAR IX=ODE_IX,IY=ODE_IY
  VAR IW=ODE_IW
@@ -11618,13 +12096,7 @@
    GFILL IX,IY+16,IX+IW-1,IY+IH-1,GetSelectionColor()
    TC=GetSelectionTextColor()
   ENDIF
-  IF D$[0]=="*"THEN
-   GLOAD IX+ICONSX,IY,16,16,OTYFILICOTXT,1,0
-  ELSEIF D$[0]=="/"THEN
-   GLOAD IX+ICONSX,IY,16,16,OTYFILICODIR,1,0
-  ELSEIF D$[0]==" "THEN
-   GLOAD IX+ICONSX,IY,16,16,OTYFILICODAT,1,0
-  ENDIF
+  GLOADImage IX+ICONSX,IY,ICON[I],FALSE
   GPUTCHR IX+(IW-MIN(ITW,LEN(NAME$))*8)DIV 2,IY+16,MID$(NAME$,0,ITW),TC
   IF LEN(NAME$)>ITW THEN
    GPUTCHR IX+(IW-MIN(ITW,LEN(NAME$)-ITW)*8)DIV 2,IY+24,MID$(NAME$,ITW,ITW),TC
@@ -11640,12 +12112,47 @@
  @END
  IF GEndWindow(WND)THEN RETURN
 END
+COMMON DEF ODE_DEL WND,CTL,TYP,A1,A2
+ FreeSBArray GetWindowVar(WND,ODE_WV_FILES)
+ FreeSBArray GetWindowVar(WND,ODE_WV_ICONS)
+END
+VAR ODE_IMAGE_TXT
+VAR ODE_IMAGE_DAT
+VAR ODE_IMAGE_DIR
 DEF ODE_UPDATEFILES WND
  VAR ERR
  IF 0 THEN DIM DIR$[0]
- GetFiles CombinePath$(GetHomeDir$(),"desktop/") OUT DIR$,ERR
+ VAR D$=CombinePath$(GetHomeDir$(),"desktop/")
+ GetFiles D$ OUT DIR$,ERR
  VAR ARY=GetWindowVar(WND,ODE_WV_FILES)
  SetSBArray ARY,DIR$
+ DIM ICONS[LEN(DIR$)]
+ VAR I
+ FOR I=0TO LEN(DIR$)-1
+  ICONS[I]=ODE_IMAGE_TXT
+  
+  IF ToUpper$(GetFileExtension$(DIR$[I]))=="LNK"THEN
+   VAR F$
+   LoadFile CombinePath$(D$,MID$(DIR$[I],1,LEN(DIR$[I]))) OUT F$,ERR
+   IF ERR THEN CONTINUE
+   IF 0THEN DIM K$[0],V$[0]
+   LoadConfigFile F$ OUT K$,V$
+   VAR I16=FindArray(K$,"icon16")
+   IF I16==-1THEN CONTINUE
+   VAR IMG
+   LoadImage V$[I16],16,16 OUT IMG,ERR
+   IF ERR THEN CONTINUE
+   ICONS[I]=IMG
+  ELSEIF DIR$[I][0]=="*"THEN
+   ICONS[I]=ODE_IMAGE_TXT
+  ELSEIF DIR$[I][0]=="/"THEN
+   ICONS[I]=ODE_IMAGE_DIR
+  ELSEIF DIR$[I][0]==" "THEN
+   ICONS[I]=ODE_IMAGE_DAT
+  ENDIF
+ NEXT
+ ARY=GetWindowVar(WND,ODE_WV_ICONS)
+ SetSBArray ARY,ICONS
 END
 COMMON DEF I_ODE
  IF!CHKCALL("IsWinRunning")||!IsWinRunning()THEN
@@ -11656,12 +12163,17 @@
  VAR WND,E
  IF!ODE_CTL THEN
   RC_OTYFIL
+  NewImage OTYFILICOTXT,16,16 OUT ODE_IMAGE_TXT,E
+  NewImage OTYFILICODAT,16,16 OUT ODE_IMAGE_DAT,E
+  NewImage OTYFILICODIR,16,16 OUT ODE_IMAGE_DIR,E
   NewControl "otya desktop environment" OUT ODE_CTL,E
   E=SetControlPainter(ODE_CTL,"ODE_PAINTER")
   E=SetControlLMouseDownHandler(ODE_CTL,"ODE_LMD")
   E=SetControlLDoubleClickHandler(ODE_CTL,"ODE_LDC")
+  E=SetControlDeleteHandler(ODE_CTL,"ODE_DEL")
   ODE_WV_FILES=0
   ODE_WV_CURRENT=1
+  ODE_WV_ICONS=2
   ODE_IW=48
   ODE_IH=44
   ODE_IX=8
@@ -11671,6 +12183,7 @@
  NewWindow ODE_CTL,"",0,0,GetWindowWidth(RWND),GetWindowHeight(RWND),RWND,WindowBackFlag() OUT WND,E
  SetWindowVar WND,ODE_WV_FILES,AllocSBArray()
  SetWindowVar WND,ODE_WV_CURRENT,-1
+ SetWindowVar WND,ODE_WV_ICONS,AllocSBArray()
  ODE_UPDATEFILES WND
  SetProcessVar WND
  NewProcess "TSKBAR","" OUT E,E
