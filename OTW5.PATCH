diff -u OTW.TXT OTW5
--- OTW.TXT
+++ OTW5
@@ -90,11 +90,12 @@
 '=======================
 VAR CTL_MAX
 VAR CTL_HANDLER_MAX
-DIM CTL_NAME$   [0]
-DIM CTL_CID     [0]
-DIM CTL_REF     [0]
-DIM CTL_NEXT    [0]
-DIM CTL_HANDLER$[0,0]
+DIM CTL_NAME$    [0]
+DIM CTL_CID      [0]
+DIM CTL_REF      [0]
+DIM CTL_NEXT     [0]
+DIM CTL_PARENTCTL[0]
+DIM CTL_HANDLER$ [0,0]
 VAR CTL_FREE
 VAR CTL_CIDCNT
 VAR CTL_PAINTHANDLER
@@ -105,6 +106,7 @@
  CTL_NAME$     =NewArray$(CTL_MAX)
  CTL_CID       =NewArray(CTL_MAX)
  CTL_NEXT      =NewArray(CTL_MAX)
+ CTL_PARENTCTL =NewArray(CTL_MAX)
  CTL_HANDLER$  =NewArray2$(CTL_MAX,CTL_HANDLER_MAX)
  CTL_FREE=1
  OTW_INITLIST CTL_NEXT
@@ -144,9 +146,25 @@
  INC CTL_CIDCNT
  ERR=0
  CTL=CIDNUCIDToCTL(CTL_FREE,CTL_CIDCNT)
- CTL_NEXT[CTL AND 4095]=0
  CTL_FREE=CTL_NEXT[CTL_FREE]
+ CTL_CID[CTL AND 4095]=CTL_CIDCNT
+ CTL_NEXT[CTL AND 4095]=0
 END
+COMMON DEF ExtendControl NAME$,PARENT OUT CTL,ERR
+ IF!CheckControl(PARENT)THEN
+  CTL=0
+  ERR=CTL_INVALIDID
+  RETURN
+ ENDIF
+ NewControl NAME$ OUT CTL,ERR
+ IF ERR THEN RETURN
+ VAR NUCID=CTL AND 4095
+ CTL_PARENTCTL[NUCID]=PARENT
+ VAR I,P=PARENT AND 4095
+ FOR I=0TO CTL_HANDLER_MAX-1
+  CTL_HANDLER$[NUCID,I]=CTL_HANDLER$[P,I]
+ NEXT
+END
 COMMON DEF CheckControl(CTL)
  RETURN CTL_CID[CTL AND 4095]==CTL>>12
 END
@@ -181,7 +199,9 @@
 COMMON DEF CheckWindow(WND)
  RETURN WIN_WID[WND AND NUWIDMASK]==WND>>WIDSHIFT
 END
-COMMON DEF NewRootWindow CTL,NAME$,WIDTH,HEIGHT OUT WND,ERR
+VAR WIN_TopLevelX
+VAR WIN_TopLevelY
+COMMON DEF NewTopLevelWindow CTL,NAME$,WIDTH,HEIGHT OUT WND,ERR
  IF!CheckControl(CTL)THEN
   WND=0
   ERR=CTL_INVALIDID
@@ -205,17 +225,20 @@
  WIN_X[NUWID]=0
  WIN_Y[NUWID]=0
  
- WIN_AX[NUWID]=0
- WIN_AY[NUWID]=0
+ WIN_AX[NUWID]=WIN_TopLevelX
+ WIN_AY[NUWID]=WIN_TOPLEVELY
  '
  WIN_WIDTH[NUWID]=WIDTH
  WIN_HEIGHT[NUWID]=WIDTH
  VOID RepaintWindow(WND)
  IF!WIN_ROOTWND THEN WIN_NEXT[NUWID]=0RETURN
  VAR C=WIN_CHILD[WIN_ROOTWND AND NUWIDMASK]
+ WIN_PARENT[NUWID]=WIN_ROOTWND  AND NUWIDMASK
  WIN_CHILD[WIN_ROOTWND AND NUWIDMASK]=NUWID
  WIN_NEXT[NUWID]=C
  WIN_PREV[C]=NUWID
+ WIN_TopLevelX=WIN_TopLevelX+8
+ WIN_TopLevelY=WIN_TopLevelY+8
 END
 COMMON DEF SendWindowEvent(WND,TYPE,A1,A2)
  IF!CheckWindow(WND)THEN RETURN WIN_INVALIDID
@@ -235,9 +258,9 @@
  IF!CheckWindow(WND)THEN RETURN WIN_INVALIDID
  VAR NUWID=WND AND NUWIDMASK
  IF WIN_MSGS[NUWID]==WIN_MSGE[NUWID]THEN RETURN 0
- ?"A"
  VAR NUCID=WIN_CTL[NUWID] AND 4095
  VAR S=WIN_MSGS[NUWID]
+ ?CTL_HANDLER$[NUCID,WIN_MSGBUF[NUWID,S,0]]
  CALL CTL_HANDLER$[NUCID,WIN_MSGBUF[NUWID,S,0]],WND,WIN_MSGBUF[NUWID,S,1],WIN_MSGBUF[NUWID,S,2]
  INC WIN_MSGE[NUWID]
  IF WIN_MSGE[NUWID]>=WIN_MSGMAX THEN WIN_MSGE[NUWID]=0
@@ -254,7 +277,8 @@
  VAR W=WIN_WIDTH[NUWID]
  VAR H=WIN_HEIGHT[NUWID]
  GPAGE OTW_DP,OTW_BP
- GCLIP 1,AX,AY,AX+W,AY+H
+ GCLIP 1,0,0,W,H
+ GCLS
  RETURN 0
 END
 COMMON DEF GENDWindow(WND)
@@ -262,23 +286,39 @@
  VAR NUWID=WND AND NUWIDMASK
  IF!WIN_BEGIN[NUWID]THEN RETURN WIN_EVENTERR
  'ごうせい
- VAR PNUWID=WIN_NEXT[NUWID]
+ WIN_PARENT[0]=0
+ WIN_NEXT[0]=0
+ VAR AX=WIN_AX[NUWID]
+ VAR AY=WIN_AY[NUWID]
+ VAR W=WIN_WIDTH[NUWID]
+ VAR H=WIN_HEIGHT[NUWID]
+ VAR PNUWID
+ IF WIN_CHILD[NUWID]THEN
+  PNUWID=WIN_CHILD[NUWID]
+  WHILE PNUWID
+   GCOPY OTW_DP,WIN_AX[PNUWID]+AX,WIN_AY[PNUWID]+AY,WIN_AX[PNUWID]+WIN_WIDTH[PNUWID],WIN_AY[PNUWID]+WIN_HEIGHT[PNUWID],0,0,0  
+   PNUWID=WIN_NEXT[PNUWID]
+  WEND
+ ENDIF
+ VAR _NUWID=NUWID
+ PNUWID=WIN_NEXT[NUWID]
  WHILE TRUE
   IF!PNUWID THEN
-   PNUWID=WIN_PARENT[PNUWID]
+   PNUWID=WIN_PARENT[_NUWID]
    IF!PNUWID THEN BREAK
+   _NUWID=PNUWID
    PNUWID=WIN_NEXT[PNUWID]
    CONTINUE
   ENDIF
-  GCOPY OTW_DP,WIN_AX[PNUWID],WIN_AY[PNUWID],WIN_AX[PNUWID]+WIN_WIDTH[PNUWID],WIN_AY[PNUWID]+WIN_HEIGHT[PNUWID],0,0,0
+  GCOPY OTW_DP,WIN_AX[PNUWID]+AX,WIN_AY[PNUWID]+AY,WIN_AX[PNUWID]+WIN_WIDTH[PNUWID],WIN_AY[PNUWID]+WIN_HEIGHT[PNUWID],0,0,0
+  _NUWID=PNUWID
   PNUWID=WIN_NEXT[PNUWID]
  WEND
+ GCLIP 1
  GPAGE OTW_DP,OTW_DP
- VAR AX=WIN_AX[NUWID]
- VAR AY=WIN_AY[NUWID]
- VAR W=WIN_WIDTH[NUWID]
- VAR H=WIN_HEIGHT[NUWID]
+?AX,AY,W,H
  GCOPY OTW_BP,0,0,W,H,AX,AY,0
+DIALOG "A"
  RETURN 0
 END
 COMMON DEF GPSETWindow WND,X,Y,COL
@@ -287,13 +327,25 @@
 COMMON DEF GFILLWindow WND,X,Y,X2,Y2,COL
  GFILL X,Y,X2,Y2,COL
 END
+COMMON DEF GBOXWindow WND,X,Y,X2,Y2,COL
+ GBOX X,Y,X2,Y2,COL
+END
+COMMON DEF GPRINTWindow WND,X,Y,STR$,FWIDTH,FHEIGHT
+ IF FWIDTH==8&&FHEIGHT==8THEN
+  
+ ENDIF
+END
 DEF DesktopPainter WND,A1,A2
  VAR E=GBEGINWindow(WND)
  IF E THEN RETURN
  GFILLWindow WND,0,0,32,32,RGB(255,0,0)
  E=GENDWindow(WND)
 END
+DEF WindowPainter WND,A1,A2
+END
 VAR WIN_ROOTCTL
+  VAR TSTWND,TSTCTL
+  VAR TSTWND2
 COMMON DEF I_OTW
  IF!OTW_INIT THEN
   PrintConsole "====================="+LF$()
@@ -307,7 +359,11 @@
   VAR E
   NewControl "DESKTOP" OUT WIN_ROOTCTL,E
   E=SetControlPainter(WIN_ROOTCTL,"DesktopPainter")
-  NewRootWindow WIN_ROOTCTL,"",400,240 OUT WIN_ROOTWND,E
+  NewTopLevelWindow WIN_ROOTCTL,"",400,240 OUT WIN_ROOTWND,E
+  ExtendControl "HELLO",GetWindowControl() OUT TSTCTL,E
+  NewTopLevelWindow TSTCTL,"HELLO",64,64 OUT TSTWND,E
+  NewTopLevelWindow TSTCTL,"HELLO",64,64 OUT TSTWND2,E
+  E=SetControlPainter(TSTCTL,"HELLOPainter")
   ACLS
   XSCREEN 2
   GCLS RGB(0,0,255)
@@ -322,10 +378,19 @@
  ENDIF
 RETURN
 END
+COMMON DEF HELLOPainter WND,A1,A2
+ VAR E=GBEGINWindow(WND)
+ IF E THEN RETURN
+ GFILLWindow WND,0,0,64,64,RGB(255,255,0)
+ GBOXWindow WND,0,0,64,64,RGB(128,128,128)
+ E=GENDWindow(WND)
+END
 COMMON DEF L_OTW
 ' ?OTW_INIT
  UpdateMouse
+ VOID UpdateWindow(TSTWND)
  VOID UpdateWindow(WIN_ROOTWND)
+ VOID UpdateWindow(TSTWND2)
 ' ExitProcess 1
 RETURN
 END
@@ -359,7 +424,9 @@
  SAVE"PRG1:OTW"+VER$
 END
 
-DEF OTW_FONT
+DEF OTW_LOADFONT
+' READ C$
+ 
 DATA "A"
 DATA "000F0000"
 DATA "00F0F000"
@@ -450,25 +517,152 @@
 DATA "0F00F000"
 DATA "00FF0000"
 DATA "00000000"
-DATA "B"
+DATA "K"
+DATA "0F000F00"
+DATA "0F00F000"
+DATA "0F0F0000"
+DATA "0FF00000"
+DATA "0F0F0000"
+DATA "0F00F000"
+DATA "0F000F00"
 DATA "00000000"
+DATA "L"
+DATA "0F000000"
+DATA "0F000000"
+DATA "0F000000"
+DATA "0F000000"
+DATA "0F000000"
+DATA "0F000000"
+DATA "0FFFFF00"
 DATA "00000000"
+DATA "M"
+DATA "0F000F00"
+DATA "0FF0FF00"
+DATA "0F0F0F00"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0F000F00"
 DATA "00000000"
+DATA "N"
+DATA "0F000F00"
+DATA "0FF00F00"
+DATA "0F0F0F00"
+DATA "0F00FF00"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0F000F00"
 DATA "00000000"
+DATA "O"
+DATA "00FFF000"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "00FFF000"
 DATA "00000000"
+DATA "P"
+DATA "0FFFF000"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0FFFF000"
+DATA "0F000000"
+DATA "0F000000"
+DATA "0F000000"
 DATA "00000000"
+DATA "Q"
+DATA "00FFF000"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0F0F0F00"
+DATA "0F00F000"
+DATA "00FF0F00"
 DATA "00000000"
+DATA "R"
+DATA "0FFFF000"
+DATA "0R000F00"
+DATA "0F000F00"
+DATA "0FFFF000"
+DATA "0F0F0000"
+DATA "0F00F000"
+DATA "0F000F00"
 DATA "00000000"
-DATA "B"
+DATA "S"
+DATA "00FFF000"
+DATA "0F000F00"
+DATA "0F000000"
+DATA "00FFF000"
+DATA "00000F00"
+DATA "0F000F00"
+DATA "00FFF000"
 DATA "00000000"
+DATA "T"
+DATA "0FFFFF00"
+DATA "000F0000"
+DATA "000F0000"
+DATA "000F0000"
+DATA "000F0000"
+DATA "000F0000"
+DATA "000F0000"
 DATA "00000000"
+DATA "U"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "00FFF000"
 DATA "00000000"
+DATA "V"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "00F0F000"
+DATA "00F0F000"
+DATA "000F0000"
+DATA "000F0000"
 DATA "00000000"
+DATA "W"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "0F0F0F00"
+DATA "0FF0FF00"
+DATA "0F000F00"
 DATA "00000000"
+DATA "X"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "00F0F000"
+DATA "000F0000"
+DATA "00F0F000"
+DATA "0F000F00"
+DATA "0F000F00"
 DATA "00000000"
+DATA "Y"
+DATA "0F000F00"
+DATA "0F000F00"
+DATA "00F0F000"
+DATA "000F0000"
+DATA "000F0000"
+DATA "000F0000"
+DATA "000F0000"
 DATA "00000000"
+DATA "Z"
+DATA "0FFFFF00"
+DATA "00000F00"
+DATA "0000F000"
+DATA "000F0000"
+DATA "00F00000"
+DATA "0F000000"
+DATA "0FFFFF00"
 DATA "00000000"
-DATA "B"
+DATA "END"
+DATA "a"
 DATA "00000000"
 DATA "00000000"
 DATA "00000000"
@@ -477,59 +671,5 @@
 DATA "00000000"
 DATA "00000000"
 DATA "00000000"
-DATA "B"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "B"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "B"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "B"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "B"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "B"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
-DATA "00000000"
 
 END
