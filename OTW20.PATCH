diff -u OTW.TXT OTW20
--- OTW.TXT
+++ OTW20
@@ -331,6 +331,7 @@
 VAR CTL_LABELCTL
 VAR CTL_VSCRBARCTL
 VAR CTL_NUMUPDWNCTL
+VAR CTL_DRPDWNCTL
 
 VAR CTL_LSTBOXCTL
 'CONTROL STYLE
@@ -425,6 +426,10 @@
  E=SetControlMouseMoveHandler(MENUCTL,"MenuMouseMove")
  E=SetControlLMouseUpHandler(MENUCTL,"MenuLMouseUp")
  E=SetControlChFocusHandler(MENUCTL,"MenuChFocus")
+
+ NewControl "DROPDOWNLIST" OUT CTL_DRPDWNCTL,E
+ E=SetControlPainter(CTL_DRPDWNCTL,"DropDownListPainter")
+ E=SetControlMouseMoveHandler(CTL_DRPDWNCTL,"DropDownListMouseMove")
  OTW_CTL_LIST
  PrintConsoleln "Init textbox..."
  INIT_TXTBOXEX
@@ -715,7 +720,7 @@
 END
 VAR MENU_NOALLOC
 COMMON DEF NewMenu OUT MENU,E
- IF !MENU_FREE THEN MENU=0RETURN
+ IF !MENU_FREE THEN MENU=0:E=MENU_NOALLOC:RETURN
  INC MENU_IDCNT
  E=0
  MENU_ID[MENU_FREE]=MENU_IDCNT
@@ -1613,6 +1618,26 @@
   NUWID=WIN_NEXT[NUWID]
  WEND
 END
+COMMON DEF ShowWindow(WND)
+ IF!CheckWindow(WND)THEN RETURN WIN_INVALIDID
+ VAR NUWID=WND AND NUWIDMASK
+ IF WIN_STYLE[NUWID] AND WIN_STYLE_HIDE THEN
+  WIN_HIDE[NUWID]=FALSE
+  WIN_STYLE[NUWID]=WIN_STYLE[NUWID] AND NOT WIN_STYLE_HIDE
+ ELSE
+  RETURN 0
+ ENDIF
+ RETURN RepaintWindow(WND)
+END
+COMMON DEF HideWindow(WND)
+ IF!CheckWindow(WND)THEN RETURN WIN_INVALIDID
+ VAR NUWID=WND AND NUWIDMASK
+ IF WIN_STYLE[NUWID] AND WIN_STYLE_HIDE THEN RETURN 0
+ WIN_HIDE[NUWID]=TRUE
+ WIN_STYLE[NUWID]=WIN_STYLE[NUWID] OR WIN_STYLE_HIDE
+ RepaintAllWindow GetParentWindow(WND),WIN_AX[NUWID],WIN_AY[NUWID],WIN_WIDTH[NUWID],WIN_HEIGHT[NUWID]
+ RETURN 0
+END
 COMMON DEF BeginWindowOP(WND)
  IF!CheckWindow(WND)THEN RETURN WIN_INVALIDID
  RETURN 0
@@ -1712,6 +1737,7 @@
   GFILL WIN_AX[NUWID]-MX,WIN_AY[NUWID]-MY,WIN_AX[NUWID]-MX+WIN_WIDTH[NUWID],WIN_AY[NUWID]-MY+WIN_HEIGHT[NUWID],WIN_BKGND
   GCOPY OTW_GP,WIN_AX[NUWID],WIN_AY[NUWID],WIN_AX[NUWID]+WIN_WIDTH[NUWID],WIN_AY[NUWID]+WIN_HEIGHT[NUWID],WIN_AX[NUWID],WIN_AY[NUWID],0
   OTW_SPCHR NUWID
+  OTW_DrawMap WIN_PARENT[NUWID]
  ENDIF
  OTW_DrawMap WIN_PARENT[NUWID]
  '   B=WIN_CHILD[NXT]
@@ -2354,6 +2380,9 @@
  VAR I
  GLOAD X,Y,8,8,OTW_FNTTMP,OTW_FNTPAL,0
 END
+COMMON DEF GetBackColor()
+ RETURN WIN_BKGND
+END
 DEF DesktopPainter WND,CTL,TYPE,A1,A2
 RETURN
  VAR E=GBEGINWindow(WND)
@@ -2700,6 +2729,10 @@
 DEF ButtonPainter W,C,T,A1,A2
  VAR E=GBeginWindow(W)
  IF E THEN RETURN
+ '2:LEFT
+ '1:RIGHT
+ '0:CENTER
+ VAR ALIGN=GetWindowVar(W,2)
  VAR TG=GetWindowVar(W,1)
  VAR HE=GetWindowHeight(W)
  VAR WI=GetWindowWidth(W)
@@ -2708,7 +2741,18 @@
  VAR B2=-1
  IF TG THEN SWAP B1,B2
  GFILLWindow W,0,0,WI,HE,RGB(192,192,192)
- GPRINTWindow W,(WI-GetTextWidth(NA$))/2+TG+1,(HE-6)/2+TG,NA$,RGB(0,0,0)
+ VAR TX
+ ON ALIGN GOTO @CENTER,@RIGHT,@LEFT,@DEFAULT
+ @CENTER
+ TX=(WI-GetTextWidth(NA$))/2+TG+1
+ GOTO @DEFAULT
+ @RIGHT
+ TX=WI-GetTextWidth(NA$)+TG-1
+ GOTO @DEFAULT
+ @LEFT
+ TX=TG+1
+ @DEFAULT
+ GPRINTWindow W,TX,(HE-6)/2+TG,NA$,RGB(0,0,0)
  GBOXWindow W,0,0,WI,HE,B1
  GLINEWindow W,0,0,0,HE-1,B2
  GLINEWindow W,0,0,WI-1,0,B2
@@ -2741,6 +2785,18 @@
  VOID RepaintWindow(W)
 'ButtonPainter W,C,T,0,0
 END
+COMMON DEF SetButtonAlignLeft WND
+ SetWindowVar WND,2,2
+ VAR E=RepaintWindow(WND)
+END
+COMMON DEF SetButtonAlignRight WND
+ SetWindowVar WND,2,1
+ VAR E=RepaintWindow(WND)
+END
+COMMON DEF SetButtonAlignCenter WND
+ SetWindowVar WND,2,0
+ VAR E=RepaintWindow(WND)
+END
 'PlainTextBox
 COMMON DEF SetTextBoxOwnerDraw WND,FLG
  SetWindowVar WND,7,FLG
@@ -4153,7 +4209,7 @@
   ExitProcess 1
   RETURN
  ENDIF
- VAR PTR=malloc(64*64)
+ VAR PTR=RND(256)+1'malloc(64*64)
  IF!PTR THEN BEEP:ExitProcess 1RETURN
  VAR WND,E
  IF!PAINTCTL THEN
@@ -5017,23 +5073,30 @@
 'FONT SIZE と LINE SIZE あわせる(かいぎょうよう)
 DEF OTYDOC_AdjustLine L
  VAR V$=OTYDOC_VAL$[L]
- ?"OTYDOC_AdjustLine",L,V$
+ '?"OTYDOC_AdjustLine",L,V$
  VAR I
  VAR HASTEXT
- IF LEN(V$)THEN VAR C=ASC(V$[I])
+ IF LEN(V$)THEN VAR C=-1'ASC(V$[I])
  VAR YSZ=8
  FOR I=0TO LEN(V$)-1
+  IF C==-1 THEN C=ASC(V$[I])CONTINUE
   IF C==&HB10BTHEN
    C=ASC(V$[I])
    IF C==0THEN
     INC I
     VAR YSZ2=ASC(V$[I])
-    ?"L,YSZ2,YSZ",L,YSZ2,YSZ
+    '?"L,YSZ2,YSZ",L,YSZ2,YSZ
     'ひどいいれこ
     'FONTSIZEしていのあと もじがないか うわがきされてたら むこう
     IF YSZ<YSZ2 THEN
      FOR I=I+1 TO LEN(V$)
-      IF I<LEN(V$)THEN C=ASC(V$[I])ELSE C=0
+      IF I<LEN(V$)THEN C=ASC(V$[I])ELSE
+       IF HASTEXT THEN
+        '?"EEEEEEEEEE"
+        BREAK
+       ENDIF
+       C=0
+      ENDIF
       IF C==&HB10C THEN CONTINUE
       IF C==&HB10BTHEN
        IF ASC(V$[I+1])==0THEN YSZ2=0BREAK
@@ -5042,16 +5105,23 @@
        NEXT
        CONTINUE
       ENDIF
-      ?CHR$(C),HEX$(C),YSZ2
+      '?CHR$(C),HEX$(C),YSZ2
       YSZ=MAX(YSZ,YSZ2)
       BREAK
      NEXT
     ENDIF
 '    YSZ=MAX(YSZ,ASC(V$[I]))
     CONTINUE
+   ELSE
+    FOR I=I TO LEN(V$)-1
+     IF ASC(V$[I])==&HB10C THEN BREAK
+    NEXT
+    INC I
+    IF I<LEN(V$)THEN C=ASC(V$[I])
+    CONTINUE
    ENDIF
   ENDIF
-  HASTEXT=TRUE
+  HASTEXT=MAX(C,1)'TRUE
   C=ASC(V$[I])
  NEXT
  OTYDOC_SIZE[L]=YSZ
@@ -5090,7 +5160,7 @@
  VAR ACX=-100,ACY=-100
  WHILE I
   VAR YSZ=OTYDOC_SIZE[I]
-?"YSZ",YSZ
+'?"YSZ",YSZ
 '?YSZ,SZ,Y
   VAR V$=OTYDOC_VAL$[I]
   VAR LINESTYLE=OTYDOC_LINESTYLE[I]
@@ -5241,7 +5311,7 @@
    IF A==&HB10CTHEN BREAK
   NEXT
   IF CX<LEN(V$)&&ASC(V$[CX])==&HB10BTHEN @LOOP21
-  ?S0,S1,S2
+  '?S0,S1,S2
   IF S2||S1||S0 THEN
    OTYDOC_DeleteDup V$,OC,CX,S0,S1,S2 OUT CX
   ENDIF
@@ -5250,7 +5320,7 @@
 END
 DEF OTYDOC_DeleteDup V$,OC,CX,S0,S1,S2 OUT CX2
  VAR I
- VAR A=ASC(V$[I])
+ VAR A=ASC(V$[OC])
  FOR I=OC+1 TO CX
   IF LEN(V$)<=I THEN BREAK
   IF A==&HB10B THEN
@@ -5272,6 +5342,7 @@
     IF A==&HB10C THEN BREAK
    WEND
   ENDIF
+  IF LEN(V$)<=I THEN BREAK
   A=ASC(V$[I])
   'IF A==&HB10C THEN BREAK
  NEXT
@@ -5333,7 +5404,6 @@
     OTYDOCRepaint WND
    ENDIF
   ENDIF
-  @_M_M_M_
   U=1
  ENDIF
  IF BTN AND 8THEN
@@ -5356,7 +5426,7 @@
    NEXT
    IF CX<LEN(V$)&&ASC(V$[CX])==&HB10BTHEN @LOOP21
    IF S2||S1||S0 THEN
-    ?S0,S1,S2,OC;"-";CX
+    '?S0,S1,S2,OC;"-";CX
     OTYDOC_DeleteDup V$,OC,CX,S0,S1,S2 OUT CX
    ENDIF
    OTYDOC_CX[D]=CX
@@ -5538,7 +5608,7 @@
    TF=OTYDOC_TextCheck(OTYDOC_VAL$[C],X)
    I$=CHR$(&HB10B)+CHR$(0)+CHR$(OTYDOC_WSIZE2[D])+CHR$(&HB10C)+I$
    IF TF THEN PUSH I$,CHR$(&HB10B)+CHR$(0)+CHR$(OTYDOC_WSIZE[D])+CHR$(&HB10C)
-   ?STR$(OTYDOC_WSIZE2[D])
+   '?STR$(OTYDOC_WSIZE2[D])
    OTYDOC_WSIZE[D]=OTYDOC_WSIZE2[D]
    INC OTYDOC_CX[D],4
    IF OTYDOC_SIZE[C]<OTYDOC_WSIZE[D]THEN OTYDOC_SIZE[C]=OTYDOC_WSIZE[D]
@@ -6561,3 +6631,71 @@
  IF E THEN ExitProcess 0
 END
 
+COMMON DEF TSKBARP WND,C,T,CW,_
+ IF GBeginWindow(WND)THEN RETURN
+ GCLSWindow WND,GetBackColor()
+ VAR W=GetWindowWidth(WND)
+ VAR H=GetWindowHeight(WND)
+ GLINEWindow WND,0,0,W,0,RGB(0,0,0)
+ GLINEWindow WND,0,1,W,1,RGB(255,255,255)
+ IF GEndWindow(WND)THEN RETURN
+END
+VAR TSKBARCTL
+DIM TB_TASKLIST$[0]
+DIM TB_TASKLIST_WND[0]
+COMMON DEF I_TSKBAR
+ IF!CHKCALL("IsWinRunning")||!IsWinRunning()THEN
+  PrintConsole "Require OTW"+LF$()
+  ExitProcess 1
+  RETURN
+ ENDIF
+ VAR E
+ IF!TSKBARCTL THEN
+  NewControl "TSKBAR" OUT TSKBARCTL,E
+  E=SetControlPainter(TSKBARCTL,"TSKBARP")
+ ' E=SetControlNotificationHandler(TSKBARCTL,"TSKBARNotificationHandler")
+ ENDIF
+ VAR WND
+ VAR H=16,W=399
+ NewWindow TSKBARCTL,"TSKBAR",0,239-H,W,H,GetRootWND(),0 OUT WND,E
+ IF E THEN BEEP:ExitProcess 1
+ SetProcessVar WND
+ VAR TW
+ VAR TSKW=84,TC,TSX=24,TCM=5
+ TB_TASKLIST$=NewArray$(TCM)
+ TB_TASKLIST_WND=NewArray(TCM)
+  NewWindow GetToggleButtonControl(),"",1,3,TSX-3,11,WND,0OUT TW,E
+ FOR TC=0TO TCM-1
+  NewWindow GetToggleButtonControl(),"Task"+STR$(TC),TSKW*TC+TC*2+TSX,3,TSKW,11,WND,WindowHideFlag()OUT TW,E
+  SetButtonAlignLeft TW
+  TB_TASKLIST_WND[TC]=TW
+ NEXT
+ SetWindowVar WND,0,TW
+END
+DEF UPDATE_TSKBAR
+ VAR TSKW=84,TC,TSX=24,TCM=5
+ VAR RW=GetRootWND()
+ VAR CW=GetChildWindow(RW)
+ IF GetNextWindow(CW)THEN
+  TC=0
+  WHILE GetNextWindow(CW)
+   IF TCM<=TC THEN BREAK
+   SetWindowName TB_TASKLIST_WND[TC],GetWindowName$(CW)
+   IF ShowWindow(TB_TASKLIST_WND[TC])THEN BREAK
+   CW=GetNextWindow(CW)
+   INC TC
+  WEND
+ ENDIF
+END
+VAR TSKBAR_TIMER
+VAR TSKBAR_CWND
+COMMON DEF L_TSKBAR
+ IF TSKBAR_TIMER!=MAINCNT THEN
+  UPDATE_TSKBAR
+'  TSKBAR_CWND=OCW
+  TSKBAR_TIMER=MAINCNT DIV 100
+ ENDIF
+ VAR E=UpdateWindow(GetProcessVar())
+ IF E THEN ExitProcess 0
+END
+
