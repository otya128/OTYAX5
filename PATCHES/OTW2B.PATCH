diff -u OTW.TXT OTW2B
--- OTW.TXT
+++ OTW2B
@@ -2962,12 +2962,18 @@
  WING_SY=Y+WIN_FY[NUWID]
 END
 COMMON DEF GBeginDirect(WND)
+ IF!CheckWindow(WND)THEN RETURN
  GPAGE OTW_SP,OTW_DDRAWPAGE
  GCLIP 1
  RETURN 0
 END
-COMMON DEF GEndDirect(WND,X1,Y1,X2,Y2,X3,Y3,MODE)
- GPAGE OTW_SP,OTW_BP
+COMMON DEF GEndDirect(WND)
+ IF!CheckWindow(WND)THEN RETURN
+ VAR NUWID=WND AND NUWIDMASK
+ WIN_BEGIN[NUWID]=TRUE
+ GB_WND=NUWID
+ VAR E=GEndWindow(WND)
+ RETURN 0
 END
 COMMON DEF GCopyDirect(WND,X1,Y1,X2,Y2,X3,Y3,MODE)
  GPAGE OTW_SP,OTW_BP
@@ -3074,8 +3080,10 @@
   _NUWID=PNUWID
   PNUWID=WIN_NEXT[PNUWID]
  WEND
+ 'VAR OBP
+ 'GPAGE OUT ,OBP
  GPAGE OTW_SP,OTW_DP
- GCLIP 1,0,0,400,239
+ GCLIP 1,0,0,399,239
  GCOPY OTW_BP,AX,AY,AX+W,AY+H,AX,AY,0
  IF WIN_SP[NUWID]AND 512THEN OTW_SPCHR NUWID
  IF MAINCNT-OTW_LASTUPD>5THEN UpdateMouse
@@ -7008,13 +7016,16 @@
 VAR OTYDOCCTL
 VAR OTYDOC_WNDCTL
 VAR OTYDOC_FREE
+'===LINE===
 DIM OTYDOC_LINE[0]
 DIM OTYDOC_NEXT[0]
 DIM OTYDOC_PREV[0]
 DIM OTYDOC_VAL$[0]
+'===LINE===
 VAR OTYDOC_LEFT
 VAR OTYDOC_CENTER
 VAR OTYDOC_RIGHT
+'===LINE===
 'left/right/center
 DIM OTYDOC_LINESTYLE[0]
 'heading/list
@@ -7022,6 +7033,7 @@
 'LINE SIZE
 DIM OTYDOC_SIZE[0]
 DIM OTYDOC_INDENT[0]
+'===LINE===
 VAR OTYDOC_LINESIZ
 
 VAR OTYDOC_WFREE
@@ -7037,6 +7049,9 @@
 DIM OTYDOC_STYLE2[0]
 DIM OTYDOC_COL[0]
 DIM OTYDOC_COL2[0]
+DIM OTYDOC_DEFSIZE[0]
+DIM OTYDOC_DEFSTYLE[0]
+DIM OTYDOC_DEFCOL[0]
 DIM OTYDOC_CX[0]
 DIM OTYDOC_SCRBAR[0]
 DIM OTYDOC_SCRBARPOS[0]
@@ -7050,14 +7065,35 @@
 DIM OTYDOC_SELSX[0]
 DIM OTYDOC_ISSEL[0]
 DIM OTYDOC_SELREVERSE[0]
+DIM OTYDOC_SEL1TABLE[0]
+DIM OTYDOC_SEL1ROW[0]
+DIM OTYDOC_SEL1COL[0]
+DIM OTYDOC_SEL2TABLE[0]
+DIM OTYDOC_SEL2ROW[0]
+DIM OTYDOC_SEL2COL[0]
+DIM OTYDOC_SELSTABLE[0]
+DIM OTYDOC_SELSROW[0]
+DIM OTYDOC_SELSCOL[0]
 VAR OTYDOC_HEAD1
 VAR OTYDOC_HEAD2
 VAR OTYDOC_HEAD3
 VAR OTYDOC_HEAD4
 VAR OTYDOC_HEAD5
 VAR OTYDOC_HEAD6
+VAR OTYDOC_HEADLAST
 VAR OTYDOC_ORDLIST
 VAR OTYDOC_UORDLIST
+VAR OTYDOC_TABLE
+'===LINE===
+'TABLE IS SBARRAY DATA
+DIM OTYDOC_TABLEDATA[0]
+DIM OTYDOC_TABLEPARENT[0]
+'===LINE===
+VAR OTYDOC_TABLEARY_COL
+VAR OTYDOC_TABLEARY_ROW
+VAR OTYDOC_TABLEARY_LINE
+VAR OTYDOC_TABLEARY_HEAD
+VAR OTYDOC_TBLELM
 VAR OTYDOC_BEG$
 VAR OTYDOC_END$
 VAR OTYDOC_MENU
@@ -7086,6 +7122,13 @@
   OTYDOC_LINESTYLE=NewArray(OTYDOC_LINESIZ)
   OTYDOC_LINEDATA=NewArray(OTYDOC_LINESIZ)
   OTYDOC_INDENT=NewArray(OTYDOC_LINESIZ)
+  OTYDOC_TABLEDATA=NewArray(OTYDOC_LINESIZ)
+  OTYDOC_TABLEPARENT=NewArray(OTYDOC_LINESIZ)
+  OTYDOC_TABLEARY_COL=0
+  OTYDOC_TABLEARY_ROW=1
+  OTYDOC_TABLEARY_LINE=2
+  OTYDOC_TABLEARY_HEAD=3
+  OTYDOC_TBLELM=1
   OTYDOC_LEFT=0
   OTYDOC_CENTER=1
   OTYDOC_RIGHT=2
@@ -7095,8 +7138,10 @@
   OTYDOC_HEAD4=4
   OTYDOC_HEAD5=5
   OTYDOC_HEAD6=6
+  OTYDOC_HEADLAST=6
   OTYDOC_ORDLIST=7
   OTYDOC_UORDLIST=8
+  OTYDOC_TABLE=9
   OTYDOC_FREE=1
   VAR I
   FOR I=1TO OTYDOC_LINESIZ-2
@@ -7114,6 +7159,9 @@
   OTYDOC_STYLE2=NewArray(OTYDOC_WSIZ)
   OTYDOC_COL=NewArray(OTYDOC_WSIZ)
   OTYDOC_COL2=NewArray(OTYDOC_WSIZ)
+  OTYDOC_DEFSIZE=NewArray(OTYDOC_WSIZ)
+  OTYDOC_DEFSTYLE=NewArray(OTYDOC_WSIZ)
+  OTYDOC_DEFCOL=NewArray(OTYDOC_WSIZ)
   OTYDOC_CX=NewArray(OTYDOC_WSIZ)
   OTYDOC_SCRBAR=NewArray(OTYDOC_WSIZ)
   OTYDOC_SCRBARPOS=NewArray(OTYDOC_WSIZ)
@@ -7125,6 +7173,15 @@
   OTYDOC_SEL2X=NewArray(OTYDOC_WSIZ)
   OTYDOC_SELS=NewArray(OTYDOC_WSIZ)
   OTYDOC_SELSX=NewArray(OTYDOC_WSIZ)
+  OTYDOC_SELSTABLE=NewArray(OTYDOC_WSIZ)
+  OTYDOC_SELSROW=NewArray(OTYDOC_WSIZ)
+  OTYDOC_SELSCOL=NewArray(OTYDOC_WSIZ)
+  OTYDOC_SEL1TABLE=NewArray(OTYDOC_WSIZ)
+  OTYDOC_SEL1ROW=NewArray(OTYDOC_WSIZ)
+  OTYDOC_SEL1COL=NewArray(OTYDOC_WSIZ)
+  OTYDOC_SEL2TABLE=NewArray(OTYDOC_WSIZ)
+  OTYDOC_SEL2ROW=NewArray(OTYDOC_WSIZ)
+  OTYDOC_SEL2COL=NewArray(OTYDOC_WSIZ)
   OTYDOC_ISSEL=NewArray(OTYDOC_WSIZ)
   OTYDOC_SELREVERSE=NewArray(OTYDOC_WSIZ)
   OTYDOC_WFREE=1
@@ -7144,9 +7201,11 @@
  OTYDOC_FREE=OTYDOC_NEXT[OTYDOC_FREE]
  IF P THEN
   OTYDOC_LINE[R]=OTYDOC_LINE[P]+1
+  OTYDOC_TABLEPARENT[R]=OTYDOC_TABLEPARENT[P]
  ELSE
   OTYDOC_LINE[R]=1
   OTYDOC_INDENT[R]=0
+  OTYDOC_TABLEPARENT[R]=0
  ENDIF
  OTYDOC_LINEDATA[R]=0
  VAR N
@@ -7274,13 +7333,18 @@
  VAR D=OTYDOC_GetData(WND)
  IF!D THEN RETURN
  OTYDOC_SCRBAR[D]=SCR
- VAR S=OTYDOC_NewLine(OTYDOC_NewLineInitStyle$(D),0)
- OTYDOC_ShowLine[D]=S
- OTYDOC_CurLine[D]=S
  OTYDOC_COL2[D]=RGBToShort(RGB(0,0,0))
  OTYDOC_COL[D]=RGBToShort(RGB(0,0,0))
+ OTYDOC_DEFCOL[D]=RGBToShort(RGB(0,0,0))
  OTYDOC_WSIZE[D]=8
  OTYDOC_WSIZE2[D]=8
+ OTYDOC_DEFSIZE[D]=8
+ OTYDOC_STYLE[D]=0
+ OTYDOC_STYLE2[D]=0
+ OTYDOC_DEFSTYLE[D]=0
+ VAR S=OTYDOC_NewLine(OTYDOC_NewLineInitStyle$(D),0)
+ OTYDOC_ShowLine[D]=S
+ OTYDOC_CurLine[D]=S
 END
 COMMON DEF OTYDocResize WND,C,T,A1,WH
  VAR W,H
@@ -7288,29 +7352,387 @@
  IF W<0||H<0THEN RETURN
  VAR CW=GetChildWindow(WND)
  VOID MoveResizeWindow(CW,W-GetWindowWidth(CW),0,GetWindowWidth(CW),H)
+'RESIZE TABLE
+ VAR D=OTYDOC_GetData(WND)
+ VAR LINE=OTYDOC_ShowLine[D]
+ W=OTYDOC_GetWidth(WND)
+ IF 0THEN DIM A[0]
+ WHILE LINE
+  IF OTYDOC_TABLEDATA[LINE]THEN
+   A=GetSBArray(OTYDOC_TABLEDATA[LINE])
+   OTYDOC_UpdateTable2 A,W
+   OTYDOC_UpdateChildrenTable A
+  ENDIF
+  LINE=OTYDOC_NEXT[LINE]
+ WEND
+ LINE=OTYDOC_PREV[LINE]
+ WHILE LINE
+  IF OTYDOC_TABLEDATA[LINE]THEN
+   A=GetSBArray(OTYDOC_TABLEDATA[LINE])
+   OTYDOC_UpdateTable2 A,W
+   OTYDOC_UpdateChildrenTable A
+  ENDIF
+  LINE=OTYDOC_PREV[LINE]
+ WEND
 END
 COMMON DEF OTYDocPainter WND,CTL,TYPE,A1,A2
  OTYDOCRepaint WND
 END
 DEF OTYDOCRepaint WND
- OTYDOCRepaintSEL WND,FALSE,0,0
+ OTYDOCRepaintSEL WND',FALSE,0,0
 END
+DEF OTYDOC_CalcSize I,MAX OUT MINW,MAXW,H
+ MINW=0
+ MAXW=0
+ H=0
+ VAR ST=0
+ VAR SZ=8
+ VAR COL=RGB(0,0,0)
+ VAR A
+ VAR OL
+ VAR SL=I
+ WHILE I
+  VAR J
+  VAR V$=OTYDOC_VAL$[I]
+  VAR YSZ=OTYDOC_SIZE[I],L=LEN(V$)-1
+  VAR SX=OTYDOC_INDENT[I]
+  VAR X=SX
+  VAR LINED=OTYDOC_LINEDATA[I]
+  IF LINED==OTYDOC_UORDLIST THEN
+   VAR Y8=(YSZ DIV 8)
+   X=X+5*Y8
+  ELSEIF LINED==OTYDOC_ORDLIST THEN
+   Y8=(YSZ DIV 8)
+   IF OL THEN
+    OL=OL+1
+   ELSEIF I==SL THEN
+    VAR OLS=OTYDOC_PREV[I]
+    OL=1
+    WHILE OLS
+     IF OTYDOC_LINEDATA[OLS]==OTYDOC_ORDLIST THEN
+      OL=OL+1
+      OLS=OTYDOC_PREV[OLS]
+     ELSE
+      BREAK
+     ENDIF
+    WEND
+   ELSE
+    OL=1
+   ENDIF
+   X=X+(LOG(OL,10)+1)*5*Y8+2*Y8
+  ELSE
+   OL=0
+  ENDIF
+  IF LINED==OTYDOC_TABLE THEN
+   IF 0THEN DIM TBLARY[0]
+   VAR TD=OTYDOC_TABLEDATA[I]
+   TBLARY=GetSBArray(TD)
+   VAR TH
+   VAR MTBLW
+   OTYDOC_CalcTableMinMax TBLARY,MAX OUT MTBLW,X,TH
+   MINW=MAX(MINW,MTBLW)
+   MAXW=MAX(MAXW,X)
+   H=H+TH
+   GOTO @C
+  ENDIF
+  FOR J=0TO L
+   VAR C=ASC(V$[J])
+   IF C==&Hb10cTHEN CONTINUE
+   IF C==&Hb10bTHEN
+    INC J
+    C=ASC(V$[J])
+    ON C GOTO@FNT,@COL,@STY
+    CONTINUE
+    @FNT'0
+    INC J
+    A=ASC(V$[J])
+    SZ=A
+    CONTINUE
+    @COL'1
+    INC J
+    A=ASC(V$[J])
+    COL=ShortToRGB(A)
+    CONTINUE
+    @STY'2
+    INC J
+    A=ASC(V$[J])
+    ST=A
+    CONTINUE
+   ENDIF
+   IF C<128THEN
+    VAR TW=SZ*6/8+(ST AND 1)
+   ELSE
+    TW=SZ+(ST AND 1)
+   ENDIF
+   MINW=MAX(MINW,SX+TW)
+   X=X+TW
+   IF X+TW>=MAX THEN
+    MAXW=MAX(MAXW,X)
+    X=0
+    H=H+YSZ
+   ENDIF
+  NEXT
+  H=H+YSZ
+  @C
+  MAXW=MAX(MAXW,X)
+  I=OTYDOC_NEXT[I]
+ WEND
+END
+DEF OTYDOC_UpdateTable A
+ VAR ROW=A[OTYDOC_TABLEARY_ROW]
+ VAR COL=A[OTYDOC_TABLEARY_COL]
+ VAR R,C
+ VAR MINW,MW
+ VAR H=OTYDOC_TABLEARY_HEAD+ROW+COL
+ 
+ FILL A,0,OTYDOC_TABLEARY_HEAD,ROW
+ FOR C=0TO COL-1
+  VAR MAXW=0
+  FOR R=0TO ROW-1
+   VAR LINE=A[H+R*COL*OTYDOC_TBLELM+C*OTYDOC_TBLELM]
+   VAR H2
+   OTYDOC_CalcSize LINE,&H7FFFFFFF OUT MINW,MW,H2
+   MAXW=MAX(MAXW,MW+4)
+   A[OTYDOC_TABLEARY_HEAD+R]=MAX(A[OTYDOC_TABLEARY_HEAD+R],H2+2)
+  NEXT
+  A[OTYDOC_TABLEARY_HEAD+ROW+C]=MAXW
+ NEXT
+END
+DEF OTYDOC_CalcTableMinMax A,MAX OUT WIDTH,MAXWIDTH,HEIGHT
+ VAR ROW=A[OTYDOC_TABLEARY_ROW]
+ VAR COL=A[OTYDOC_TABLEARY_COL]
+ VAR R,C
+ VAR MINW,MW
+ VAR H=OTYDOC_TABLEARY_HEAD+ROW+COL
+ DIM H3[ROW]
+ WIDTH=2
+ MAXWIDTH=2
+ FOR C=0TO COL-1
+  VAR MAXW=0,MAXW2=0
+  FOR R=0TO ROW-1
+   VAR LINE=A[H+R*COL*OTYDOC_TBLELM+C*OTYDOC_TBLELM]
+   VAR H2
+   OTYDOC_CalcSize LINE,MAX OUT MINW,MW,H2
+   MAXW=MAX(MAXW,MINW+4)
+   MAXW2=MAX(MAXW2,MW+4)
+   H3[R]=MAX(H3[R],H2+4)
+  NEXT
+  WIDTH=WIDTH+MAXW
+  MAXWIDTH=MAXWIDTH+MAXW2
+ NEXT
+ HEIGHT=4
+ FOR R=0TO ROW-1
+  HEIGHT=HEIGHT+H3[R]
+ NEXT
+END
+DEF OTYDOC_UpdateTable2 A,SCRW
+ VAR ROW=A[OTYDOC_TABLEARY_ROW]
+ VAR COL=A[OTYDOC_TABLEARY_COL]
+ VAR R,C
+ VAR MINW,MW
+ VAR H=OTYDOC_TABLEARY_HEAD+ROW+COL
+ 
+ DIM MINWS[COL]
+ DIM MAXWS[COL]
+ FILL A,0,OTYDOC_TABLEARY_HEAD,ROW
+ FOR C=0TO COL-1
+  VAR MAXW=0
+  FOR R=0TO ROW-1
+   VAR LINE=A[H+R*COL*OTYDOC_TBLELM+C*OTYDOC_TBLELM]
+   VAR H2
+   OTYDOC_CalcSize LINE,&H7FFFFFFF OUT MINW,MW,H2
+   MAXWS[C]=MAX(MAXWS[C],MW+6)
+   MINWS[C]=MAX(MINWS[C],MINW+6)
+   A[OTYDOC_TABLEARY_HEAD+R]=MAX(A[OTYDOC_TABLEARY_HEAD+R],H2+4)
+  NEXT
+ NEXT
+ MAXW=2
+ FOR C=0TO COL-1
+  MAXW=MAXW+MAXWS[C]
+ NEXT
+ IF MAXW<=SCRW THEN
+  FOR C=0TO COL-1
+   A[OTYDOC_TABLEARY_HEAD+ROW+C]=MAXWS[C]
+  NEXT
+  RETURN
+ ENDIF
+ MINW=2
+ FOR C=0TO COL-1
+  MINW=MINW+MINWS[C]
+ NEXT
+ VAR W=SCRW-MINW
+ IF W>=0THEN
+  VAR D=MAXW-MINW
+  FOR C=0TO COL-1
+   VAR D2=MAXWS[C]-MINWS[C]
+   INC MINWS[C],(D2*W)DIV D
+  NEXT
+ ENDIF
+ FOR C=0TO COL-1
+  A[OTYDOC_TABLEARY_HEAD+ROW+C]=MINWS[C]
+  FOR R=0TO ROW-1
+   LINE=A[H+R*COL*OTYDOC_TBLELM+C*OTYDOC_TBLELM]
+   OTYDOC_CalcSize LINE,MINWS[C]-2 OUT MINW,MW,H2
+   A[OTYDOC_TABLEARY_HEAD+R]=MAX(A[OTYDOC_TABLEARY_HEAD+R],H2+4)
+  NEXT
+ NEXT
+END
+DEF OTYDOC_UpdateParentTable LINE,WIDTH
+ IF 0THEN DIM A[0]
+ WHILE 1
+  VAR TD=OTYDOC_TABLEPARENT[LINE]
+  IF!TD THEN
+   BREAK
+  ENDIF
+  A=GetSBArray(TD)
+  LINE=A[OTYDOC_TABLEARY_LINE]
+ WEND
+ A=GetSBArray(OTYDOC_TABLEDATA[LINE])
+ OTYDOC_UpdateTable2 A,WIDTH
+ OTYDOC_UpdateChildrenTable A
+END
+DEF OTYDOC_GetParentTable LINE OUT TBL,HIE
+ IF 0THEN DIM A[0]
+ HIE=0
+ WHILE 1
+  VAR TD=OTYDOC_TABLEPARENT[LINE]
+  IF!TD THEN
+   BREAK
+  ENDIF
+  A=GetSBArray(TD)
+  LINE=A[OTYDOC_TABLEARY_LINE]
+  INC HIE
+ WEND
+ TBL=OTYDOC_TABLEDATA[LINE]
+END
+DEF OTYDOC_UpdateChildrenTable A
+ VAR ROW=A[OTYDOC_TABLEARY_ROW]
+ VAR COL=A[OTYDOC_TABLEARY_COL]
+ VAR H=OTYDOC_TABLEARY_HEAD+ROW+COL
+ VAR R,C
+ IF 0THEN DIM B[0]
+ FOR C=0TO COL-1
+  FOR R=0TO ROW-1
+   VAR CELLW=A[OTYDOC_TABLEARY_HEAD+ROW+C]
+   VAR LINE=A[H+R*COL*OTYDOC_TBLELM+C*OTYDOC_TBLELM]
+   WHILE LINE
+    VAR TD=OTYDOC_TABLEDATA[LINE]
+    IF TD THEN
+     B=GetSBArray(TD)
+     OTYDOC_UpdateTable2 B,CELLW-2
+     OTYDOC_UpdateChildrenTable B
+    ENDIF
+    LINE=OTYDOC_NEXT[LINE]
+   WEND
+  NEXT
+ NEXT
+END
+DEF OTYDOC_GetTableLocation T1,T2 OUT R,C
+ IF 0THEN DIM A[0]
+ A=GetSBArray(T1)
+ VAR ROW=A[OTYDOC_TABLEARY_ROW]
+ VAR COL=A[OTYDOC_TABLEARY_COL]
+ VAR H=OTYDOC_TABLEARY_HEAD+ROW+COL
+ FOR C=0TO COL-1
+  FOR R=0TO ROW-1
+   VAR LINE=A[H+R*COL*OTYDOC_TBLELM+C*OTYDOC_TBLELM]
+   WHILE LINE
+    IF OTYDOC_TABLEDATA[LINE]THEN
+     IF OTYDOC_TABLEDATA[LINE]==T2 THEN
+      RETURN
+     ENDIF
+     VAR _
+     OTYDOC_GetTableLocation OTYDOC_TABLEDATA[LINE],T2 OUT _,_
+     IF _!=-1THEN RETURN
+    ENDIF
+    LINE=OTYDOC_NEXT[LINE]
+   WEND
+  NEXT
+ NEXT
+ R=-1
+ C=-1
+END
+DEF OTYDOC_RenderTable D,I,X,Y,WIDTH,HEIGHT OUT Y2
+ VAR TD=OTYDOC_TABLEDATA[I]
+ Y2=Y
+ IF!TD THEN RETURN
+ IF 0THEN DIM A[0]
+ A=GetSBArray(TD)
+ VAR ROW=A[OTYDOC_TABLEARY_ROW]
+ VAR COL=A[OTYDOC_TABLEARY_COL]
+ VAR R,C,_
+ VAR SY=Y2
+ VAR H=OTYDOC_TABLEARY_HEAD+ROW+COL
+ IF COL&&ROW&&!A[OTYDOC_TABLEARY_HEAD]THEN OTYDOC_UpdateTable2 A,WIDTH-X
+' FILL A,0,OTYDOC_TABLEARY_HEAD+ROW,COL
+ VAR SELR=&H7FFFFFFF,SELR2=&H7FFFFFFF
+ VAR SELC=&H7FFFFFFF,SELC2=&H7FFFFFFF
+ IF OTYDOC_ISSEL[D]THEN
+  IF OTYDOC_SEL1TABLE[D]==TD THEN
+   SELR=OTYDOC_SEL1ROW[D]
+   SELC=OTYDOC_SEL1COL[D]
+  ENDIF
+  IF OTYDOC_SEL2TABLE[D]==TD THEN
+   SELR2=OTYDOC_SEL2ROW[D]
+   SELC2=OTYDOC_SEL2COL[D]
+  ENDIF
+  IF SELC2<SELC||SELR2<SELR THEN
+   SWAP SELR2,SELR
+   SWAP SELC2,SELC
+  ENDIF
+  VAR SC=GetSelectionColor()
+ ENDIF
+ FOR C=0TO COL-1
+  Y2=SY
+  VAR CELLW=A[OTYDOC_TABLEARY_HEAD+ROW+C]
+  FOR R=0TO ROW-1
+   VAR LINE=A[H+R*COL*OTYDOC_TBLELM+C*OTYDOC_TBLELM]
+   VAR W2,H2
+   IF SELR<=R&&SELC<=C&&SELR2>=R&&SELC2>=C THEN
+    GFILL X,Y2,CELLW+X,Y2+A[OTYDOC_TABLEARY_HEAD+R],SC
+   ENDIF
+   OTYDOCRender X+2,Y2+2,D,LINE,CELLW+X,HEIGHT OUT _,W2,H2
+   H2=A[OTYDOC_TABLEARY_HEAD+R]
+'   H2=MAX(A[OTYDOC_TABLEARY_HEAD+ROW+C],H2)
+'   A[OTYDOC_TABLEARY_HEAD+ROW+C]=H2
+   GBOX X,Y2,X+CELLW,Y2+H2,#BLACK
+
+   Y2=Y2+H2
+  NEXT
+  X=X+CELLW
+ NEXT
+ Y2=Y2+2
+END
+DEF OTYDOC_GetWidth(WND)
+ VAR D=OTYDOC_GetData(WND)
+ RETURN GetWindowWidth(WND)-GetWindowWidth(OTYDOC_SCRBAR[D])-1
+END
 'CONTAINS STARTSELECTION
 'CONTAINS ENDSELECTION
-DEF OTYDOCRepaintSEL WND,SEL_FLG,SX,SY
+DEF OTYDOCRepaintSEL WND',SEL_FLG',SX,SY
  IF GBeginDirect(WND)THEN RETURN
- GCLS RGB(255,255,255)
- VAR W=GetWindowWidth(WND)-8
- VAR H=GetWindowHeight(WND)
  VAR D=OTYDOC_GetData(WND)
+ VAR W=GetWindowWidth(WND)-GetWindowWidth(OTYDOC_SCRBAR[D])-1
+ VAR H=GetWindowHeight(WND)
  IF!D THEN
   RETURN
  ENDIF
  VAR SL=OTYDOC_ShowLine[D]
- VAR I=OTYDOC_ShowLine[D]
+ GCLS RGB(255,255,255)
+ VAR _
+ OTYDOCRender 2,2,D,SL,W,H OUT OTYDOC_LastShowLine[D],_,_
+ GBOX 0,0,W,H,RGB(0,0,0)
+ VAR E=GCopyDirect(WND,0,0,W,H,0,0,1)
+ E=GEndWindow(WND)
+END
+DEF OTYDOCRender X,Y,D,SL,W,H OUT LAST,W2,H2
+ W2=0
+ 'DBG
+ 'GFILL X,Y,W,H,RGB(RND(256),RND(256),RND(256))
+ VAR SY=Y
+ VAR I=SL
  VAR CL=OTYDOC_CurLine[D]
  VAR CX=OTYDOC_CX[D]
- VAR Y=2,X=2
  VAR ST=0
  VAR SZ=8
  VAR COL=RGB(0,0,0)
@@ -7338,6 +7760,7 @@
  VAR SELBKGND=GetSelectionColor()
  VAR SELFRGND=GetSelectionTextColor()
  VAR OL=0
+ VAR SX=X
  WHILE I
   VAR YSZ=OTYDOC_SIZE[I]
 '?"YSZ",YSZ
@@ -7347,7 +7770,7 @@
   VAR A
   VAR L=LEN(V$)-1,J,C
   SZ=8
-  X=1+OTYDOC_INDENT[I]
+  X=SX+OTYDOC_INDENT[I]
   
   VAR LINED=OTYDOC_LINEDATA[I]
   IF LINED==OTYDOC_UORDLIST THEN
@@ -7384,6 +7807,10 @@
    NEXT
    X=X+DG*5*Y8+14*Y8
    GFILL X-2*Y8,Y+YSZ-2*Y8,X-Y8-1,Y+YSZ-Y8-1,#BLACK
+  ELSEIF LINED==OTYDOC_TABLE THEN
+   OL=0
+   OTYDOC_RenderTable D,I,X,Y,W,H OUT Y
+   GOTO @C
   ELSE
    OL=0
   ENDIF
@@ -7438,8 +7865,9 @@
    ELSE
     TW=SZ+(ST AND 1)
    ENDIF
-   IF X+SZ>=W THEN
-    X=1
+   IF X+TW>=W THEN
+    W2=MAX(W2,X-SX)
+    X=SX
     INC Y,YSZ
     IF Y+YSZ>=H THEN BREAK
    ENDIF
@@ -7467,10 +7895,8 @@
    ENDIF
 '   ?HEX$(COL)
    INC X,TW
-   IF SEL_FLG THEN
-    
-   ENDIF
   NEXT
+  W2=MAX(W2,X-SX)
   IF ISSEL THEN
    IF I==SEL1 THEN
     SELSX=0
@@ -7515,13 +7941,13 @@
    ENDIF
   ENDIF
   INC Y,YSZ
+  @C
   IF Y+YSZ>=H THEN BREAK
   I=OTYDOC_NEXT[I]
  WEND
- VOID SetWindowCursor(WND,CURSORX,CURSORY)
- OTYDOC_LastShowLine[D]=I
- GBOX 0,0,W,H,RGB(0,0,0)
- VAR E=GCopyDirect(WND,0,0,W,H,0,0,1)
+ H2=Y-SY
+ LAST=I
+' VOID SetWindowCursor(WND,CURSORX,CURSORY)
 END
 COMMON DEF OTYDocChFocus WND,CTL,TYPE,A1,A2
 END
@@ -7533,10 +7959,59 @@
   RETURN
  ENDIF
  VAR I=OTYDOC_ShowLine[D]
- VAR SL=OTYDOC_ShowLine[D]
- VAR CL=OTYDOC_CurLine[D]
- VAR CX=OTYDOC_CX[D]
- VAR Y=2,X=2
+ OTYDOC_CLKWH I,W-2,H-2,MX-2,MY-2 OUT LINE,POS
+END
+DEF OTYDOC_GetTableSize A[] OUT WI,HE
+ VAR ROW=A[OTYDOC_TABLEARY_ROW]
+ VAR COL=A[OTYDOC_TABLEARY_COL]
+ VAR H=OTYDOC_TABLEARY_HEAD+ROW+COL
+ VAR I
+ WI=0
+ HE=0
+ FOR I=0TO ROW-1
+  INC HE,A[OTYDOC_TABLEARY_HEAD+I]+2
+ NEXT
+ FOR I=0TO COL-1
+  INC WI,A[OTYDOC_TABLEARY_HEAD+I+ROW]+2
+ NEXT
+END
+DEF OTYDOC_CLKTBL L,MX,MY OUT LINE,POS,HEIGHT
+ LINE=-1
+ POS=-1
+ VAR TD=OTYDOC_TABLEDATA[L]
+ IF!TD THEN HEIGHT=0:RETURN
+ IF 0THEN DIM A[0]
+ A=GetSBArray(TD)
+ VAR WI,HE
+ OTYDOC_GetTableSize A OUT WI,HE
+ HEIGHT=HE+1
+ IF MX>WI&&MY>HE THEN RETURN
+ VAR ROW=A[OTYDOC_TABLEARY_ROW]
+ VAR COL=A[OTYDOC_TABLEARY_COL]
+ VAR H=OTYDOC_TABLEARY_HEAD+ROW+COL
+ VAR I,J,Y,X,R,C
+ FOR C=0TO COL-1
+  Y=0
+  VAR CELLW=A[OTYDOC_TABLEARY_HEAD+ROW+C]
+  FOR R=0TO ROW-1
+   L=A[H+R*COL*OTYDOC_TBLELM+C*OTYDOC_TBLELM]
+   VAR H2=A[OTYDOC_TABLEARY_HEAD+R]
+   IF MY>=Y&&MY<Y+H2+2&&MX>=X-1&&MX<=X+CELLW THEN
+    OTYDOC_CLKWH L,CELLW,H2,MX-X,MY-Y OUT LINE,POS
+    IF LINE==-1THEN
+     LINE=L
+     POS=0
+    ENDIF
+    RETURN
+   ENDIF
+   Y=Y+H2+2
+  NEXT
+  X=X+CELLW+2
+ NEXT
+END
+DEF OTYDOC_CLKWH I,W,H,MX,MY OUT LINE,POS
+ VAR SL=I
+ VAR Y=0,X=0
  MX=MIN(MAX(X,MX),W)
  MY=MIN(MAX(Y,MY),H)
  VAR ST=0
@@ -7584,6 +8059,13 @@
     OL=1
    ENDIF
    X=X+(LOG(OL,10)+1)*5*Y8+2*Y8
+  ELSEIF LINED==OTYDOC_TABLE THEN
+   VAR TH
+   OTYDOC_CLKTBL I,MX-X,MY-Y OUT LINE,POS,TH'I,W,H,MX,MY OUT LINE,POS
+   Y=Y+TH
+   IF POS!=-1&&LINE!=-1THEN RETURN
+   OL=0
+   GOTO @C
   ELSE
    OL=0
   ENDIF
@@ -7593,13 +8075,6 @@
    C=ASC(V$[J])
    IF C==&Hb10cTHEN CONTINUE
    IF C==&Hb10bTHEN
-   IF I==CL THEN
-    IF CX==J THEN
-     OTYDOC_STYLE[D]=ST
-     OTYDOC_COL[D]=RGBToShort(COL)
-     OTYDOC_WSIZE[D]=SZ
-    ENDIF
-   ENDIF
     INC J
     C=ASC(V$[J])
     ON C GOTO@FNT,@COL,@STY
@@ -7639,28 +8114,11 @@
      IF ISNCR THEN RETURN
     ENDIF
    ENDIF
-   IF I==CL THEN
-    IF CX==J THEN
-     CURSORX=X
-     CURSORY=Y+YSZ-SZ
-     OTYDOC_STYLE[D]=ST
-     OTYDOC_COL[D]=RGBToShort(COL)
-     OTYDOC_WSIZE[D]=SZ
-    ENDIF
-   ENDIF
    INC X,TW
   NEXT
   IF POS!=-1&&MOVECHRPOS>POS THEN
    RETURN
   ENDIF
-  IF I==CL&&CX>L THEN
-   CURSORX=X
-   CURSORY=Y+YSZ-SZ
-   OTYDOC_STYLE[D]=ST
-   OTYDOC_COL[D]=RGBToShort(COL)
-   OTYDOC_WSIZE[D]=SZ
-'   VOID SetWindowCursor(WND,
-  ENDIF
   IF !ISNCR&&LINESTYLE==OTYDOC_CENTER THEN
    'CENTER
    VAR CENT=(W-2-X)DIV 2
@@ -7711,6 +8169,7 @@
    J=MOVECHRPOS
    GOTO @RETRY
   ENDIF
+  @C
   IF Y+YSZ>=H THEN BREAK
   I=OTYDOC_NEXT[I]
  WEND
@@ -7801,12 +8260,41 @@
   OTYDOC_SEL1[D]=LINE
   OTYDOC_SEL2[D]=LINE
   OTYDOC_SELS[D]=LINE
+  OTYDOC_SELSTABLE[D]=OTYDOC_TABLEPARENT[LINE]
+  IF OTYDOC_SELSTABLE[D]THEN 
+   OTYDOC_TableGetPos GetSBArray(OTYDOC_SELSTABLE[D]),LINE OUT OTYDOC_SELSROW[D],OTYDOC_SELSCOL[D]
+  ENDIF
+  
   OTYDOC_SEL1X[D]=POS
   OTYDOC_SEL2X[D]=POS
   OTYDOC_SELSX[D]=POS
   OTYDOC_HASSTARTSEL[D]=TRUE
   OTYDOC_HASENDSEL[D]=TRUE
  ENDIF
+ OTYDOC_SEL1TABLE[D]=OTYDOC_TABLEPARENT[OTYDOC_SEL1[D]]
+ OTYDOC_SEL2TABLE[D]=OTYDOC_TABLEPARENT[OTYDOC_SEL2[D]]
+ IF OTYDOC_SEL1TABLE[D]THEN 
+  OTYDOC_TableGetPos GetSBArray(OTYDOC_SEL1TABLE[D]),OTYDOC_SEL1[D] OUT OTYDOC_SEL1ROW[D],OTYDOC_SEL1COL[D]
+ ENDIF
+ IF OTYDOC_SEL2TABLE[D]THEN 
+  OTYDOC_TableGetPos GetSBArray(OTYDOC_SEL2TABLE[D]),OTYDOC_SEL2[D] OUT OTYDOC_SEL2ROW[D],OTYDOC_SEL2COL[D]
+ ENDIF
+ IF OTYDOC_SEL1TABLE[D]&&OTYDOC_SEL2TABLE[D]THEN
+  IF OTYDOC_SEL1TABLE[D]!=OTYDOC_SEL2TABLE[D]THEN
+   VAR T1,T2,HIE1,HIE2
+   OTYDOC_GetParentTable OTYDOC_SEL1[D] OUT T1,HIE1
+   OTYDOC_GetParentTable OTYDOC_SEL2[D] OUT T2,HIE2
+   IF T1==T2 THEN
+    IF HIE1>HIE2 THEN
+     OTYDOC_GetTableLocation OTYDOC_SEL2TABLE[D],OTYDOC_SEL1TABLE[D] OUT OTYDOC_SEL1ROW[D],OTYDOC_SEL1COL[D]
+     OTYDOC_SEL1TABLE[D]=OTYDOC_SEL2TABLE[D]
+    ELSEIF HIE1<HIE2 THEN
+     OTYDOC_GetTableLocation OTYDOC_SEL1TABLE[D],OTYDOC_SEL2TABLE[D] OUT OTYDOC_SEL2ROW[D],OTYDOC_SEL2COL[D]
+     OTYDOC_SEL2TABLE[D]=OTYDOC_SEL1TABLE[D]
+    ENDIF
+   ENDIF
+  ENDIF
+ ENDIF
  IF!PAINTF THEN VOID RepaintWindow(WND)
 END
 DEF OTYDOC_ScrollContent D,DIFF
@@ -8195,7 +8683,7 @@
  NEXT
  RETURN FALSE
 END
-DEF OTYDOC_RemoveSelected D OUT X,C
+DEF OTYDOC_RemoveSelected D,WND OUT X,C
  IF!OTYDOC_ISSEL[D] THEN
   RETURN
  ENDIF
@@ -8211,12 +8699,15 @@
   IF C==S&&X>SX THEN
    X=SX
   ENDIF
+  IF OTYDOC_TABLEPARENT[S]THEN
+   OTYDOC_UpdateParentTable S,OTYDOC_GetWidth(WND)
+  ENDIF
   RETURN
  ENDIF
  OTYDOC_VAL$[S]=MID$(OTYDOC_VAL$[S],0,SX)
  S=OTYDOC_NEXT[S]
  VAR DL
- WHILE 1
+ WHILE S
   IF S==C THEN
    C=OTYDOC_PREV[S]
    X=LEN(OTYDOC_VAL$[C])
@@ -8233,6 +8724,9 @@
   ENDIF
   S=NXT
  WEND
+ IF OTYDOC_TABLEPARENT[C]THEN
+  OTYDOC_UpdateParentTable C,OTYDOC_GetWidth(WND)
+ ENDIF
  OTYDOC_AddLine D,-DL
 END
 
@@ -8363,7 +8857,7 @@
  VAR S=OTYDOC_ShowLine[D]
  IF OTYDOC_ISSEL[D]THEN
   'REMOVE
-  OTYDOC_RemoveSelected D OUT OTYDOC_CX[D],OTYDOC_CurLine[D]
+  OTYDOC_RemoveSelected D,WND OUT OTYDOC_CX[D],OTYDOC_CurLine[D]
   OTYDOC_ISSEL[D]=0
   IF KEY==8THEN @END
  ENDIF
@@ -8407,10 +8901,19 @@
     'SCROLL
     OTYDOC_CX[D]=LEN(OTYDOC_VAL$[C])
     OTYDOC_VAL$[C]=OTYDOC_VAL$[C]+S$
+    OTYDOC_AdjustLine C
    ENDIF
   ENDIF
  ELSE
   IF I$==CR$()THEN
+   IF OTYDOC_LINEDATA[C]>=OTYDOC_HEAD1&&OTYDOC_LINEDATA[C]<=OTYDOC_HEADLAST THEN
+    OTYDOC_STYLE2[D]=OTYDOC_DEFSTYLE[D]
+    OTYDOC_WSIZE2[D]=OTYDOC_DEFSIZE[D]
+    OTYDOC_COL2[D]=OTYDOC_DEFCOL[D]
+    OTYDOC_STYLE[D]=OTYDOC_DEFSTYLE[D]
+    OTYDOC_WSIZE[D]=OTYDOC_DEFSIZE[D]
+    OTYDOC_COL[D]=OTYDOC_DEFCOL[D]
+   ENDIF
    VAR HEAD$=OTYDOC_NewLineInitStyle$(D)
    VAR C2=OTYDOC_NewLine(HEAD$+MID$(OTYDOC_VAL$[C],X,LEN(OTYDOC_VAL$[C])-X),C)
    IF!C2 THEN RETURN
@@ -8473,6 +8976,9 @@
   ENDIF
  ENDIF
  @END
+ IF OTYDOC_TABLEPARENT[C]THEN
+  OTYDOC_UpdateParentTable C,OTYDOC_GetWidth(WND)
+ ENDIF
  OTYDOCRepaint WND
  ?OTYDOC_VAL$[C]
  ?" "*MAX(OTYDOC_CX[D],0);""
@@ -8556,9 +9062,15 @@
  VAR CD=OTYDOC_CURLINE[D]
  OTYDOC_LINEDATA[CD]=OTYDOC_HEAD1+LEVEL-1
  VAR CX=OTYDOC_GETPOS(OTYDOC_VAL$[CD],OTYDOC_CX[D])
- OTYDOC_RemoveStyle OTYDOC_VAL$[CD],0,LEN(OTYDOC_VAL$[CD]),2'STYLE
- OTYDOC_RemoveStyle OTYDOC_VAL$[CD],0,LEN(OTYDOC_VAL$[CD]),1'COLOR
- OTYDOC_RemoveStyle OTYDOC_VAL$[CD],0,LEN(OTYDOC_VAL$[CD]),0'SIZE
+ VAR TYPE
+ VAR ST$=""
+ FOR TYPE=0TO 2
+  VAR S$
+  OTYDOC_GetStyle OTYDOC_VAL$[CD],0,LEN(OTYDOC_VAL$[CD]),TYPE OUT S$
+  PUSH ST$,S$
+  OTYDOC_RemoveStyle OTYDOC_VAL$[CD],0,LEN(OTYDOC_VAL$[CD]),TYPE
+ NEXT
+ PUSH OTYDOC_VAL$[CD],ST$
  VAR FS=8
  OTYDOC_LINESTYLE[CD]=0
  IF LEVEL==1THEN
@@ -8662,6 +9174,7 @@
 END
 COMMON DEF RTEOpen WND,FILE$ OUT ERR
  VAR D=OTYDOC_GetData(WND)
+ OTYDOC_ISSEL[D]=FALSE
  VAR F$
  LoadFile FILE$ OUT F$,ERR
  IF MID$(F$,0,LEN("OTYDOC")+1)!="OTYDOC"+LF$()THEN
@@ -8757,12 +9270,15 @@
   I=I+1
   J=I
  WEND
+ IF OTYDOC_TABLEPARENT[C]THEN
+  OTYDOC_UpdateParentTable C,OTYDOC_GetWidth(WND)
+ ENDIF
  VOID RepaintWindow(WND)
 END
 COMMON DEF RTEPaste WND
  VAR D=OTYDOC_GetData(WND)
  IF OTYDOC_ISSEL[D]THEN
-  OTYDOC_RemoveSelected D OUT OTYDOC_CX[D],OTYDOC_CurLine[D]
+  OTYDOC_RemoveSelected D,WND OUT OTYDOC_CX[D],OTYDOC_CurLine[D]
   OTYDOC_ISSEL[D]=0
  ENDIF
  VAR D$,CNTNS
@@ -8820,6 +9336,9 @@
  NEXT
  PUSH OTYDOC_VAL$[LINE],LST$
  OTYDOC_AddLine D,LC
+ IF OTYDOC_TABLEPARENT[C]THEN
+  OTYDOC_UpdateParentTable C,OTYDOC_GetWidth(WND)
+ ENDIF
  VOID RepaintWindow(WND)
 END
 COMMON DEF RTESelectAll WND
@@ -8842,7 +9361,7 @@
  VAR D=OTYDOC_GetData(WND)
  IF OTYDOC_ISSEL[D]THEN
   RTECopy WND
-  OTYDOC_RemoveSelected D OUT OTYDOC_CX[D],OTYDOC_CurLine[D]
+  OTYDOC_RemoveSelected D,WND OUT OTYDOC_CX[D],OTYDOC_CurLine[D]
   OTYDOC_ISSEL[D]=0
  ENDIF
 END
@@ -8887,13 +9406,158 @@
  ClipboardSetData$ "RichText",O$
  ClipboardSetText P$
 END
+DEF OTYDOC_NewTableData(D,R,C,L)
+ VAR SB=AllocSBArray()
+ VAR H=OTYDOC_TABLEARY_HEAD+R+C
+ DIM A[R*C*OTYDOC_TBLELM+H]
+ A[OTYDOC_TABLEARY_ROW]=R
+ A[OTYDOC_TABLEARY_COL]=C
+ VAR I,J
+ FOR I=0TO R-1
+  FOR J=0TO C-1
+   VAR TL=OTYDOC_NewLine(OTYDOC_NewLineInitStyle$(D)+"",0)
+   OTYDOC_TABLEPARENT[TL]=SB
+   A[H+J*R*OTYDOC_TBLELM+I*OTYDOC_TBLELM]=TL
+  NEXT
+ NEXT
+ IF LEN(A)>H THEN
+  OTYDOC_CurLine[D]=A[H]
+  OTYDOC_CX[D]=LEN(OTYDOC_VAL$[A[H]])
+ ENDIF
+ A[OTYDOC_TABLEARY_LINE]=L
+ SetSBArray SB,A
+ RETURN SB
+END
+DEF OTYDOC_SearchLine(LINE,T)
+ WHILE LINE
+  IF LINE==T THEN BREAK
+  LINE=OTYDOC_NEXT[LINE]
+ WEND
+ RETURN LINE
+END
+DEF OTYDOC_TableGetPos TBL,LINE OUT R,C
+ VAR ROW=TBL[OTYDOC_TABLEARY_ROW]
+ VAR COL=TBL[OTYDOC_TABLEARY_COL]
+ VAR H=OTYDOC_TABLEARY_HEAD+ROW+COL
+ VAR I,J
+ FOR I=0TO ROW-1
+  FOR J=0TO COL-1
+   VAR L=TBL[H+I*COL*OTYDOC_TBLELM+J*OTYDOC_TBLELM]
+   IF OTYDOC_SearchLine(L,LINE)THEN
+    R=I
+    C=J
+    RETURN
+   ENDIF
+  NEXT
+ NEXT
+ R=-1
+ C=-1
+END
+COMMON DEF RTEAddTableRow WND,F
+ VAR D=OTYDOC_GetData(WND)
+ VAR CL=OTYDOC_CurLine[D]
+ VAR T=OTYDOC_TABLEPARENT[CL]
+ IF!T THEN RETURN
+ IF 0THEN DIM OLD[0]
+ OLD=GetSBArray(T)
+ VAR R,C
+ OTYDOC_TableGetPos OLD,CL OUT R,C
+ IF R==-1||C==-1THEN RETURN
+ VAR OLDROW=OLD[OTYDOC_TABLEARY_ROW]
+ VAR COL=OLD[OTYDOC_TABLEARY_COL]
+ VAR ROW=OLDROW+1
+ VAR INSROW=R
+ VAR I,J
+ VAR H=OTYDOC_TABLEARY_HEAD+ROW+COL
+ VAR OH=OTYDOC_TABLEARY_HEAD+OLDROW+COL
+ VAR K=0
+ DIM A[ROW*COL*OTYDOC_TBLELM+H]
+ A[OTYDOC_TABLEARY_ROW]=ROW
+ A[OTYDOC_TABLEARY_COL]=COL
+ A[OTYDOC_TABLEARY_LINE]=OLD[OTYDOC_TABLEARY_LINE]
+ SetSBArray T,A
+ FOR I=0TO ROW-1
+  IF (!F&&I==R)||(F&&I==R+1) THEN
+   FOR J=0TO COL-1
+    VAR TL=OTYDOC_NewLine(OTYDOC_NewLineInitStyle$(D)+"",0)
+    OTYDOC_TABLEPARENT[TL]=T
+    A[H+I*COL*OTYDOC_TBLELM+J*OTYDOC_TBLELM]=TL
+   NEXT
+   K=-1
+  ELSEIF 0&&F THEN
+   FOR J=0TO COL-1
+    A[H+I*COL*OTYDOC_TBLELM+J*OTYDOC_TBLELM]=OLD[OH+(I-K)*COL*OTYDOC_TBLELM+J*OTYDOC_TBLELM]
+   NEXT
+  ELSE
+   FOR J=0TO COL-1
+    A[H+I*COL*OTYDOC_TBLELM+J*OTYDOC_TBLELM]=OLD[OH+(I+K)*COL*OTYDOC_TBLELM+J*OTYDOC_TBLELM]
+   NEXT
+  ENDIF
+ NEXT
+ OTYDOC_UpdateParentTable TL,OTYDOC_GetWidth(WND)
+END
+COMMON DEF RTEAddTableColumn WND,F
+ VAR D=OTYDOC_GetData(WND)
+ VAR CL=OTYDOC_CurLine[D]
+ VAR T=OTYDOC_TABLEPARENT[CL]
+ IF!T THEN RETURN
+ IF 0THEN DIM OLD[0]
+ OLD=GetSBArray(T)
+ VAR R,C
+ OTYDOC_TableGetPos OLD,CL OUT R,C
+ IF R==-1||C==-1THEN RETURN
+ VAR ROW=OLD[OTYDOC_TABLEARY_ROW]
+ VAR OLDCOL=OLD[OTYDOC_TABLEARY_COL]
+ VAR COL=OLDCOL+1
+ VAR INSCOL=C
+ VAR I,J
+ VAR H=OTYDOC_TABLEARY_HEAD+ROW+COL
+ VAR OH=OTYDOC_TABLEARY_HEAD+ROW+OLDCOL
+ VAR K=0
+ DIM A[ROW*COL*OTYDOC_TBLELM+H]
+ A[OTYDOC_TABLEARY_ROW]=ROW
+ A[OTYDOC_TABLEARY_COL]=COL
+ A[OTYDOC_TABLEARY_LINE]=OLD[OTYDOC_TABLEARY_LINE]
 
+ SetSBArray T,A
+ FOR I=0TO COL-1
+  IF (!F&&I==C)||(F&&I==C+1) THEN
+   FOR J=0TO ROW-1
+    VAR TL=OTYDOC_NewLine(OTYDOC_NewLineInitStyle$(D)+"",0)
+    OTYDOC_TABLEPARENT[TL]=T
+    A[H+J*COL*OTYDOC_TBLELM+I*OTYDOC_TBLELM]=TL
+   NEXT
+   K=-1
+  ELSE
+   FOR J=0TO ROW-1
+    A[H+J*COL*OTYDOC_TBLELM+I*OTYDOC_TBLELM]=OLD[OH+J*OLDCOL*OTYDOC_TBLELM+(I+K)*OTYDOC_TBLELM]
+   NEXT
+  ENDIF
+ NEXT
+ OTYDOC_UpdateParentTable TL,OTYDOC_GetWidth(WND)
+
+END
+COMMON DEF RTEAddTable WND,R,C
+ VAR D=OTYDOC_GetData(WND)
+ OTYDOC_ISSEL[D]=FALSE
+ VAR L=OTYDOC_NewLine("",OTYDOC_CurLine[D])
+ OTYDOC_CurLine[D]=OTYDOC_NewLine(OTYDOC_NewLineInitStyle$(D),L)
+ OTYDOC_LINEDATA[L]=OTYDOC_TABLE
+ OTYDOC_TABLEDATA[L]=OTYDOC_NewTableData(D,R,C,L)
+ OTYDOC_UpdateParentTable L,OTYDOC_GetWidth(WND)
+ VOID RepaintWindow(WND)
+END
 '==================
 VAR OTYDOCCOLOR_CTL
 VAR OTYDOC_MENU_NEW=1
 VAR OTYDOC_MENU_OPEN=2
 VAR OTYDOC_MENU_SAVE=3
 VAR OTYDOC_MENU_SAVEAS=4
+VAR OTYDOC_MENU_ADDTABLE
+VAR OTYDOC_MENU_ADDTABLECOL
+VAR OTYDOC_MENU_ADDTABLECOL2
+VAR OTYDOC_MENU_ADDTABLEROW
+VAR OTYDOC_MENU_ADDTABLEROW2
 COMMON DEF OTYDOC_WNDSTRNOTIF WND,CTL,TYPE,A1,A2$
  IF A1==OTYDOC_MENU_SAVEAS THEN
   VOID RTESave(GetWindowVar(WND,0),A2$)
@@ -8910,6 +9574,16 @@
    VOID SaveFileDialog(WND,"TXT:.DOC",F)
   ELSEIF F==OTYDOC_MENU_OPEN THEN
    VOID OpenFileDialog(WND,"TXT:.DOC",F)
+  ELSEIF F==OTYDOC_MENU_ADDTABLE THEN
+   RTEAddTable GetWindowVar(WND,0),2,2
+  ELSEIF F==OTYDOC_MENU_ADDTABLEROW THEN
+   RTEAddTableRow GetWindowVar(WND,0),FALSE
+  ELSEIF F==OTYDOC_MENU_ADDTABLEROW2 THEN
+   RTEAddTableRow GetWindowVar(WND,0),TRUE
+  ELSEIF F==OTYDOC_MENU_ADDTABLECOL THEN
+   RTEAddTableColumn GetWindowVar(WND,0),FALSE
+  ELSEIF F==OTYDOC_MENU_ADDTABLECOL2 THEN
+   RTEAddTableColumn GetWindowVar(WND,0),TRUE
   ENDIF
   RETURN
  ENDIF
@@ -9126,11 +9800,24 @@
  OTYDOC_MENU_OPEN=2
  OTYDOC_MENU_SAVE=3
  OTYDOC_MENU_SAVEAS=4
+ OTYDOC_MENU_AddTable=5
+ OTYDOC_MENU_AddTableRow=6
+ OTYDOC_MENU_AddTableRow2=7
+ OTYDOC_MENU_AddTableCol=8
+ OTYDOC_MENU_AddTableCol2=9
  AddMenuItem MENU,"New",1
  AddMenuItem MENU,"Open",2
  AddMenuItem MENU,"Save",3
  AddMenuItem MENU,"Save as",4
- AddSubMenuItem GetWindowMenu(WND),"File",MENU SetProcessVar WND
+ AddSubMenuItem GetWindowMenu(WND),"File",MENU
+ NewMenu OUT MENU,E
+ AddMenuItem MENU,"Insert",OTYDOC_MENU_AddTable
+ AddMenuItem MENU,"Insert Left",OTYDOC_MENU_AddTableCol
+ AddMenuItem MENU,"Insert Right",OTYDOC_MENU_AddTableCol2
+ AddMenuItem MENU,"Insert Above",OTYDOC_MENU_AddTableRow
+ AddMenuItem MENU,"Insert Below",OTYDOC_MENU_AddTableRow2
+ AddSubMenuItem GetWindowMenu(WND),"Table",MENU
+ SetProcessVar WND
  VAR DOC,COL
  NewWindow OTYDOCCTL,"OTYDOC",0,12+12,256+8,116-12,WND,0 OUT DOC,E
  SetWindowVar WND,0,DOC
@@ -11863,6 +12550,7 @@
  VAR WND
  GetConsoleVar CON OUT WND,ERR
  IF ERR THEN RETURN
+ IF!LEN(BUF$)THEN RETURN
  VAR X,Y,W,H
  SplitInt GetWindowVar(WND,3) OUT X,Y
  SplitInt GetWindowVar(WND,2) OUT W,H
@@ -12086,6 +12774,7 @@
  VAR ICONSX=(IW-16) DIV 2
  VAR ITW=IW DIV 8
  VAR CUR=GetWindowVar(WND,ODE_WV_CURRENT)
+ VAR SC=GetSelectionColor()
  
  FOR I=0TO L
   VAR D$=DIR$[I]
@@ -12093,7 +12782,7 @@
   VAR NAME$=MID$(D$,1,LEN(D$))
   VAR TC=&HFF000000
   IF I==CUR THEN
-   GFILL IX,IY+16,IX+IW-1,IY+IH-1,GetSelectionColor()
+   GFILL IX,IY+16,IX+IW-1,IY+IH-1,SC
    TC=GetSelectionTextColor()
   ENDIF
   GLOADImage IX+ICONSX,IY,ICON[I],FALSE
@@ -12104,6 +12793,10 @@
     GPUTCHR IX+(IW-MIN(ITW,LEN(NAME$)-ITW-ITW)*8)DIV 2,IY+32,MID$(NAME$,ITW+ITW,ITW),TC
    ENDIF
   ENDIF
+  IF I==CUR THEN
+   GPUTCHR IX+ICONSX,IY,"",SC
+   GPUTCHR IX+ICONSX,IY+8,"",SC
+  ENDIF
   IY=IY+IH
   IF IY+IH>=SH THEN IY=ODE_IY:IX=IX+ODE_IW
  NEXT
@@ -12233,7 +12926,8 @@
  ENDIF
 END
 COMMON DEF OTWBENCHPAINTER WND,C,T,XY,WH
- VAR E=CallBaseControlHandler(WND,C,T,XY,WH)
+ VAR W=GetWindowWidth(WND)
+ VAR H=GetWindowHeight(WND)
  IF GetWindowVar(WND,2)THEN
   VAR M=GetWindowVar(WND,0)
   IF!M THEN
@@ -12246,7 +12940,12 @@
    SetWindowVar WND,2,FALSE
   ENDIF
   SetWindowVar WND,1,GetWindowVar(WND,1)+1
+  IF GBeginWindow(WND)THEN RETURN
+   GFILLWindow WND,RND(W+1),RND(H+1),RND(W+1),RND(H+1),RGB(RND(32)*8,RND(32)*8,RND(32)*8)
+  IF GEndWindow(WND)THEN RETURN
+  RETURN
  ENDIF
+ VAR E=CallBaseControlHandler(WND,C,T,XY,WH)
  IF GBeginWindow(WND)THEN RETURN
   GPRINTWindow WND,0,0,STR$(GetWindowVar(WND,1)),#BLACK
  IF GEndWindow(WND)THEN RETURN
@@ -12279,7 +12978,7 @@
  VAR E=CallBaseControlHandler(WND,CTL,TYP,XY,WH_)
  OTWCLOCKDRAW WND
 END
-COMMON DEF OTWCLOCKDRAW WND
+DEF OTWCLOCKDRAW WND
  VAR H,M,S
  TMREAD OUT H,M,S
  SetWindowVar WND,0,S
