OPTION STRICT
OPTION DEFINT
'=======================
' OTYA 3D WINDOW SYSTEM 
'=======================
'グローバルへんすうのていぎ
VAR OTW_INIT,OTW_MOUSESP
VAR OTW_MOUSEX
VAR OTW_MOUSEY
VAR OTW_MOUSEX#,OTW_MOUSEY#
'=======================
'        WINDOW         
'=======================
VAR WIN_MAX,WIN_MSGMAX
DIM WIN_NAME$  [0]
DIM WIN_WID    [0]
DIM WIN_X      [0]
DIM WIN_Y      [0]
DIM WIN_SX     [0]
DIM WIN_SY     [0]
DIM WIN_EWIDTH [0]
DIM WIN_EHEIGHT[0]
DIM WIN_WIDTH  [0]
DIM WIN_HEIGHT [0]
DIM WIN_AX     [0]
DIM WIN_AY     [0]
DIM WIN_CID    [0]
DIM WIN_NUCID  [0]
DIM WIN_PID    [0]
DIM WIN_NUPID  [0]
DIM WIN_DATA#  [0]
DIM WIN_DATA%  [0]
DIM WIN_DATA$  [0]
DIM WIN_NEXT   [0]
DIM WIN_PREV   [0]
DIM WIN_CHILD  [0]
DIM WIN_PARENT [0]
DIM WIN_MSGBUF [0,0]
VAR WIN_FREE
VAR WIN_WIDCNT
DEF OTW_WIN_INITARRAY
 WIN_MAX=256
 WIN_MSGMAX=256
 WIN_NAME$     =NEW_ARRAY$(WIN_MAX)
 WIN_WID       =NEW_ARRAY(WIN_MAX)
 WIN_X         =NEW_ARRAY(WIN_MAX)
 WIN_Y         =NEW_ARRAY(WIN_MAX)
 WIN_SX        =NEW_ARRAY(WIN_MAX)
 WIN_SY        =NEW_ARRAY(WIN_MAX)
 WIN_EWIDTH    =NEW_ARRAY(WIN_MAX)
 WIN_EHEIGHT   =NEW_ARRAY(WIN_MAX)
 WIN_WIDTH     =NEW_ARRAY(WIN_MAX)
 WIN_HEIGHT    =NEW_ARRAY(WIN_MAX)
 WIN_AX        =NEW_ARRAY(WIN_MAX)
 WIN_AY        =NEW_ARRAY(WIN_MAX)
 WIN_CID       =NEW_ARRAY(WIN_MAX)
 WIN_NUCID     =NEW_ARRAY(WIN_MAX)
 WIN_PID       =NEW_ARRAY(WIN_MAX)
 WIN_NUPID     =NEW_ARRAY(WIN_MAX)
 WIN_DATA#     =NEW_ARRAY#(WIN_MAX)
 WIN_DATA%     =NEW_ARRAY%(WIN_MAX)
 WIN_DATA$     =NEW_ARRAY$(WIN_MAX)
 WIN_NEXT      =NEW_ARRAY(WIN_MAX)
 WIN_PREV      =NEW_ARRAY(WIN_MAX)
 WIN_CHILD     =NEW_ARRAY(WIN_MAX)
 WIN_PARENT    =NEW_ARRAY(WIN_MAX)
 WIN_MSGBUF    =NEW_ARRAY2(WIN_MAX,WIN_MSGMAX)
 WIN_FREE=1
 OTW_INITLIST WIN_NEXT
END
'=======================
'CONTROL
'=======================
VAR CTL_MAX
VAR CTL_HANDLER_MAX
DIM CTL_NAME$   [0]
DIM CTL_CID     [0]
DIM CTL_REF     [0]
DIM CTL_NEXT    [0]
DIM CTL_HANDLER$[0]
VAR CTL_FREE
VAR CTL_CIDCNT
VAR CTL_PAINTHANDLER
VAR CTL_WINDOWCID
VAR CTL_WINDOWNUCID
DEF OTW_CTL_INITARRAY
 CTL_MAX=64
 CTL_HANDLER_MAX=16
 CTL_NAME$     =NEW_ARRAY$(CTL_MAX)
 CTL_CID       =NEW_ARRAY(CTL_MAX)
 CTL_NEXT      =NEW_ARRAY(CTL_MAX)
 CTL_HANDLER$  =NEW_ARRAY2(CTL_MAX,CTL_HANDLER_MAX)
 CTL_FREE=1
 OTW_INITLIST CTL_NEXT
 VAR E
 NewControl "WINDOW" OUT CTL_WINDOWCID,CTL_WINDOWNUCID,E
 CTL_PAINTHANDLER=0
 E=SetControlPainter(CTL_WINDOWCID,CTL_WINDOWNUCID,"WindowPainter")
END
DEF OTW_INITLIST ARY[]
 VAR I
 FOR I=1TO LEN(ARY)-1
  ARY[I]=I+1
 NEXT
END
VAR WIN_NOALLOC
VAR WIN_INVALIDID
VAR CTL_NOALLOC
VAR CTL_INVALIDID
DEF OTW_INIT_ERR
 WIN_NOALLOC=1
 WIN_INVALIDID=2
 CTL_NOALLOC=201
 CTL_INVALIDID=202
END
COMMON DEF GetWindowControl OUT CID,NUCID
 CID=CTL_WINDOWCID
 NUCID=CTL_WINDOWNUCID
END
COMMON DEF GetWindowControlCID()
 RETURN CTL_WINDOWCID
END
COMMON DEF GetWindowControlNUCID()
 RETURN CTL_WINDOWNUCID
END
'CONTROL
COMMON DEF NewControl NAME$ OUT CID,NUCID,ERR
 IF!CTL_FREE THEN
  ERR=CTL_NOALLOC
  CID=-1:NUCID=0
  RETURN
 ENDIF
 INC CTL_CIDCNT
 ERR=0
 NUCID=CTL_FREE
 CID=CTL_CIDCNT
 CTL_NEXT[NUCID]=0
 CTL_FREE=CTL_NEXT[CTL_FREE]
END
COMMON DEF CheckControl(CID,NUCID)
 RETURN CTL_CID[NUCID]==CID
END
COMMON DEF DeleteControl(CID,NUCID)
 IF!CheckControl(CID,NUCID) THEN RETURN CTL_INVALIDID
 CTL_NEXT[NUCID]=CTL_FREE
 CTL_FREE=NUCID
 CTL_CID[NUCID]=0
 CTL_NAME$[NUCID]=""
 VAR I
 FOR I=0TO CTL_HANDLER_MAX-1
  CTL_HANDLER$[I]=""
 NEXT
END
COMMON DEF SetControlPainter(CID,NUCID,HANDLER$)
 IF!CheckControl(CID,NUCID)THEN RETURN CTL_INVALIDID
 CTL_HANDLER$[NUCID,CTL_PAINTHANDLER]=HANDLER$
 RETURN 0
END
'WINDOW
VAR WIN_ROOTWID
VAR WIN_ROOTNUWID
COMMON DEF GetRootWID()
 RETURN WIN_ROOTWID
END
COMMON DEF GetRootNUWID()
 RETURN WIN_ROOTNUWID
END

COMMON DEF NewRootWindow CID,NUCID,NAME$,WIDTH,HEIGHT OUT WID,NUWID,ERR
 IF!CheckControl(CID,NUCID)THEN
  WID=0
  NUWID=0
  ERR=CTL_INVALIDID
  RETURN
 ENDIF
 IF!WIN_FREE THEN
  WID=0
  NUWID=0
  ERR=WIN_NOALLOC
  RETURN
 ENDIF
 ERR=0
 INC WIN_WIDCNT
 NUWID=WIN_FREE
 WIN_FREE=WIN_NEXT[WIN_FREE]
 WID=WIN_WIDCNT
 WIN_WID[NUWID]=WID
 WIN_CID[NUWID]=CID
 WIN_NUCID[NUWID]=NUCID
 '
 WIN_X[NUWID]=0
 WIN_Y[NUWID]=0
 '
 WIN_WIDTH[NUWID]=WIDTH
 WIN_HEIGHT[NUWID]=WIDTH
 IF!WIN_ROOTNUWID THEN RETURN
 VAR C=WIN_CHILD[WIN_ROOTNUWID]
 WIN_CHILD[WIN_ROOTNUWID]=NUWID
 WIN_NEXT[NUWID]=C
 WIN_PREV[C]=NUWID
END

DEF WindowPainter WID,NUWID
END
VAR WIN_ROOTCID
VAR WIN_ROOTNUCID
COMMON DEF I_OTW
 IF!OTW_INIT THEN
  PrintConsole "====================="+LF$()
  PrintConsole "OTYA 3D WINDOW SYSTEM"+LF$()
  PrintConsole "====================="+LF$()
  OTW_INIT=TRUE
  OTW_WIN_INITARRAY
  OTW_CTL_INITARRAY
  OTW_INIT_ERR
  
  VAR E
  NewControl "DESKTOP" OUT WIN_ROOTCID,WIN_ROOTNUCID,E
  E=SetControlPainter(WIN_ROOTCID,WIN_ROOTNUCID,"DesktopPainter")
  ACLS
  XSCREEN 2
  GCLS RGB(0,0,255)
 ' VISIBLE 0,1,1,1
  OTW_MOUSEX=(400-16)/2
  OTW_MOUSEY=(240-16)/2
  OTW_MOUSEX#=(400-16)/2
  OTW_MOUSEY#=(240-16)/2
 '290
  SPSET OTW_MOUSESP,290
  SPOFS OTW_MOUSESP,OTW_MOUSEX,OTW_MOUSEY
 ENDIF
RETURN
END
COMMON DEF L_OTW
' ?OTW_INIT
UpdateMouse
' ExitProcess 1
RETURN
END
VAR OTW_MOUSEOLDX,OTW_MOUSEOLDY,OTW_MOUSEOLDST
COMMON DEF UpdateMouse
 VAR S,X,Y
 TOUCH OUT S,X,Y
 IF OTW_MOUSEOLDST AND S THEN
  OTW_MOUSEX=OTW_MOUSEX+X-OTW_MOUSEOLDX
  OTW_MOUSEY=OTW_MOUSEY+Y-OTW_MOUSEOLDY
  SPOFS OTW_MOUSESP,OTW_MOUSEX,OTW_MOUSEY
   OTW_MOUSEX#=OTW_MOUSEX
   OTW_MOUSEY#=OTW_MOUSEY
 ENDIF
 OTW_MOUSEOLDX=X
 OTW_MOUSEOLDY=Y
 OTW_MOUSEOLDST=S
 IF!S THEN
  VAR X#,Y#
  STICK OUT X#,Y#
  IF X#!=0 OR Y#!=0 THEN
   OTW_MOUSEX#=OTW_MOUSEX#+X#/2
   OTW_MOUSEY#=OTW_MOUSEY#-Y#/2
   SPOFS OTW_MOUSESP,OTW_MOUSEX#,OTW_MOUSEY#
   OTW_MOUSEX=OTW_MOUSEX#
   OTW_MOUSEY=OTW_MOUSEY#
  ENDIF
 ENDIF
END
DEF OTWSAVE VER$
 SAVE"PRG1:OTW"+VER$
END

