OPTION STRICT
OPTION DEFINT
'=======================
' OTYA 3D WINDOW SYSTEM 
'=======================
'グローバルへんすうのていぎ
VAR OTW_INIT,OTW_MOUSESP
VAR OTW_MOUSEX
VAR OTW_MOUSEY
VAR OTW_MOUSEX#,OTW_MOUSEY#
'=======================
'        WINDOW         
'=======================
VAR WIN_MAX,WIN_MSGMAX
DIM WIN_NAME$  [0]
DIM WIN_WID    [0]
DIM WIN_X      [0]
DIM WIN_Y      [0]
DIM WIN_SX     [0]
DIM WIN_SY     [0]
DIM WIN_EWIDTH [0]
DIM WIN_EHEIGHT[0]
DIM WIN_WIDTH  [0]
DIM WIN_HEIGHT [0]
DIM WIN_AX     [0]
DIM WIN_AY     [0]
DIM WIN_CTL    [0]
DIM WIN_PID    [0]
DIM WIN_NUPID  [0]
DIM WIN_DATA#  [0]
DIM WIN_DATA%  [0]
DIM WIN_DATA$  [0]
DIM WIN_NEXT   [0]
DIM WIN_PREV   [0]
DIM WIN_CHILD  [0]
DIM WIN_PARENT [0]
'QUEUE
DIM WIN_MSGS   [0]
DIM WIN_MSGE   [0]
DIM WIN_MSGBUF [0,0,0]
VAR WIN_FREE
VAR WIN_WIDCNT
VAR WIN_MSGARGSIZE
VAR WIDSHIFT
VAR NUWIDMASK
DEF OTW_WIN_INITARRAY
 WIN_MAX=256
 WIN_MSGMAX=64
 WIN_MSGARGSIZE=3
 WIDSHIFT=12
 NUWIDMASK=4095
 WIN_NAME$     =NewArray$(WIN_MAX)
 WIN_WID       =NewArray(WIN_MAX)
 WIN_X         =NewArray(WIN_MAX)
 WIN_Y         =NewArray(WIN_MAX)
 WIN_SX        =NewArray(WIN_MAX)
 WIN_SY        =NewArray(WIN_MAX)
 WIN_EWIDTH    =NewArray(WIN_MAX)
 WIN_EHEIGHT   =NewArray(WIN_MAX)
 WIN_WIDTH     =NewArray(WIN_MAX)
 WIN_HEIGHT    =NewArray(WIN_MAX)
 WIN_AX        =NewArray(WIN_MAX)
 WIN_AY        =NewArray(WIN_MAX)
 WIN_CTL       =NewArray(WIN_MAX)
 WIN_PID       =NewArray(WIN_MAX)
 WIN_NUPID     =NewArray(WIN_MAX)
 WIN_DATA#     =NewArray#(WIN_MAX)
 WIN_DATA%     =NewArray%(WIN_MAX)
 WIN_DATA$     =NewArray$(WIN_MAX)
 WIN_NEXT      =NewArray(WIN_MAX)
 WIN_PREV      =NewArray(WIN_MAX)
 WIN_CHILD     =NewArray(WIN_MAX)
 WIN_PARENT    =NewArray(WIN_MAX)
 WIN_MSGS      =NewArray(WIN_MAX)
 WIN_MSGE      =NewArray(WIN_MAX)
 WIN_MSGBUF    =NewArray3(WIN_MAX,WIN_MSGMAX,WIN_MSGARGSIZE)
 WIN_FREE=1
 OTW_INITLIST WIN_NEXT
END
'=======================
'CONTROL
'=======================
VAR CTL_MAX
VAR CTL_HANDLER_MAX
DIM CTL_NAME$   [0]
DIM CTL_CID     [0]
DIM CTL_REF     [0]
DIM CTL_NEXT    [0]
DIM CTL_HANDLER$[0,0]
VAR CTL_FREE
VAR CTL_CIDCNT
VAR CTL_PAINTHANDLER
VAR CTL_WINDOWCTL
DEF OTW_CTL_INITARRAY
 CTL_MAX=64
 CTL_HANDLER_MAX=16
 CTL_NAME$     =NewArray$(CTL_MAX)
 CTL_CID       =NewArray(CTL_MAX)
 CTL_NEXT      =NewArray(CTL_MAX)
 CTL_HANDLER$  =NewArray2$(CTL_MAX,CTL_HANDLER_MAX)
 CTL_FREE=1
 OTW_INITLIST CTL_NEXT
 VAR E
 NewControl "WINDOW" OUT CTL_WINDOWCTL,E
 CTL_PAINTHANDLER=0
 E=SetControlPainter(CTL_WINDOWCTL,"WindowPainter")
END
DEF OTW_INITLIST ARY[]
 VAR I
 FOR I=1TO LEN(ARY)-1
  ARY[I]=I+1
 NEXT
END
VAR WIN_NOALLOC
VAR WIN_INVALIDID
VAR WIN_EVENTERR
VAR CTL_NOALLOC
VAR CTL_INVALIDID
DEF OTW_INIT_ERR
 WIN_NOALLOC=1
 WIN_INVALIDID=2
 WIN_EVENTERR=3
 CTL_NOALLOC=201
 CTL_INVALIDID=202
END
COMMON DEF GetWindowControl()
 RETURN CTL_WINDOWCTL
END
'CONTROL
COMMON DEF NewControl NAME$ OUT CTL,ERR
 IF!CTL_FREE THEN
  ERR=CTL_NOALLOC
  CTL=0
  RETURN
 ENDIF
 INC CTL_CIDCNT
 ERR=0
 CTL=CIDNUCIDToCTL(CTL_FREE,CTL_CIDCNT)
 CTL_NEXT[CTL AND 4095]=0
 CTL_FREE=CTL_NEXT[CTL_FREE]
END
COMMON DEF CheckControl(CTL)
 RETURN CTL_CID[CTL AND 4095]==CTL>>12
END
COMMON DEF DeleteControl(CTL)
 IF!CheckControl(CTL) THEN RETURN CTL_INVALIDID
 VAR NUCID=CTL AND 4095,CID=CTL>>12
 CTL_NEXT[NUCID]=CTL_FREE
 CTL_FREE=NUCID
 CTL_CID[NUCID]=0
 CTL_NAME$[NUCID]=""
 VAR I
 FOR I=0TO CTL_HANDLER_MAX-1
  CTL_HANDLER$[I]=""
 NEXT
END
COMMON DEF SetControlPainter(CTL,HANDLER$)
 IF!CheckControl(CTL)THEN RETURN CTL_INVALIDID
 CTL_HANDLER$[CTL AND 4095,CTL_PAINTHANDLER]=HANDLER$
 RETURN 0
END
DEF CIDNUCIDToCTL(CID,NUCID)
 RETURN CID<<12OR NUCID
END
'WINDOW
DEF WIDNUWIDToWND(WID,NUWID)
 RETURN WID<<12OR NUWID
END
VAR WIN_ROOTWND
COMMON DEF GetRootWND()
 RETURN WIN_ROOTWND
END
COMMON DEF CheckWindow(WND)
 RETURN WIN_WID[WND AND NUWIDMASK]==WND>>WIDSHIFT
END
COMMON DEF NewRootWindow CTL,NAME$,WIDTH,HEIGHT OUT WND,ERR
 IF!CheckControl(CTL)THEN
  WND=0
  ERR=CTL_INVALIDID
  RETURN
 ENDIF
 IF!WIN_FREE THEN
  WND=0
  ERR=WIN_NOALLOC
  RETURN
 ENDIF
 ERR=0
 INC WIN_WIDCNT
 VAR NUWID,WID
 NUWID=WIN_FREE
 WIN_FREE=WIN_NEXT[WIN_FREE]
 WID=WIN_WIDCNT
 WND=WIDNUWIDToWND(WID,NUWID)
 WIN_WID[NUWID]=WID
 WIN_CTL[NUWID]=CTL
 '
 WIN_X[NUWID]=0
 WIN_Y[NUWID]=0
 '
 WIN_WIDTH[NUWID]=WIDTH
 WIN_HEIGHT[NUWID]=WIDTH
 VOID RepaintWindow(WND)
 IF!WIN_ROOTWND THEN RETURN
 VAR C=WIN_CHILD[WIN_ROOTWND AND NUWIDMASK]
 WIN_CHILD[WIN_ROOTWND AND NUWIDMASK]=NUWID
 WIN_NEXT[NUWID]=C
 WIN_PREV[C]=NUWID
END
COMMON DEF SendWindowEvent(WND,TYPE,A1,A2)
 IF!CheckWindow(WND)THEN RETURN WIN_INVALIDID
 VAR NUWID=WND AND NUWIDMASK
 IF(WIN_MSGS[NUWID]+1)MOD WIN_MSGMAX==WIN_MSGE[NUWID] THEN RETURN WIN_EVENTERR
 WIN_MSGBUF[NUWID,WIN_MSGS[NUWID],0]=TYPE
 WIN_MSGBUF[NUWID,WIN_MSGS[NUWID],1]=A1
 WIN_MSGBUF[NUWID,WIN_MSGS[NUWID],2]=A2
 INC WIN_MSGS[NUWID]
 IF WIN_MSGS[NUWID]>=WIN_MSGMAX THEN WIN_MSGS[NUWID]=0
 RETURN 0
END
COMMON DEF RepaintWindow(WND)
 RETURN SendWindowEvent(WND,CTL_PAINTHANDLER,0,0)
END
COMMON DEF UpdateWindow(WND)
 IF!CheckWindow(WND)THEN RETURN WIN_INVALIDID
 VAR NUWID=WND AND NUWIDMASK
 IF WIN_MSGS[NUWID]==WIN_MSGE[NUWID]THEN RETURN 0
 ?"A"
 INC WIN_MSGE[NUWID]
 IF WIN_MSGE[NUWID]>=WIN_MSGMAX THEN WIN_MSGE[NUWID]=0
 RETURN 0
END
''WINDOW GRAPHIC:
COMMON DEF WindowGBegin(WND)
 RETURN 0
END
COMMON DEF WindowGPUT WND,X,Y,COL
END
COMMON DEF WindowGFILL WND,X,Y,X2,Y2,COL
END
DEF WindowPainter WND
END
VAR WIN_ROOTCTL
COMMON DEF I_OTW
 IF!OTW_INIT THEN
  PrintConsole "====================="+LF$()
  PrintConsole "OTYA 3D WINDOW SYSTEM"+LF$()
  PrintConsole "====================="+LF$()
  OTW_INIT=TRUE
  OTW_WIN_INITARRAY
  OTW_CTL_INITARRAY
  OTW_INIT_ERR
  
  VAR E
  NewControl "DESKTOP" OUT WIN_ROOTCTL,E
  E=SetControlPainter(WIN_ROOTCTL,"DesktopPainter")
  NewRootWindow WIN_ROOTCTL,"",400,240 OUT WIN_ROOTWND,E
  ACLS
  XSCREEN 2
  GCLS RGB(0,0,255)
 ' VISIBLE 0,1,1,1
  OTW_MOUSEX=(400-16)/2
  OTW_MOUSEY=(240-16)/2
  OTW_MOUSEX#=(400-16)/2
  OTW_MOUSEY#=(240-16)/2
 '290
  SPSET OTW_MOUSESP,290
  SPOFS OTW_MOUSESP,OTW_MOUSEX,OTW_MOUSEY
 ENDIF
RETURN
END
COMMON DEF L_OTW
' ?OTW_INIT
 UpdateMouse
 VOID UpdateWindow(WIN_ROOTWND)
' ExitProcess 1
RETURN
END
VAR OTW_MOUSEOLDX,OTW_MOUSEOLDY,OTW_MOUSEOLDST
COMMON DEF UpdateMouse
 VAR S,X,Y
 TOUCH OUT S,X,Y
 IF OTW_MOUSEOLDST AND S THEN
  OTW_MOUSEX=OTW_MOUSEX+X-OTW_MOUSEOLDX
  OTW_MOUSEY=OTW_MOUSEY+Y-OTW_MOUSEOLDY
  SPOFS OTW_MOUSESP,OTW_MOUSEX,OTW_MOUSEY
   OTW_MOUSEX#=OTW_MOUSEX
   OTW_MOUSEY#=OTW_MOUSEY
 ENDIF
 OTW_MOUSEOLDX=X
 OTW_MOUSEOLDY=Y
 OTW_MOUSEOLDST=S
 IF!S THEN
  VAR X#,Y#
  STICK OUT X#,Y#
  IF X#!=0 OR Y#!=0 THEN
   OTW_MOUSEX#=OTW_MOUSEX#+X#/2
   OTW_MOUSEY#=OTW_MOUSEY#-Y#/2
   SPOFS OTW_MOUSESP,OTW_MOUSEX#,OTW_MOUSEY#
   OTW_MOUSEX=OTW_MOUSEX#
   OTW_MOUSEY=OTW_MOUSEY#
  ENDIF
 ENDIF
END
COMMON DEF OTWSAVE VER$
 SAVE"PRG1:OTW"+VER$
END

DEF OTW_FONT
DATA "A"
DATA "00000000"
DATA "00000000"
DATA "00000000"
DATA "00000000"
DATA "00000000"
DATA "00000000"
DATA "00000000"
DATA "00000000"
END
